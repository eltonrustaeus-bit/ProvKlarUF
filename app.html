<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ProviaAi – App</title>

  <style>
    :root{
      --deep:#052A1E; --deep2:#041E16;
      --mint:#2BE38C; --mint2:#16B876;
      --bg:#F6FBF8; --muted:#556072; --border:rgba(5,42,30,.14);
      --shadow:0 18px 55px rgba(5,42,30,.14);
      --radius:18px; --font:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      --danger:#8b1d1d; --ok:#0f7a5a; --warn:#946200;
      --max:1080px;
    }
    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    :target{scroll-margin-top:92px}
    body{
      margin:0;font-family:var(--font);
      background:
        radial-gradient(900px 450px at 20% -10%, rgba(43,227,140,.18), transparent 60%),
        radial-gradient(700px 380px at 95% 20%, rgba(43,227,140,.10), transparent 55%),
        var(--bg);
      color:#071812;
    }
    a{text-decoration:none;color:inherit}

    /* JS-alive badge */
    #jsAlive{
      position:fixed;top:10px;right:10px;z-index:100000;
      padding:8px 10px;border-radius:12px;
      font-weight:1000;font-size:12px;
      border:1px solid rgba(255,255,255,.35);
      background:rgba(5,42,30,.92);color:#fff;
      box-shadow:0 12px 30px rgba(0,0,0,.22);
      display:none;
    }

    header{
      background:rgba(255,255,255,.88);backdrop-filter:saturate(140%) blur(10px);
      border-bottom:1px solid var(--border);
      position:sticky;top:0;z-index:3000;
    }
    .wrap{max-width:var(--max);margin:0 auto;padding:clamp(14px,3vw,22px)}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:12px;min-width:0}
    .brand img{height:54px;width:auto;display:block}
    .brand .name{font-weight:1100;color:var(--deep);font-size:18px;line-height:1.05}
    .brand .tag{margin-top:3px;color:var(--muted);font-weight:850;font-size:12px;line-height:1.1}

    .btn{
      display:inline-flex;align-items:center;justify-content:center;
      padding:12px 16px;border-radius:14px;
      font-weight:1000;font-size:14px;border:1px solid var(--border);
      cursor:pointer;white-space:nowrap;
      background:rgba(255,255,255,.92);color:var(--deep);
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .btnPrimary{
      background:var(--mint2);color:#fff;border-color:rgba(22,184,118,.28);
      box-shadow:0 14px 28px rgba(22,184,118,.22)
    }

    .card{
      background:rgba(255,255,255,.92);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:clamp(16px,3vw,22px);
      margin:14px 0;
      overflow:hidden;
      position:relative;
    }
    .card:before{
      content:"";
      position:absolute;inset:-70px -70px auto auto;
      width:190px;height:190px;border-radius:999px;
      background:radial-gradient(circle at 30% 30%, rgba(43,227,140,.16), transparent 60%);
      pointer-events:none;
    }
    .sectionTitle{margin:0 0 6px;font-weight:1100;letter-spacing:-.01em;color:var(--deep);font-size:16px}
    .sectionSub{margin:0;color:var(--muted);font-weight:780;font-size:12px;line-height:1.35}

    label{display:block;margin:12px 0 6px;font-weight:1000;color:var(--deep);font-size:13px}
    select,input,textarea{
      width:100%;padding:12px;border-radius:14px;border:1px solid var(--border);background:#fff;
      font-family:inherit;font-size:14px;outline:none;
    }
    textarea{min-height:170px;resize:vertical}
    input:focus, textarea:focus, select:focus{border-color:rgba(43,227,140,.55);box-shadow:0 0 0 5px rgba(43,227,140,.14)}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:920px){ .grid2{grid-template-columns:1fr} }

    .status{margin-top:10px;color:var(--muted);font-weight:850;font-size:12px;line-height:1.35;word-break:break-word}
    .status.ok{color:var(--ok)} .status.bad{color:var(--danger)} .status.warn{color:var(--warn)}

    pre{
      margin:10px 0 0;padding:12px;border-radius:14px;border:1px solid var(--border);
      background:#fff;overflow:auto;font-size:12px;line-height:1.35;white-space:pre-wrap;word-break:break-word;
    }

    .spinner{width:16px;height:16px;border-radius:999px;border:2px solid rgba(5,42,30,.18);border-top-color:rgba(22,184,118,.95);animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .qBox{margin-top:12px;padding:12px;border:1px solid rgba(5,42,30,.12);border-radius:16px;background:#fff}
    .qMeta{color:var(--muted);font-weight:900;font-size:12px;margin-bottom:6px}
    .qText{font-weight:900;color:#071812;line-height:1.45}

    /* LOCK */
    .loginOverlay{
      position:fixed;inset:0;z-index:9999;
      background:
        radial-gradient(800px 420px at 20% 10%, rgba(43,227,140,.22), transparent 60%),
        radial-gradient(700px 380px at 90% 20%, rgba(43,227,140,.10), transparent 55%),
        linear-gradient(135deg, rgba(5,42,30,.98), rgba(4,30,22,.92));
      display:flex;align-items:center;justify-content:center;padding:18px;
    }
    .loginCard{
      width:min(680px, 100%);
      background:rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.22);
      border-radius:22px;
      box-shadow:0 24px 70px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .loginTop{display:flex;gap:14px;align-items:center;padding:18px 18px 10px}
    .loginTop img{height:68px;width:auto;display:block}
    .loginTop .ltTitle{font-weight:1100;color:var(--deep);font-size:20px;line-height:1.1}
    .loginTop .ltSub{margin-top:4px;color:var(--muted);font-weight:800;font-size:12px}
    .loginBody{padding:12px 18px 18px}
    .loginRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .err{margin-top:10px;color:var(--danger);font-weight:900;font-size:12px;line-height:1.35}
    .hint{margin-top:8px;color:var(--muted);font-weight:800;font-size:12px;line-height:1.35}
    .miniSplit{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:640px){ .miniSplit{grid-template-columns:1fr} }

    /* MC clickable */
    .mcGroup{display:grid;gap:8px;margin-top:10px}
    .mcOpt{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(5,42,30,.14);
      background:#fff; cursor:pointer;
      font-weight:900; line-height:1.35;
      text-align:left;
    }
    .mcOpt:hover{border-color:rgba(43,227,140,.35)}
    .mcOpt.sel{
      border-color:rgba(43,227,140,.60);
      box-shadow:0 0 0 5px rgba(43,227,140,.12);
    }
    .mcLetter{
      width:28px;height:28px;border-radius:10px;
      display:grid;place-items:center;
      background:rgba(5,42,30,.06);
      font-weight:1100;color:var(--deep);
      flex:0 0 28px;
    }
    .mcText{font-weight:850;color:#071812}

    footer{border-top:1px solid var(--border);padding:18px;text-align:center;color:var(--muted);font-size:12px;font-weight:750}
  </style>
</head>

<body>
  <div id="jsAlive">JS: AKTIV</div>

  <!-- LOCK SCREEN -->
  <div id="loginScreen" class="loginOverlay">
    <div class="loginCard">
      <div class="loginTop">
        <img src="image/proviaai-logo.png" alt="ProviaAi logga">
        <div>
          <div class="ltTitle">ProviaAi</div>
          <div class="ltSub" id="lockSub">Åtkomst krävs för att använda appen</div>
        </div>
      </div>

      <div class="loginBody">
        <!-- SUPABASE AUTH -->
        <div id="authBox">
          <div class="miniSplit">
            <div>
              <label for="authEmail">E-post</label>
              <input id="authEmail" type="email" placeholder="du@skola.se" autocomplete="email" />
            </div>
            <div>
              <label for="authPass">Lösenord</label>
              <input id="authPass" type="password" placeholder="Minst 8 tecken" autocomplete="current-password" />
            </div>
          </div>

          <div class="loginRow">
            <button class="btn btnPrimary" type="button" id="signInBtn" onclick="window.__signInEmail()">Logga in</button>
            <button class="btn" type="button" id="signUpBtn" onclick="window.__signUpEmail()">Skapa konto</button>
            <a class="btn" href="index.html">Till infosidan</a>
            <a class="btn" href="förbättring.html">Förbättring</a>
          </div>

          <div class="hint" id="authHint">
            Om knapparna inte gör något och “JS: AKTIV” inte syns: JavaScript körs inte på sidan.
          </div>
        </div>

        <!-- ACCESS CODE -->
        <details style="margin-top:14px" id="fallbackAccess" open>
          <summary style="cursor:pointer;font-weight:1000;color:var(--deep);font-size:13px">Alternativ inloggning: kod</summary>
          <label for="accessCode">Åtkomstkod</label>
          <input id="accessCode" type="password" placeholder="Skriv koden…" autocomplete="off" />
          <div class="loginRow">
            <button class="btn btnPrimary" type="button" id="unlockBtn" onclick="window.__unlockByCode()">Lås upp</button>
          </div>
        </details>

        <div id="errorMsg" class="err"></div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <header>
    <div class="wrap topbar">
      <a class="brand" href="index.html">
        <img src="image/proviaai-logo.png" alt="ProviaAi logga">
        <div>
          <div class="name">ProviaAi</div>
          <div class="tag">Mockprov • Rättning • Modellsvar</div>
        </div>
      </a>

      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <button class="btn" id="logoutBtn" type="button" onclick="window.__logoutAll()">Logga ut</button>
      </div>
    </div>
  </header>

  <main class="wrap" id="appRoot">

    <section class="card" id="material">
      <h3 class="sectionTitle">Steg 1 – Material</h3>
      <p class="sectionSub">Klistra in text.</p>

      <label for="pastedText">Material (klistra in text)</label>
      <textarea id="pastedText" placeholder="Rubriker → punktlista → definitioner/formler → exempel"></textarea>

      <div class="status warn" style="margin-top:12px">
        Tips: rubriker + punktlistor ger mer exakta frågor och bättre rättning.
      </div>
    </section>

    <section class="card" id="settings">
      <h3 class="sectionTitle">Steg 2 – Inställningar</h3>
      <p class="sectionSub">Välj nivå, frågetyp och exakt antal frågor.</p>

      <div class="grid2">
        <div>
          <label for="level">Nivå (E/C/A)</label>
          <select id="level">
            <option value="E">E</option>
            <option value="C" selected>C</option>
            <option value="A">A</option>
          </select>
        </div>
        <div>
          <label for="course">Ämne/kurs (valfritt)</label>
          <input id="course" placeholder="Ex: Matematik 2b / Historia 1b" />
        </div>
      </div>

      <div class="grid2" style="margin-top:12px">
        <div>
          <label for="qType">Frågetyp</label>
          <select id="qType">
            <option value="mix" selected>Blandat</option>
            <option value="mc">Flervalsfrågor</option>
            <option value="short">Kortsvar</option>
            <option value="essay">Essä</option>
          </select>
        </div>
        <div>
          <label for="numQuestions">Antal frågor (exakt)</label>
          <select id="numQuestions">
            <option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option>
            <option>9</option><option>10</option><option>11</option><option selected>12</option>
          </select>
        </div>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;align-items:center">
        <button class="btn btnPrimary" id="generateExamBtn" type="button" onclick="window.__generateExam()">Skapa mockprov</button>
        <button class="btn" id="gradeBtn" type="button" disabled onclick="window.__gradeExam()">Rätta prov</button>
        <button class="btn" id="clearBtn" type="button" onclick="window.__clearAll()">Rensa</button>

        <span style="display:flex;gap:10px;align-items:center">
          <span id="spinWrap" style="display:none"><span class="spinner"></span></span>
          <span class="sectionSub" id="miniState">Redo.</span>
        </span>
      </div>

      <div class="status" id="status"></div>
      <pre id="debug" style="display:none"></pre>
    </section>

    <section class="card" id="exam">
      <h3 class="sectionTitle">Steg 3 – Mockprov</h3>
      <div class="status" id="examMeta">Ingen provdata ännu.</div>
      <div id="examBody"></div>
    </section>

    <section class="card" id="result">
      <h3 class="sectionTitle">Steg 4 – Rättning</h3>
      <div class="status" id="resultMeta">Ingen rättning ännu.</div>
      <div id="resultBody"></div>
    </section>

  </main>

  <footer>ProviaAi är studiestöd och ger ingen officiell betygssättning.</footer>

  <!-- SUPABASE SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // ===== JS alive indicator (verifierar att JS körs) =====
    (function(){
      const badge = document.getElementById("jsAlive");
      if(badge) badge.style.display = "block";
    })();

    // =========================
    // 1) FYLL I DINA SUPABASE-KEYS
    // =========================
    const SUPABASE_URL = "PASTA_DIN_SUPABASE_PROJECT_URL_HÄR";
    const SUPABASE_ANON_KEY = "PASTA_DIN_SUPABASE_ANON_PUBLIC_KEY_HÄR";

    // =========================
    // 2) FALLBACK-KOD
    // =========================
    const ACCESS_CODE = "provia123";
    const ACCESS_FLAG_KEY = "proviaai_app_access";

    const $ = (id) => document.getElementById(id);

    function showError(msg){ const el=$("errorMsg"); if(el) el.textContent = msg || ""; }
    function showDebug(msg){
      const d = $("debug");
      if(!d) return;
      if(!msg){ d.style.display="none"; d.textContent=""; return; }
      d.style.display="block"; d.textContent=String(msg);
    }

    // Om JS-fel händer ska det synas direkt i UI
    window.addEventListener("error", (ev) => {
      showError("JavaScript-fel: " + (ev?.message || "okänt fel"));
    });

    function showLock(){
      $("loginScreen").style.display = "flex";
      document.documentElement.style.overflow = "hidden";
      document.body.style.overflow = "hidden";
    }
    function hideLock(){
      $("loginScreen").style.display = "none";
      document.documentElement.style.overflow = "";
      document.body.style.overflow = "";
    }
    function isUnlockedByCode(){
      return localStorage.getItem(ACCESS_FLAG_KEY) === "true";
    }

    // =========================
    // Supabase init (failsafe)
    // =========================
    const USE_SUPABASE = (typeof SUPABASE_URL === "string" && SUPABASE_URL.startsWith("http"))
                      && (typeof SUPABASE_ANON_KEY === "string" && SUPABASE_ANON_KEY.length > 20);

    let supabase = null;
    if(USE_SUPABASE){
      if(window.supabase && typeof window.supabase.createClient === "function"){
        try{
          supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        }catch(e){
          supabase = null;
          showError("Supabase kunde inte initieras.");
          showDebug(String(e));
        }
      }else{
        supabase = null;
        showError("Supabase-SDK laddades inte. Kod-inloggning fungerar ändå.");
      }
    }

    // =========================
    // Auth actions (exponerade på window för onclick)
    // =========================
    async function signInEmail(){
      showError(""); showDebug("");
      if(!supabase){
        showError("Supabase är inte aktiv. Använd kod-inloggning.");
        return;
      }
      const email = ($("authEmail").value || "").trim();
      const password = $("authPass").value || "";
      if(!email || !password){
        showError("Fyll i e-post och lösenord.");
        return;
      }
      try{
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if(error){ showError(error.message); return; }
        hideLock();
      }catch(e){
        showError("Inloggningsfel.");
        showDebug(String(e));
      }
    }

    async function signUpEmail(){
      showError(""); showDebug("");
      if(!supabase){
        showError("Supabase är inte aktiv. Använd kod-inloggning.");
        return;
      }
      const email = ($("authEmail").value || "").trim();
      const password = $("authPass").value || "";
      if(!email || !password){
        showError("Fyll i e-post och lösenord.");
        return;
      }
      try{
        const { error } = await supabase.auth.signUp({ email, password });
        if(error){ showError(error.message); return; }
        showError("Konto skapat. Kolla mail om bekräftelse krävs och logga in.");
      }catch(e){
        showError("Kunde inte skapa konto.");
        showDebug(String(e));
      }
    }

    function unlockByCode(){
      showError(""); showDebug("");
      const v = ($("accessCode").value || "").trim();
      if(v === ACCESS_CODE){
        localStorage.setItem(ACCESS_FLAG_KEY, "true");
        hideLock();
      } else {
        showError("Fel kod.");
      }
    }

    async function logoutAll(){
      showError(""); showDebug("");
      localStorage.removeItem(ACCESS_FLAG_KEY);
      if(supabase){
        try{ await supabase.auth.signOut(); }catch{}
      }
      showLock();
    }

    // Exponera för inline onclick
    window.__signInEmail = signInEmail;
    window.__signUpEmail = signUpEmail;
    window.__unlockByCode = unlockByCode;
    window.__logoutAll = logoutAll;

    // =========================
    // API helpers
    // =========================
    async function postJson(path, payload){
      const resp = await fetch(path, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      const raw = await resp.text();
      let data = null;
      try{ data = JSON.parse(raw); } catch {}
      return { ok: resp.ok, status: resp.status, raw, data };
    }
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    // =========================
    // App state
    // =========================
    const spinWrap = $("spinWrap");
    const miniStateEl = $("miniState");
    const statusEl = $("status");
    const examMetaEl = $("examMeta");
    const examBodyEl = $("examBody");
    const resultMetaEl = $("resultMeta");
    const resultBodyEl = $("resultBody");
    const gradeBtn = $("gradeBtn");

    let currentExam = null;

    function setBusy(b, label){
      spinWrap.style.display = b ? "inline-flex" : "none";
      miniStateEl.textContent = label || (b ? "…" : "Redo.");
      $("generateExamBtn").disabled = b;
      $("gradeBtn").disabled = b || !currentExam;
      $("clearBtn").disabled = b;
    }
    function setStatus(txt, kind){
      statusEl.className = "status" + (kind ? (" " + kind) : "");
      statusEl.textContent = txt || "";
    }

    function renderExam(exam){
      currentExam = exam;
      const qs = Array.isArray(exam.questions) ? exam.questions : [];
      examMetaEl.textContent = `${exam.title || "Mockprov"} • Nivå: ${exam.level || "—"} • ${qs.length} frågor`;
      examBodyEl.innerHTML = "";
      resultMetaEl.textContent = "Ingen rättning ännu.";
      resultBodyEl.innerHTML = "";

      qs.forEach((q, idx) => {
        const qid = String(q.id ?? (idx+1));
        const box = document.createElement("div");
        box.className = "qBox";
        box.innerHTML = `
          <div class="qMeta">ID: ${escapeHtml(qid)} • Poäng: ${escapeHtml(q.points ?? "—")} • Typ: ${escapeHtml(q.type ?? "")}</div>
          <div class="qText">${escapeHtml(q.question ?? "")}</div>
        `;

        if(q.type === "mc" && Array.isArray(q.options) && q.options.length){
          const hidden = document.createElement("input");
          hidden.type = "hidden";
          hidden.className = "mcAnswer";
          hidden.dataset.qid = qid;
          box.appendChild(hidden);

          const group = document.createElement("div");
          group.className = "mcGroup";
          q.options.forEach((opt, i) => {
            const letter = String.fromCharCode(65+i);
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "mcOpt";
            btn.innerHTML = `<span class="mcLetter">${letter}</span><span class="mcText">${escapeHtml(opt)}</span>`;
            btn.addEventListener("click", () => {
              group.querySelectorAll(".mcOpt").forEach(x => x.classList.remove("sel"));
              btn.classList.add("sel");
              hidden.value = letter;
            });
            group.appendChild(btn);
          });
          box.appendChild(group);
        } else {
          const ta = document.createElement("textarea");
          ta.className = "answer";
          ta.dataset.qid = qid;
          ta.placeholder = "Skriv ditt svar här…";
          ta.style.marginTop = "10px";
          ta.style.minHeight = (q.type === "essay") ? "150px" : "110px";
          box.appendChild(ta);
        }

        examBodyEl.appendChild(box);
      });

      gradeBtn.disabled = qs.length === 0;
    }

    function renderResult(r){
      resultMetaEl.textContent = `Rättning: ${r.total_points}/${r.max_points}`;
      resultBodyEl.innerHTML = "";
      (r.per_question || []).forEach(item => {
        const d = document.createElement("div");
        d.className = "qBox";
        d.innerHTML = `
          <div class="qMeta">ID: ${escapeHtml(item.id)} • ${item.points}/${item.max_points}</div>
          <div style="font-weight:850;line-height:1.45">${escapeHtml(item.feedback || "")}</div>
          <div style="margin-top:10px;border-top:1px solid rgba(5,42,30,.12);padding-top:10px">
            <div style="font-weight:1100;color:#052A1E;margin-bottom:6px;font-size:13px">Vad som ger full poäng (modellsvar)</div>
            <div style="white-space:pre-wrap;font-weight:800;line-height:1.45">${escapeHtml(item.model_answer || "")}</div>
          </div>
        `;
        resultBodyEl.appendChild(d);
      });
    }

    function clearAll(){
      $("pastedText").value = "";
      $("course").value = "";
      $("level").value = "C";
      $("qType").value = "mix";
      $("numQuestions").value = "12";
      currentExam = null;
      examMetaEl.textContent = "Ingen provdata ännu.";
      examBodyEl.innerHTML = "";
      resultMetaEl.textContent = "Ingen rättning ännu.";
      resultBodyEl.innerHTML = "";
      gradeBtn.disabled = true;
      setStatus("Allt rensat. Börja om.", "ok");
      showDebug("");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    // Exponera för onclick
    window.__clearAll = clearAll;

    // =========================
    // Generate / Grade (exponerade)
    // =========================
    async function generateExam(){
      showDebug(""); setStatus("", "");
      const pastedText = $("pastedText").value.trim();
      if(!pastedText){
        setStatus("Klistra in material först.", "bad");
        document.querySelector("#material").scrollIntoView({behavior:"smooth"});
        return;
      }

      const payload = {
        lang: "sv",
        level: $("level").value,
        course: $("course").value.trim(),
        qType: $("qType").value,
        pastedText,
        numQuestions: Number($("numQuestions").value)
      };

      setBusy(true, "Skapar mockprov…");
      const res = await postJson("/api/generate-exam", payload);

      if(!res.ok || !res.data || !res.data.ok){
        setBusy(false, "Redo.");
        setStatus(`Fel vid generering (HTTP ${res.status}).`, "bad");
        showDebug(res.raw);
        return;
      }

      renderExam(res.data.exam);
      setBusy(false, "Redo.");
      setStatus("Mockprov klart.", "ok");
      document.querySelector("#exam").scrollIntoView({behavior:"smooth"});
    }

    async function gradeExam(){
      showDebug(""); setStatus("", "");
      if(!currentExam || !Array.isArray(currentExam.questions) || currentExam.questions.length === 0){
        setStatus("Skapa mockprov först.", "bad");
        return;
      }

      const answers = [];
      currentExam.questions.forEach((q, idx) => {
        const qid = String(q.id ?? (idx+1));
        if(q.type === "mc"){
          const hidden = document.querySelector(`input.mcAnswer[data-qid="${CSS.escape(qid)}"]`);
          answers.push({ id: qid, answer: (hidden?.value || "").trim() });
        } else {
          const ta = document.querySelector(`textarea.answer[data-qid="${CSS.escape(qid)}"]`);
          answers.push({ id: qid, answer: (ta?.value || "").trim() });
        }
      });

      const payload = {
        lang: "sv",
        pastedText: $("pastedText").value.trim(),
        questions: currentExam.questions,
        answers
      };

      setBusy(true, "Rättar prov…");
      const res = await postJson("/api/grade", payload);

      if(!res.ok || !res.data || !res.data.ok){
        setBusy(false, "Redo.");
        setStatus(`Fel vid rättning (HTTP ${res.status}).`, "bad");
        showDebug(res.raw);
        return;
      }

      renderResult(res.data.result);
      setBusy(false, "Redo.");
      setStatus("Rättning klar.", "ok");
      document.querySelector("#result").scrollIntoView({behavior:"smooth"});
    }

    window.__generateExam = generateExam;
    window.__gradeExam = gradeExam;

    // =========================
    // Initial lock logic
    // =========================
    (async function initLock(){
      try{
        if(supabase){
          const { data } = await supabase.auth.getSession();
          const hasSession = Boolean(data?.session?.user);
          if(hasSession){ hideLock(); return; }
        }
        if(isUnlockedByCode()){ hideLock(); return; }
        showLock();
      }catch(e){
        showLock();
        showDebug(String(e));
      }
    })();
  </script>
</body>
</html>
