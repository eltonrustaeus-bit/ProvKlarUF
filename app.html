<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ProviaAi – App</title>

  <style>
    :root{
      --deep:#052A1E; --deep2:#041E16;
      --mint:#2BE38C; --mint2:#16B876;
      --bg:#F6FBF8; --muted:#556072; --border:rgba(5,42,30,.14);
      --shadow:0 18px 55px rgba(5,42,30,.14);
      --radius:18px; --font:system-ui,-apple-system,Segoe UI,Roboto,Arial; --max:1080px;
      --danger:#8b1d1d; --ok:#0f7a5a; --warn:#946200;
    }
    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    :target{scroll-margin-top:92px}
    body{
      margin:0;font-family:var(--font);
      background:
        radial-gradient(900px 450px at 20% -10%, rgba(43,227,140,.18), transparent 60%),
        radial-gradient(700px 380px at 95% 20%, rgba(43,227,140,.10), transparent 55%),
        var(--bg);
      color:#071812;
    }
    a{text-decoration:none;color:inherit}

    header{
      background:rgba(255,255,255,.88);backdrop-filter:saturate(140%) blur(10px);
      border-bottom:1px solid var(--border);
      position:sticky;top:0;z-index:3000;
    }
    .wrap{max-width:var(--max);margin:0 auto;padding:clamp(14px,3vw,22px)}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:12px;min-width:0}
    .brand img{height:54px;width:auto;display:block}
    .brand .name{font-weight:1100;color:var(--deep);font-size:18px;line-height:1.05}
    .brand .tag{margin-top:3px;color:var(--muted);font-weight:850;font-size:12px;line-height:1.1}

    .btn{
      display:inline-flex;align-items:center;justify-content:center;
      padding:12px 16px;border-radius:14px;
      font-weight:1000;font-size:14px;border:1px solid var(--border);
      cursor:pointer;white-space:nowrap;
      background:rgba(255,255,255,.92);color:var(--deep);
    }
    .btnPrimary{
      background:var(--mint2);color:#fff;border-color:rgba(22,184,118,.28);
      box-shadow:0 14px 28px rgba(22,184,118,.22)
    }

    .card{
      background:rgba(255,255,255,.92);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:clamp(16px,3vw,22px);
      margin:14px 0;
      overflow:hidden;
      position:relative;
    }
    .card:before{
      content:"";
      position:absolute;inset:-70px -70px auto auto;
      width:190px;height:190px;border-radius:999px;
      background:radial-gradient(circle at 30% 30%, rgba(43,227,140,.16), transparent 60%);
      pointer-events:none;
    }
    .sectionTitle{
      margin:0 0 6px;font-weight:1100;letter-spacing:-.01em;color:var(--deep);
      font-size:16px;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .sectionSub{margin:0;color:var(--muted);font-weight:780;font-size:12px;line-height:1.35}

    label{display:block;margin:12px 0 6px;font-weight:1000;color:var(--deep);font-size:13px}
    select,input,textarea{
      width:100%;padding:12px;border-radius:14px;border:1px solid var(--border);background:#fff;
      font-family:inherit;font-size:14px;outline:none;
    }
    textarea{min-height:170px;resize:vertical}
    input:focus, textarea:focus, select:focus{border-color:rgba(43,227,140,.55);box-shadow:0 0 0 5px rgba(43,227,140,.14)}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:920px){ .grid2{grid-template-columns:1fr} }

    .status{margin-top:10px;color:var(--muted);font-weight:850;font-size:12px;line-height:1.35;word-break:break-word}
    .status.ok{color:var(--ok)} .status.bad{color:var(--danger)} .status.warn{color:var(--warn)}

    details{margin-top:10px}
    summary{cursor:pointer;font-weight:1000;color:var(--deep);font-size:13px}
    pre{
      margin:10px 0 0;padding:12px;border-radius:14px;border:1px solid var(--border);
      background:#fff;overflow:auto;font-size:12px;line-height:1.35;white-space:pre-wrap;word-break:break-word;
    }

    .spinner{width:16px;height:16px;border-radius:999px;border:2px solid rgba(5,42,30,.18);border-top-color:rgba(22,184,118,.95);animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .qBox{margin-top:12px;padding:12px;border:1px solid rgba(5,42,30,.12);border-radius:16px;background:#fff}
    .qMeta{color:var(--muted);font-weight:900;font-size:12px;margin-bottom:6px}
    .qText{font-weight:900;color:#071812;line-height:1.45}

    footer{border-top:1px solid var(--border);padding:18px;text-align:center;color:var(--muted);font-size:12px;font-weight:750}

    /* menu */
    .menuWrap{position:relative;z-index:4000}
    .iconBtn{
      width:44px;height:44px;border-radius:14px;border:1px solid var(--border);
      background:rgba(255,255,255,.92);cursor:pointer;display:grid;place-items:center;
    }
    .bars{width:18px;height:12px;display:grid;gap:3px}
    .bars span{display:block;height:2px;background:var(--deep);border-radius:2px;opacity:.9}
    .dropdown{
      position:absolute;right:0;top:54px;min-width:270px;
      background:rgba(255,255,255,.98);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:0 22px 60px rgba(5,42,30,.18);
      padding:8px;
      display:none;
      z-index:5000;
    }
    .dropdown a, .dropdown button{
      width:100%;
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid transparent;
      background:transparent;
      cursor:pointer;
      font-weight:950;
      color:var(--deep);
      font-size:13px;
      text-align:left;
    }
    .dropdown a:hover, .dropdown button:hover{background:rgba(43,227,140,.10);border-color:rgba(43,227,140,.18)}
    .pill{
      font-size:11px;font-weight:1000;color:var(--muted);
      border:1px solid var(--border);
      border-radius:999px;padding:4px 8px;background:#fff;
    }

    /* lock */
    .loginOverlay{
      position:fixed;inset:0;z-index:9999;
      background:
        radial-gradient(800px 420px at 20% 10%, rgba(43,227,140,.22), transparent 60%),
        radial-gradient(700px 380px at 90% 20%, rgba(43,227,140,.10), transparent 55%),
        linear-gradient(135deg, rgba(5,42,30,.98), rgba(4,30,22,.92));
      display:flex;align-items:center;justify-content:center;padding:18px;
    }
    .loginCard{
      width:min(640px, 100%);
      background:rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.22);
      border-radius:22px;
      box-shadow:0 24px 70px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .loginTop{display:flex;gap:14px;align-items:center;padding:18px 18px 10px}
    .loginTop img{height:68px;width:auto;display:block}
    .loginTop .ltTitle{font-weight:1100;color:var(--deep);font-size:20px;line-height:1.1}
    .loginTop .ltSub{margin-top:4px;color:var(--muted);font-weight:800;font-size:12px}
    .loginBody{padding:12px 18px 18px}
    .loginRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .err{margin-top:10px;color:var(--danger);font-weight:900;font-size:12px}

    /* upload */
    .uploadBox{
      border:1px dashed rgba(5,42,30,.22);
      border-radius:16px;
      padding:12px;
      background:rgba(255,255,255,.7);
    }
    .uploadTop{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .smallHint{color:var(--muted);font-weight:850;font-size:12px;line-height:1.35;margin-top:6px}
    .fileRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .fileRow input[type="file"]{max-width:320px}

    /* MC clickable */
    .mcGroup{display:grid;gap:8px;margin-top:10px}
    .mcOpt{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(5,42,30,.14);
      background:#fff; cursor:pointer;
      font-weight:900; line-height:1.35;
      text-align:left;
    }
    .mcOpt:hover{border-color:rgba(43,227,140,.35)}
    .mcOpt.sel{
      border-color:rgba(43,227,140,.60);
      box-shadow:0 0 0 5px rgba(43,227,140,.12);
    }
    .mcLetter{
      width:28px;height:28px;border-radius:10px;
      display:grid;place-items:center;
      background:rgba(5,42,30,.06);
      font-weight:1100;color:var(--deep);
      flex:0 0 28px;
    }
    .mcText{font-weight:850;color:#071812}
  </style>
</head>

<body>

  <!-- LOCK SCREEN -->
  <div id="loginScreen" class="loginOverlay" aria-hidden="false">
    <div class="loginCard" role="dialog" aria-modal="true" aria-label="Åtkomstkod">
      <div class="loginTop">
        <img src="image/proviaai-logo.png" alt="ProviaAi logga">
        <div>
          <div class="ltTitle">ProviaAi</div>
          <div class="ltSub">Åtkomst krävs för att använda appen</div>
        </div>
      </div>
      <div class="loginBody">
        <label for="accessCode">Åtkomstkod</label>
        <input id="accessCode" type="password" placeholder="Skriv koden…" autocomplete="off" />
        <div class="loginRow">
          <button class="btn btnPrimary" type="button" id="unlockBtn">Lås upp</button>
          <a class="btn" href="index.html">Till infosidan</a>
          <a class="btn" href="förbättring.html">Förbättring</a>
        </div>
        <div id="errorMsg" class="err" aria-live="polite"></div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <header>
    <div class="wrap topbar">
      <a class="brand" href="index.html">
        <img src="image/proviaai-logo.png" alt="ProviaAi logga">
        <div>
          <div class="name" id="brandName">ProviaAi</div>
          <div class="tag" id="brandTag">Mockprov • Rättning • Modellsvar</div>
        </div>
      </a>

      <div class="menuWrap">
        <button class="iconBtn" id="menuBtn" type="button" aria-label="Meny">
          <div class="bars" aria-hidden="true"><span></span><span></span><span></span></div>
        </button>

        <div class="dropdown" id="menu" aria-label="Menyval">
          <a href="#material" data-scroll="#material"><span>1) Material</span><span class="pill">Text/OCR</span></a>
          <a href="#settings" data-scroll="#settings"><span>2) Inställningar</span><span class="pill">Nivå</span></a>
          <a href="#exam" data-scroll="#exam"><span>3) Mockprov</span><span class="pill">Frågor</span></a>
          <a href="#result" data-scroll="#result"><span>4) Rättning</span><span class="pill">Modellsvar</span></a>

          <a href="förbättring.html"><span>Förbättring</span><span class="pill">Nivå</span></a>
          <button type="button" id="logoutTopBtn"><span>Logga ut</span><span class="pill">Lås</span></button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap" id="appRoot">

    <section class="card" id="material">
      <div class="sectionTitle"><span>Steg 1 – Material</span></div>
      <p class="sectionSub">Klistra in text. Valfritt: välj en bild eller ta foto → OCR lägger in text i materialet.</p>

      <label for="pastedText">Material (klistra in text)</label>
      <textarea id="pastedText" placeholder="Rubriker → punktlista → definitioner/formler → exempel"></textarea>

      <div class="uploadBox" style="margin-top:12px">
        <div class="uploadTop">
          <div style="font-weight:1000;color:var(--deep);font-size:13px">Bild → OCR (valfritt)</div>
          <div class="fileRow">
            <input id="imageInput" type="file" accept="image/*" capture="environment" />
            <button class="btn" id="ocrBtn" type="button">OCR till material</button>
          </div>
        </div>
        <div class="smallHint">Tips: tydlig bild rakt ovanifrån, bra ljus, hög kontrast.</div>
        <div class="status" id="ocrStatus"></div>
      </div>

      <div class="status warn" style="margin-top:12px">
        Tips: rubriker + punktlistor ger mer exakta frågor och bättre rättning.
      </div>
    </section>

    <section class="card" id="settings">
      <div class="sectionTitle">
        <span>Steg 2 – Inställningar</span>
        <a class="btn" href="förbättring.html">Förbättring</a>
      </div>
      <p class="sectionSub">Välj betygsnivå (E/C/A), frågetyp och exakt antal frågor.</p>

      <div class="grid2">
        <div>
          <label for="level">Nivå (E/C/A)</label>
          <select id="level">
            <option value="E">E</option>
            <option value="C" selected>C</option>
            <option value="A">A</option>
          </select>
        </div>
        <div>
          <label for="course">Ämne/kurs (valfritt)</label>
          <input id="course" placeholder="Ex: Matematik 2b / Historia 1b" />
        </div>
      </div>

      <div class="grid2" style="margin-top:12px">
        <div>
          <label for="qType">Frågetyp</label>
          <select id="qType">
            <option value="mix" selected>Blandat</option>
            <option value="mc">Flervalsfrågor</option>
            <option value="short">Kortsvar</option>
            <option value="essay">Essä</option>
          </select>
        </div>
        <div>
          <label for="numQuestions">Antal frågor (exakt)</label>
          <select id="numQuestions">
            <option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option>
            <option>9</option><option>10</option><option>11</option><option selected>12</option>
          </select>
        </div>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;align-items:center">
        <button class="btn btnPrimary" id="generateExamBtn" type="button">Skapa mockprov</button>
        <button class="btn" id="gradeBtn" type="button" disabled>Rätta prov</button>
        <button class="btn" id="clearBtn" type="button">Rensa</button>

        <span style="display:flex;gap:10px;align-items:center">
          <span id="spinWrap" style="display:none"><span class="spinner" aria-hidden="true"></span></span>
          <span class="sectionSub" id="miniState">Redo.</span>
        </span>
      </div>

      <div class="status" id="status"></div>

      <details id="debugWrap" style="display:none">
        <summary>Debug</summary>
        <pre id="debug"></pre>
      </details>
    </section>

    <section class="card" id="exam">
      <div class="sectionTitle"><span>Steg 3 – Mockprov</span></div>
      <div class="status" id="examMeta">Ingen provdata ännu.</div>
      <div id="examBody"></div>
    </section>

    <section class="card" id="result">
      <div class="sectionTitle"><span>Steg 4 – Rättning</span></div>
      <div class="status" id="resultMeta">Ingen rättning ännu.</div>
      <div id="resultBody"></div>
    </section>

  </main>

  <footer>ProviaAi är studiestöd och ger ingen officiell betygssättning.</footer>

  <script>
    // ===== LOGIN CONFIG =====
    const ACCESS_CODE = "provia123";                 // ÄNDRAD
    const ACCESS_FLAG_KEY = "proviaai_app_access";   // Ny key så cache inte blandas med gamla

    // ===== HELPERS =====
    const $ = (id) => document.getElementById(id);

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    async function postJson(path, payload){
      const resp = await fetch(path, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      const raw = await resp.text();
      let data = null;
      try{ data = JSON.parse(raw); } catch {}
      return { ok: resp.ok, status: resp.status, raw, data };
    }

    // ===== MENU =====
    const menuBtn = $("menuBtn");
    const menu = $("menu");

    function openMenu(){ menu.style.display = "block"; }
    function closeMenu(){ menu.style.display = "none"; }

    menuBtn.addEventListener("click", (e) => {
      e.preventDefault(); e.stopPropagation();
      menu.style.display === "block" ? closeMenu() : openMenu();
    });

    document.addEventListener("click", (e) => {
      if(menu.style.display !== "block") return;
      if(menu.contains(e.target) || menuBtn.contains(e.target)) return;
      closeMenu();
    });

    menu.addEventListener("click", (e) => {
      const a = e.target.closest("a[data-scroll]");
      if(a){
        e.preventDefault();
        const sel = a.getAttribute("data-scroll");
        closeMenu();
        const el = document.querySelector(sel);
        if(el) el.scrollIntoView({behavior:"smooth", block:"start"});
      }
    });

    document.addEventListener("keydown", (e) => {
      if(e.key === "Escape" && menu.style.display === "block") closeMenu();
    });

    // ===== LOCK / UNLOCK =====
    const loginScreen = $("loginScreen");
    const accessCodeEl = $("accessCode");
    const errorMsgEl = $("errorMsg");

    function isUnlocked(){ return localStorage.getItem(ACCESS_FLAG_KEY) === "true"; }

    function showLock(){
      loginScreen.style.display = "flex";
      loginScreen.setAttribute("aria-hidden", "false");
      errorMsgEl.textContent = "";
      accessCodeEl.value = "";
      document.documentElement.style.overflow = "hidden";
      document.body.style.overflow = "hidden";
    }

    function hideLock(){
      loginScreen.style.display = "none";
      loginScreen.setAttribute("aria-hidden", "true");
      document.documentElement.style.overflow = "";
      document.body.style.overflow = "";
    }

    function unlock(){
      const v = (accessCodeEl.value || "").trim();
      if(v === ACCESS_CODE){
        localStorage.setItem(ACCESS_FLAG_KEY, "true");
        errorMsgEl.textContent = "";
        hideLock();
      } else {
        errorMsgEl.textContent = "Fel kod.";
      }
    }

    function logout(){
      localStorage.removeItem(ACCESS_FLAG_KEY);
      closeMenu();
      showLock();
      window.location.href = "index.html";
    }

    $("unlockBtn").addEventListener("click", unlock);
    $("logoutTopBtn").addEventListener("click", logout);

    document.addEventListener("keydown", (e) => {
      if(loginScreen.style.display !== "none" && e.key === "Enter") unlock();
    });

    if(isUnlocked()) hideLock(); else showLock();

    // ===== STATE / ELEMENTS =====
    const spinWrap = $("spinWrap");
    const miniStateEl = $("miniState");
    const statusEl = $("status");
    const debugWrap = $("debugWrap");
    const debugEl = $("debug");

    const pastedTextEl = $("pastedText");
    const levelEl = $("level");
    const courseEl = $("course");
    const qTypeEl = $("qType");
    const numQuestionsEl = $("numQuestions");

    const generateExamBtn = $("generateExamBtn");
    const gradeBtn = $("gradeBtn");
    const clearBtn = $("clearBtn");

    const examMetaEl = $("examMeta");
    const examBodyEl = $("examBody");
    const resultMetaEl = $("resultMeta");
    const resultBodyEl = $("resultBody");

    const imageInput = $("imageInput");
    const ocrBtn = $("ocrBtn");
    const ocrStatus = $("ocrStatus");

    let currentExam = null;

    function setBusy(isBusy, label){
      spinWrap.style.display = isBusy ? "inline-flex" : "none";
      miniStateEl.textContent = label || (isBusy ? "…" : "Redo.");
      generateExamBtn.disabled = isBusy;
      gradeBtn.disabled = isBusy || !currentExam;
      clearBtn.disabled = isBusy;
      ocrBtn.disabled = isBusy;
    }
    function setStatus(txt, kind){
      statusEl.className = "status" + (kind ? (" " + kind) : "");
      statusEl.textContent = txt || "";
    }
    function setOcrStatus(txt, kind){
      ocrStatus.className = "status" + (kind ? (" " + kind) : "");
      ocrStatus.textContent = txt || "";
    }
    function showDebug(txt){
      debugWrap.style.display = "block";
      debugEl.textContent = txt || "";
    }
    function hideDebug(){
      debugWrap.style.display = "none";
      debugEl.textContent = "";
    }

    function renderExam(exam){
      currentExam = exam;
      const qs = Array.isArray(exam.questions) ? exam.questions : [];

      examMetaEl.textContent = `${exam.title || "Mockprov"} • Nivå: ${exam.level || "—"} • ${qs.length} frågor`;
      examBodyEl.innerHTML = "";
      resultMetaEl.textContent = "Ingen rättning ännu.";
      resultBodyEl.innerHTML = "";

      qs.forEach((q, idx) => {
        const box = document.createElement("div");
        box.className = "qBox";

        const qid = String(q.id ?? (idx+1));

        const meta = document.createElement("div");
        meta.className = "qMeta";
        meta.textContent = `ID: ${qid} • Poäng: ${q.points ?? "—"} • Typ: ${q.type ?? qTypeEl.value}`;

        const text = document.createElement("div");
        text.className = "qText";
        text.textContent = q.question ?? "";

        box.appendChild(meta);
        box.appendChild(text);

        if((q.type === "mc") && Array.isArray(q.options) && q.options.length){
          const group = document.createElement("div");
          group.className = "mcGroup";
          group.dataset.qid = qid;

          const hidden = document.createElement("input");
          hidden.type = "hidden";
          hidden.className = "mcAnswer";
          hidden.dataset.qid = qid;
          hidden.value = "";
          box.appendChild(hidden);

          q.options.forEach((opt, i) => {
            const letter = String.fromCharCode(65 + i);
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "mcOpt";
            btn.dataset.letter = letter;
            btn.dataset.qid = qid;

            btn.innerHTML = `<span class="mcLetter">${letter}</span><span class="mcText">${escapeHtml(opt)}</span>`;

            btn.addEventListener("click", () => {
              group.querySelectorAll(".mcOpt").forEach(x => x.classList.remove("sel"));
              btn.classList.add("sel");
              hidden.value = letter;
            });

            group.appendChild(btn);
          });

          box.appendChild(group);
          examBodyEl.appendChild(box);
          return;
        }

        const ans = document.createElement("textarea");
        ans.className = "answer";
        ans.placeholder = "Skriv ditt svar här…";
        ans.dataset.qid = qid;
        ans.style.marginTop = "10px";
        ans.style.minHeight = (q.type === "essay") ? "150px" : "110px";
        box.appendChild(ans);
        examBodyEl.appendChild(box);
      });

      gradeBtn.disabled = qs.length === 0;
    }

    function renderResult(r){
      resultMetaEl.textContent = `Rättning: ${r.total_points}/${r.max_points}`;
      const wrap = document.createElement("div");

      (r.per_question || []).forEach(item => {
        const d = document.createElement("div");
        d.className = "qBox";
        const model = String(item.model_answer || "").trim();
        d.innerHTML = `
          <div class="qMeta">ID: ${escapeHtml(item.id)} • ${item.points}/${item.max_points}</div>
          <div style="font-weight:850;line-height:1.45">${escapeHtml(item.feedback || "")}</div>
          <div style="margin-top:10px;border-top:1px solid rgba(5,42,30,.12);padding-top:10px">
            <div style="font-weight:1100;color:#052A1E;margin-bottom:6px;font-size:13px">Vad som ger full poäng (modellsvar)</div>
            <div style="white-space:pre-wrap;font-weight:800;line-height:1.45">${escapeHtml(model)}</div>
          </div>
        `;
        wrap.appendChild(d);
      });

      resultBodyEl.innerHTML = "";
      resultBodyEl.appendChild(wrap);
    }

    function clearAll(){
      pastedTextEl.value = "";
      courseEl.value = "";
      levelEl.value = "C";
      qTypeEl.value = "mix";
      numQuestionsEl.value = "12";

      imageInput.value = "";
      setOcrStatus("");

      currentExam = null;
      examMetaEl.textContent = "Ingen provdata ännu.";
      examBodyEl.innerHTML = "";

      resultMetaEl.textContent = "Ingen rättning ännu.";
      resultBodyEl.innerHTML = "";

      gradeBtn.disabled = true;
      setStatus("Allt rensat. Börja om.", "ok");
      hideDebug();

      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    async function fileToDataUrl(file){
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => resolve(String(fr.result || ""));
        fr.onerror = () => reject(new Error("FileReader error"));
        fr.readAsDataURL(file);
      });
    }

    // OCR
    ocrBtn.addEventListener("click", async () => {
      hideDebug();
      const file = imageInput.files && imageInput.files[0];
      if(!file){ setOcrStatus("Välj en bild först.", "bad"); return; }

      setBusy(true, "OCR pågår…");
      setOcrStatus("OCR pågår…", "warn");

      try{
        const dataUrl = await fileToDataUrl(file);
        const res = await postJson("/api/ocr", { imageDataUrl: dataUrl, lang: "sv" });

        if(!res.ok || !res.data || !res.data.ok){
          setBusy(false, "Redo.");
          setOcrStatus(`OCR error (HTTP ${res.status}).`, "bad");
          showDebug(res.raw);
          return;
        }

        const extracted = String(res.data.text || "").trim();
        if(extracted){
          const prefix = "\n\n--- OCR (bild) ---\n";
          const base = pastedTextEl.value.trim();
          pastedTextEl.value = (base ? base + prefix : "") + extracted + "\n";
        }

        setBusy(false, "Redo.");
        setOcrStatus("OCR klart. Texten lades in i materialet.", "ok");
      }catch(e){
        setBusy(false, "Redo.");
        setOcrStatus("OCR error.", "bad");
        showDebug(String(e));
      }
    });

    // Generate exam
    generateExamBtn.addEventListener("click", async () => {
      hideDebug();
      setStatus("");

      const pastedText = pastedTextEl.value.trim();
      if(!pastedText){
        setStatus("Klistra in material först.", "bad");
        document.querySelector("#material").scrollIntoView({behavior:"smooth"});
        return;
      }

      const payload = {
        lang: "sv",
        level: levelEl.value,
        course: courseEl.value.trim(),
        qType: qTypeEl.value,
        pastedText,
        numQuestions: Number(numQuestionsEl.value)
      };

      setBusy(true, "Skapar mockprov…");
      setStatus(`Skapar mockprov… (${payload.qType}, ${payload.numQuestions})`, "");

      const res = await postJson("/api/generate-exam", payload);
      if(!res.ok || !res.data || !res.data.ok){
        setBusy(false, "Redo.");
        setStatus(`Error (HTTP ${res.status}).`, "bad");
        showDebug(res.raw);
        return;
      }

      renderExam(res.data.exam);
      setBusy(false, "Redo.");
      setStatus("Mockprov klart.", "ok");
      document.querySelector("#exam").scrollIntoView({behavior:"smooth"});
    });

    // Grade exam
    gradeBtn.addEventListener("click", async () => {
      hideDebug();
      setStatus("");

      if(!currentExam || !Array.isArray(currentExam.questions) || currentExam.questions.length === 0){
        setStatus("Skapa mockprov först.", "bad");
        return;
      }

      const answers = [];
      currentExam.questions.forEach((q, idx) => {
        const qid = String(q.id ?? (idx+1));
        if(q.type === "mc"){
          const hidden = document.querySelector(`input.mcAnswer[data-qid="${CSS.escape(qid)}"]`);
          answers.push({ id: qid, answer: (hidden?.value || "").trim() });
        } else {
          const ta = document.querySelector(`textarea.answer[data-qid="${CSS.escape(qid)}"]`);
          answers.push({ id: qid, answer: (ta?.value || "").trim() });
        }
      });

      const payload = {
        lang: "sv",
        pastedText: pastedTextEl.value.trim(),
        questions: currentExam.questions,
        answers
      };

      setBusy(true, "Rättar prov…");
      setStatus("Rättar prov…", "");

      const res = await postJson("/api/grade", payload);
      if(!res.ok || !res.data || !res.data.ok){
        setBusy(false, "Redo.");
        setStatus(`Error (HTTP ${res.status}).`, "bad");
        showDebug(res.raw);
        return;
      }

      renderResult(res.data.result);

      setBusy(false, "Redo.");
      setStatus("Rättning klar.", "ok");
      document.querySelector("#result").scrollIntoView({behavior:"smooth"});
    });

    // Clear
    clearBtn.addEventListener("click", clearAll);

    setBusy(false, "Redo.");
  </script>
</body>
</html>
