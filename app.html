<script>
  // ====== HJÄLPFUNKTIONER (om du redan har dessa, duplicera inte) ======
  function extractTextFromOpenAI(openai) {
    try {
      if (openai && typeof openai.output_text === "string" && openai.output_text.trim()) {
        return openai.output_text;
      }
    } catch (_) {}
    try {
      const out = openai?.output;
      if (Array.isArray(out)) {
        for (const item of out) {
          const content = item?.content;
          if (Array.isArray(content)) {
            for (const c of content) {
              const t = c?.text;
              if (typeof t === "string" && t.trim()) return t;
            }
          }
        }
      }
    } catch (_) {}
    return null;
  }

  function extractFirstJsonObject(text) {
    if (typeof text !== "string") return null;
    const s = text.trim();
    if (!s) return null;
    if (s.startsWith("{") && s.endsWith("}")) return s;
    const start = s.indexOf("{");
    const end = s.lastIndexOf("}");
    if (start >= 0 && end > start) return s.slice(start, end + 1);
    return null;
  }

  function safeParseJson(jsonText) {
    try { return JSON.parse(jsonText); } catch (_) { return null; }
  }

  // ====== RÄTTNING: samlar svar från UI och skickar till /api/grade ======
  const gradeStatus = document.getElementById("gradeStatus");
  const levelEl = document.getElementById("level");
  const courseEl = document.getElementById("course");
  const textEl = document.getElementById("pastedText");

  // Dessa två behövs från din generate-del:
  // - window.__currentExamQuestions = [...] (sätt detta när mockprovet renderas)
  // - answer textareas med class="answer" ELLER skapa dem per fråga
  //
  // Om du renderar frågor som i min senaste app.html (listan #questions),
  // lägg till inputfält per fråga och spara i window.__currentExamQuestions.
  //
  // Minsta variant: om du inte har svarsfält per fråga ännu,
  // så skickar vi tomma svar och du bygger vidare senare.

  document.getElementById("gradeBtn").addEventListener("click", async () => {
    gradeStatus.textContent = "Rättar...";

    const level = levelEl ? levelEl.value : "C";
    const course = courseEl ? courseEl.value.trim() : "";
    const pastedText = textEl ? textEl.value.trim() : "";

    const questions = Array.isArray(window.__currentExamQuestions)
      ? window.__currentExamQuestions
      : [];

    // Försök läsa svar från textareas med class="answer" (om du har dem)
    const answerEls = Array.from(document.querySelectorAll("textarea.answer"));
    const answers = answerEls.map((el, idx) => ({
      id: questions[idx]?.id ?? String(idx + 1),
      answer: el.value.trim()
    }));

    try {
      const response = await fetch("/api/grade", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ level, course, pastedText, questions, answers })
      });

      const data = await response.json().catch(() => null);

      if (!response.ok || !data || !data.ok) {
        gradeStatus.textContent = "Fel vid rättning. Se Console.";
        console.error("Grade API error:", { status: response.status, data });
        return;
      }

      const rawText = extractTextFromOpenAI(data.openai);
      const jsonText = extractFirstJsonObject(rawText);
      const result = safeParseJson(jsonText);

      if (!result) {
        gradeStatus.textContent = "Kunde inte tolka rättningen som JSON. Se Console.";
        console.log("OpenAI raw grade:", data.openai);
        console.log("Extracted text:", rawText);
        return;
      }

      gradeStatus.textContent = `Klart: ${result.total_points}/${result.max_points}`;
      console.log("Rättning:", result);

      // Om du vill: uppdatera UI-element om du har dem
      const scoreEl = document.getElementById("score");
      if (scoreEl) scoreEl.textContent = `${result.total_points} / ${result.max_points}`;

      const tipsEl = document.getElementById("tips");
      if (tipsEl && Array.isArray(result.tips)) {
        tipsEl.innerHTML = "";
        for (const t of result.tips) {
          const li = document.createElement("li");
          li.textContent = t;
          tipsEl.appendChild(li);
        }
      }

    } catch (err) {
      gradeStatus.textContent = "Nätverksfel. Se Console.";
      console.error(err);
    }
  });
</script>
