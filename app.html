<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ProvKlar – App</title>
  <meta name="description" content="ProvKlar – skapa mockprov, skriv svar och få rättning + tips." />
  <style>
    :root{
      --navy:#0B1F3A;
      --teal:#18B88A;
      --bg:#F6F8FB;
      --card:#FFFFFF;
      --muted:#556072;
      --border:rgba(11,31,58,.12);
      --shadow:0 18px 50px rgba(11,31,58,.14);
      --radius:18px;
      --font:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      --max:1020px;
      --danger:#8b1d1d;
      --ok:#0f7a5a;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      background:
        radial-gradient(900px 450px at 20% -10%, rgba(24,184,138,.18), transparent 60%),
        var(--bg);
      color:#0C1220;
    }
    a{text-decoration:none;color:inherit}

    header{
      background:rgba(255,255,255,.86);
      backdrop-filter:saturate(140%) blur(10px);
      border-bottom:1px solid var(--border);
      position:sticky;top:0;z-index:5
    }
    .wrap{max-width:var(--max);margin:0 auto;padding:clamp(14px,3vw,22px)}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:14px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:12px;min-width:0}
    .brand img{height:56px;width:auto;display:block}
    .brand .name{font-weight:1000;color:var(--navy);font-size:18px;line-height:1.05}
    .brand .tag{margin-top:3px;color:var(--muted);font-weight:800;font-size:12px}

    .btn{
      display:inline-flex;align-items:center;justify-content:center;
      padding:12px 16px;border-radius:14px;
      font-weight:1000;font-size:14px;border:1px solid transparent;
      cursor:pointer;white-space:nowrap;
      transition:transform .06s ease, opacity .06s ease;
      user-select:none;
    }
    .btn:active{transform:translateY(1px)}
    .btnPrimary{
      background:var(--teal);color:#fff;border-color:rgba(24,184,138,.28);
      box-shadow:0 14px 28px rgba(24,184,138,.22)
    }
    .btnGhost{background:rgba(255,255,255,.92);color:var(--navy);border-color:var(--border)}
    .btnDanger{background:#fff;color:var(--danger);border-color:rgba(139,29,29,.24)}
    .btn:disabled{opacity:.6;cursor:not-allowed;transform:none}

    .card{
      background:rgba(255,255,255,.92);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:clamp(16px,3vw,22px);
      margin:14px 0;
      overflow:hidden;
      position:relative;
    }
    .card:before{
      content:"";
      position:absolute;inset:-70px -70px auto auto;
      width:190px;height:190px;border-radius:999px;
      background:radial-gradient(circle at 30% 30%, rgba(24,184,138,.16), transparent 60%);
      pointer-events:none;
    }

    .sectionTitle{
      margin:0 0 8px;
      font-weight:1100;
      letter-spacing:-.01em;
      color:var(--navy);
      font-size:16px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .sectionSub{margin:0;color:var(--muted);font-weight:750;font-size:12px;line-height:1.35}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:880px){.grid{grid-template-columns:1fr}}

    label{display:block;margin:12px 0 6px;font-weight:1000;color:var(--navy);font-size:13px}
    select,input,textarea{
      width:100%;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      font-family:inherit;
      font-size:14px;
      outline:none;
    }
    textarea{min-height:140px;resize:vertical}
    input:focus, textarea:focus, select:focus{
      border-color:rgba(24,184,138,.45);
      box-shadow:0 0 0 5px rgba(24,184,138,.14);
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
    .status{
      margin-top:10px;
      color:var(--muted);
      font-weight:850;
      font-size:12px;
      line-height:1.35;
      word-break:break-word
    }
    .status.ok{color:var(--ok)}
    .status.bad{color:var(--danger)}

    pre{
      margin:10px 0 0;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      overflow:auto;
      font-size:12px;
      line-height:1.35;
      white-space:pre-wrap;
      word-break:break-word;
      display:none;
    }

    .chipRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;
      background:#fff;border:1px solid var(--border);
      color:var(--navy);font-weight:950;font-size:12px
    }
    .dot{width:9px;height:9px;border-radius:999px;background:var(--teal);box-shadow:0 0 0 6px rgba(24,184,138,.16)}

    .q{
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      background:#fff;
      margin-top:10px;
    }
    .q .meta{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px;color:var(--muted);font-size:12px;font-weight:950}
    .q .text{margin:0 0 10px;font-weight:850;color:#0C1220;line-height:1.45}

    .materialBox{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    .uploader{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    @media (max-width:880px){.uploader{grid-template-columns:1fr}}

    .drop{
      border:1px dashed rgba(11,31,58,.28);
      border-radius:16px;
      background:rgba(255,255,255,.92);
      padding:14px;
      display:flex;flex-direction:column;gap:10px;
    }
    .drop strong{color:var(--navy);font-weight:1100}
    .drop span{color:var(--muted);font-weight:750;font-size:12px;line-height:1.35}
    .miniRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    .list{
      border:1px solid var(--border);
      border-radius:16px;
      background:#fff;
      padding:12px;
    }
    .listHeader{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .listHeader b{color:var(--navy)}
    .listHeader small{color:var(--muted);font-weight:800}
    .item{
      margin-top:10px;
      padding:10px;
      border:1px solid var(--border);
      border-radius:14px;
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
    }
    .item .meta{
      display:flex;flex-direction:column;gap:2px;min-width:0
    }
    .item .name{
      font-weight:950;color:#0C1220;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:520px
    }
    .item .desc{font-size:12px;color:var(--muted);font-weight:800}
    .itemActions{display:flex;gap:8px;flex-wrap:wrap}
    .tinyBtn{
      padding:8px 10px;border-radius:12px;border:1px solid var(--border);
      background:#fff;color:var(--navy);font-weight:950;font-size:12px;cursor:pointer
    }
    .tinyBtn.danger{color:var(--danger);border-color:rgba(139,29,29,.22)}
    .preview{
      margin-top:10px;
      display:none;
      border:1px solid var(--border);
      border-radius:16px;
      background:#fff;
      padding:12px;
    }
    .preview img{max-width:100%;height:auto;border-radius:14px;border:1px solid var(--border)}

    footer{
      border-top:1px solid var(--border);
      padding:18px;text-align:center;color:var(--muted);
      font-size:12px;font-weight:750
    }

    /* LOGIN OVERLAY */
    .loginOverlay{
      position:fixed;inset:0;z-index:9999;
      background:
        radial-gradient(800px 420px at 20% 10%, rgba(24,184,138,.22), transparent 60%),
        radial-gradient(700px 380px at 90% 20%, rgba(24,184,138,.10), transparent 55%),
        linear-gradient(135deg, rgba(11,31,58,.98), rgba(11,31,58,.92));
      display:flex;align-items:center;justify-content:center;
      padding:18px;
    }
    .loginCard{
      width:min(560px, 100%);
      background:rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.22);
      border-radius:22px;
      box-shadow:0 24px 70px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .loginTop{display:flex;gap:14px;align-items:center;padding:18px 18px 10px 18px}
    .loginTop img{height:68px;width:auto;display:block}
    .loginTop .ltTitle{font-weight:1000;color:var(--navy);font-size:20px;line-height:1.1}
    .loginTop .ltSub{margin-top:4px;color:var(--muted);font-weight:800;font-size:12px}
    .loginBody{padding:12px 18px 18px 18px}
    .fieldLabel{display:block;font-weight:1000;color:var(--navy);font-size:13px;margin:10px 0 6px}
    .field{width:100%;padding:12px;border-radius:14px;border:1px solid var(--border);background:#fff;font-family:inherit;font-size:14px}
    .loginRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .err{margin-top:10px;color:var(--danger);font-weight:900;font-size:12px}
    .hint{margin-top:10px;color:var(--muted);font-weight:800;font-size:12px;line-height:1.35}
    .kbd{display:inline-flex;align-items:center;justify-content:center;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#fff;color:var(--navy);font-weight:1000;font-size:11px}

    .spinner{
      width:16px;height:16px;border-radius:999px;
      border:2px solid rgba(11,31,58,.18);
      border-top-color:rgba(24,184,138,.95);
      animation:spin .8s linear infinite;
      display:none;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>

  <!-- LOGIN OVERLAY -->
  <div id="loginScreen" class="loginOverlay" aria-hidden="false">
    <div class="loginCard" role="dialog" aria-modal="true" aria-label="Åtkomstkod">
      <div class="loginTop">
        <img src="image/provklar-logo.png" alt="ProvKlar UF logga">
        <div>
          <div class="ltTitle">ProvKlar UF</div>
          <div class="ltSub">Åtkomst krävs för att fortsätta</div>
        </div>
      </div>
      <div class="loginBody">
        <label class="fieldLabel" for="accessCode">Åtkomstkod</label>
        <input class="field" id="accessCode" type="password" placeholder="Skriv koden…" autocomplete="off" />
        <div class="loginRow">
          <button class="btn btnPrimary" type="button" onclick="checkCode()">Lås upp</button>
          <button class="btn btnGhost" type="button" onclick="logout()">Rensa</button>
        </div>
        <div id="errorMsg" class="err" aria-live="polite"></div>
        <div class="hint">Tips: tryck <span class="kbd">Enter</span> efter att du skrivit koden.</div>
      </div>
    </div>
  </div>

  <header>
    <div class="wrap topbar">
      <a class="brand" href="index.html" aria-label="Till startsidan">
        <img src="image/provklar-logo.png" alt="ProvKlar UF logga">
        <div>
          <div class="name">ProvKlar</div>
          <div class="tag">Skapa • Svara • Rätta</div>
        </div>
      </a>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <a class="btn btnGhost" href="index.html">Startsida</a>
        <!-- ÄNDRING: Logga ut ska logga ut direkt och skicka till startsidan -->
        <button class="btn btnDanger" type="button" id="logoutBtn">Logga ut</button>
      </div>
    </div>
  </header>

  <main class="wrap">

    <!-- MATERIAL -->
    <section class="card">
      <div class="sectionTitle">
        <span>Material</span>
        <div class="chipRow" aria-label="Materialstatus">
          <span class="chip"><span class="dot"></span> Text + filer</span>
          <span class="chip"><span class="dot"></span> Kamera (bild)</span>
        </div>
      </div>
      <p class="sectionSub">
        Du kan klistra in text, ladda upp textfiler eller ta en bild. Textfiler kan läsas in direkt. Bilder sparas som bilaga (ingen automatisk textutläsning i denna version).
      </p>

      <div class="uploader" style="margin-top:12px">
        <div class="drop">
          <strong>Ladda upp filer</strong>
          <span>Stöder: .txt, .md, .pdf, .png, .jpg. Textfiler kan läggas in i materialfältet automatiskt.</span>
          <div class="miniRow">
            <input id="fileInput" type="file" multiple
              accept=".txt,.md,text/plain,application/pdf,image/*" />
            <button class="btn btnGhost" type="button" id="addFilesBtn">Lägg till</button>
          </div>
        </div>

        <div class="drop">
          <strong>Ta bild (mobil)</strong>
          <span>Tar en bild och sparar den som bilaga i materiallistan.</span>
          <div class="miniRow">
            <input id="cameraInput" type="file" accept="image/*" capture="environment" />
            <button class="btn btnGhost" type="button" id="addPhotoBtn">Lägg till bild</button>
          </div>
        </div>
      </div>

      <div class="grid" style="margin-top:14px">
        <div>
          <label for="level">Nivå</label>
          <select id="level">
            <option value="E">E</option>
            <option value="C" selected>C</option>
            <option value="A">A</option>
          </select>

          <label for="course">Ämne/kurs (valfritt)</label>
          <input id="course" placeholder="Ex: Matematik 2b" />
        </div>

        <div class="materialBox">
          <div>
            <label for="pastedText">Material (klistra in text)</label>
            <textarea id="pastedText" placeholder="Klistra in anteckningar eller text här..."></textarea>
          </div>
          <div class="list">
            <div class="listHeader">
              <b>Materiallista</b>
              <small id="matCount">0 objekt</small>
            </div>
            <div id="matList"></div>
            <div class="status" id="matHint" style="margin-top:10px">
              Tips: använd textfiler för att snabbt fylla materialfältet.
            </div>
          </div>

          <div class="preview" id="imgPreview">
            <div class="sectionTitle" style="margin:0 0 10px">
              <span>Förhandsvisning</span>
              <button class="tinyBtn danger" type="button" id="closePreviewBtn">Stäng</button>
            </div>
            <img id="previewImg" alt="Förhandsvisning">
          </div>
        </div>
      </div>
    </section>

    <!-- ACTIONS -->
    <section class="card">
      <div class="sectionTitle">
        <span>Prov</span>
        <div class="miniRow" style="gap:10px">
          <div class="spinner" id="spinner"></div>
          <span class="sectionSub" id="miniState">Redo.</span>
        </div>
      </div>

      <div class="row">
        <!-- ÄNDRING: Testa AI borttagen -->
        <button class="btn btnPrimary" id="generateBtn" type="button">Skapa mockprov</button>
        <button class="btn btnGhost" id="gradeBtn" type="button" disabled>Rätta prov</button>
        <button class="btn btnGhost" id="clearBtn" type="button">Rensa</button>
      </div>

      <div class="status" id="status"></div>
      <pre id="debug"></pre>
    </section>

    <!-- EXAM -->
    <section class="card">
      <div class="sectionTitle"><span>Mockprov</span></div>
      <div class="status" id="examMeta">Ingen provdata ännu.</div>
      <div id="exam"></div>
    </section>

    <!-- RESULT -->
    <section class="card">
      <div class="sectionTitle"><span>Rättning</span></div>
      <div class="status" id="resultMeta">Ingen rättning ännu.</div>
      <div id="result"></div>
    </section>

  </main>

  <footer>ProvKlar UF är studiestöd och ger ingen officiell betygssättning.</footer>

  <script>
    // ========= LOGIN =========
    const CORRECT_CODE = "provklar123";

    function checkCode(){
      const inp = document.getElementById("accessCode");
      const msg = document.getElementById("errorMsg");
      const val = (inp.value || "").trim();

      if(val === CORRECT_CODE){
        localStorage.setItem("provklar_logged_in", "true");
        document.getElementById("loginScreen").style.display = "none";
        msg.textContent = "";
      } else {
        msg.textContent = "Fel kod.";
      }
    }

    function logout(){
      localStorage.removeItem("provklar_logged_in");
      const inp = document.getElementById("accessCode");
      const msg = document.getElementById("errorMsg");
      inp.value = "";
      msg.textContent = "";
    }

    document.addEventListener("keydown", (e) => {
      const visible = document.getElementById("loginScreen").style.display !== "none";
      if(visible && e.key === "Enter") checkCode();
    });

    if(localStorage.getItem("provklar_logged_in") === "true"){
      document.getElementById("loginScreen").style.display = "none";
    }

    // ========= APP =========
    document.addEventListener("DOMContentLoaded", () => {
      const statusEl = document.getElementById("status");
      const debugEl = document.getElementById("debug");
      const miniStateEl = document.getElementById("miniState");
      const spinnerEl = document.getElementById("spinner");

      const examMetaEl = document.getElementById("examMeta");
      const examEl = document.getElementById("exam");
      const resultMetaEl = document.getElementById("resultMeta");
      const resultEl = document.getElementById("result");

      const generateBtn = document.getElementById("generateBtn");
      const gradeBtn = document.getElementById("gradeBtn");
      const clearBtn = document.getElementById("clearBtn");

      const logoutBtn = document.getElementById("logoutBtn");

      const levelEl = document.getElementById("level");
      const courseEl = document.getElementById("course");
      const pastedTextEl = document.getElementById("pastedText");

      const fileInput = document.getElementById("fileInput");
      const cameraInput = document.getElementById("cameraInput");
      const addFilesBtn = document.getElementById("addFilesBtn");
      const addPhotoBtn = document.getElementById("addPhotoBtn");

      const matListEl = document.getElementById("matList");
      const matCountEl = document.getElementById("matCount");
      const matHintEl = document.getElementById("matHint");

      const imgPreview = document.getElementById("imgPreview");
      const previewImg = document.getElementById("previewImg");
      const closePreviewBtn = document.getElementById("closePreviewBtn");

      let currentExam = null;

      // material state
      const materials = []; // {id, type, name, size, note, contentText?, dataUrl?}
      const id = () => Math.random().toString(16).slice(2) + Date.now().toString(16);

      function setBusy(isBusy, label){
        spinnerEl.style.display = isBusy ? "inline-block" : "none";
        miniStateEl.textContent = label || (isBusy ? "Arbetar..." : "Redo.");
        generateBtn.disabled = isBusy;
        gradeBtn.disabled = isBusy || !currentExam;
        clearBtn.disabled = isBusy;
      }

      function setStatus(t, kind){
        statusEl.className = "status" + (kind ? (" " + kind) : "");
        statusEl.textContent = t || "";
      }

      function showDebug(t){
        debugEl.style.display="block";
        debugEl.textContent = t || "";
      }
      function hideDebug(){
        debugEl.style.display="none";
        debugEl.textContent = "";
      }

      function clearExam(){
        currentExam = null;
        examMetaEl.textContent = "Ingen provdata ännu.";
        examEl.innerHTML = "";
        gradeBtn.disabled = true;
      }

      function clearResult(){
        resultMetaEl.textContent = "Ingen rättning ännu.";
        resultEl.innerHTML = "";
      }

      function updateMaterialUI(){
        matCountEl.textContent = `${materials.length} objekt`;
        matListEl.innerHTML = "";

        if(materials.length === 0){
          matHintEl.textContent = "Inga filer/bilder ännu. Ladda upp eller ta en bild för att spara material.";
          return;
        }
        matHintEl.textContent = "Textfiler kan läsas in i materialfältet. Bilder sparas som bilaga.";

        for(const m of materials){
          const row = document.createElement("div");
          row.className = "item";

          const meta = document.createElement("div");
          meta.className = "meta";

          const name = document.createElement("div");
          name.className = "name";
          name.textContent = m.name;

          const desc = document.createElement("div");
          desc.className = "desc";
          desc.textContent = `${m.type.toUpperCase()} • ${(m.size/1024).toFixed(1)} KB` + (m.note ? ` • ${m.note}` : "");

          meta.appendChild(name);
          meta.appendChild(desc);

          const actions = document.createElement("div");
          actions.className = "itemActions";

          if(m.type === "image"){
            const preview = document.createElement("button");
            preview.type = "button";
            preview.className = "tinyBtn";
            preview.textContent = "Förhandsvisa";
            preview.addEventListener("click", () => {
              previewImg.src = m.dataUrl;
              imgPreview.style.display = "block";
              imgPreview.scrollIntoView({behavior:"smooth", block:"start"});
            });
            actions.appendChild(preview);
          }

          if(m.type === "text" && m.contentText){
            const insert = document.createElement("button");
            insert.type = "button";
            insert.className = "tinyBtn";
            insert.textContent = "Lägg i material";
            insert.addEventListener("click", () => {
              const current = pastedTextEl.value.trim();
              const add = m.contentText.trim();
              pastedTextEl.value = (current ? (current + "\n\n") : "") + add;
              setStatus("Text från fil inlagd i materialfältet.", "ok");
            });
            actions.appendChild(insert);
          }

          const remove = document.createElement("button");
          remove.type = "button";
          remove.className = "tinyBtn danger";
          remove.textContent = "Ta bort";
          remove.addEventListener("click", () => {
            const idx = materials.findIndex(x => x.id === m.id);
            if(idx >= 0) materials.splice(idx, 1);
            updateMaterialUI();
          });
          actions.appendChild(remove);

          row.appendChild(meta);
          row.appendChild(actions);
          matListEl.appendChild(row);
        }
      }

      closePreviewBtn.addEventListener("click", () => {
        imgPreview.style.display = "none";
        previewImg.src = "";
      });

      async function postJson(path, payload){
        const resp = await fetch(path, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const raw = await resp.text();
        let data = null; try { data = JSON.parse(raw); } catch {}
        return { status: resp.status, ok: resp.ok, raw, data };
      }

      // ========== File handling (text files only for parsing) ==========
      async function addSelectedFiles(fileList, sourceLabel){
        const files = Array.from(fileList || []);
        if(files.length === 0) return;

        for(const f of files){
          const ext = (f.name.split(".").pop() || "").toLowerCase();
          const isText = f.type.startsWith("text/") || ["txt","md","csv","json"].includes(ext);
          const isImage = f.type.startsWith("image/");

          if(isText){
            const text = await f.text();
            materials.push({
              id: id(),
              type: "text",
              name: f.name,
              size: f.size,
              note: sourceLabel,
              contentText: text
            });
          } else if(isImage){
            const dataUrl = await new Promise((resolve, reject) => {
              const r = new FileReader();
              r.onload = () => resolve(String(r.result));
              r.onerror = reject;
              r.readAsDataURL(f);
            });
            materials.push({
              id: id(),
              type: "image",
              name: f.name,
              size: f.size,
              note: sourceLabel,
              dataUrl
            });
          } else {
            // pdf/other: store as attachment only (no parsing in client)
            materials.push({
              id: id(),
              type: "file",
              name: f.name,
              size: f.size,
              note: sourceLabel
            });
          }
        }
        updateMaterialUI();
        setStatus("Material tillagt i listan.", "ok");
      }

      addFilesBtn.addEventListener("click", async () => {
        hideDebug();
        try{
          await addSelectedFiles(fileInput.files, "uppladdad fil");
          fileInput.value = "";
        } catch(e){
          setStatus("Kunde inte läsa fil.", "bad");
          showDebug(String(e));
        }
      });

      addPhotoBtn.addEventListener("click", async () => {
        hideDebug();
        try{
          await addSelectedFiles(cameraInput.files, "kamera");
          cameraInput.value = "";
        } catch(e){
          setStatus("Kunde inte läsa bild.", "bad");
          showDebug(String(e));
        }
      });

      // ========== Generate / Grade ==========
      function renderExam(exam){
        currentExam = exam;
        const qs = Array.isArray(exam.questions) ? exam.questions : [];
        examMetaEl.textContent = `${exam.title || "Mockprov"} • Nivå: ${exam.level || "—"} • Frågor: ${qs.length}`;
        examEl.innerHTML = "";

        qs.forEach((q, idx) => {
          const box = document.createElement("div");
          box.className = "q";

          const meta = document.createElement("div");
          meta.className = "meta";
          meta.textContent = `ID: ${q.id ?? (idx+1)} • Poäng: ${q.points ?? "—"}`;

          const text = document.createElement("p");
          text.className = "text";
          text.textContent = q.question ?? "";

          const answer = document.createElement("textarea");
          answer.className = "answer";
          answer.placeholder = "Skriv ditt svar här...";
          answer.dataset.qid = String(q.id ?? (idx+1));

          box.appendChild(meta);
          box.appendChild(text);
          box.appendChild(answer);
          examEl.appendChild(box);
        });

        gradeBtn.disabled = qs.length === 0;
      }

      function renderResult(r){
        resultMetaEl.textContent = `Rättning: ${r.total_points}/${r.max_points}`;
        const wrap = document.createElement("div");

        (r.per_question || []).forEach(item => {
          const d = document.createElement("div");
          d.className = "q";
          d.innerHTML = `
            <div class="meta">ID: ${item.id} • ${item.points}/${item.max_points}</div>
            <p class="text" style="margin:0">${item.feedback || ""}</p>
          `;
          wrap.appendChild(d);
        });

        if (Array.isArray(r.tips) && r.tips.length){
          const ul = document.createElement("ul");
          r.tips.forEach(t => { const li = document.createElement("li"); li.textContent = t; ul.appendChild(li); });
          wrap.appendChild(ul);
        }

        resultEl.innerHTML = "";
        resultEl.appendChild(wrap);
      }

      generateBtn.addEventListener("click", async () => {
        hideDebug();
        clearResult();
        clearExam();

        const pastedText = pastedTextEl.value.trim();
        if (!pastedText){
          setStatus("Klistra in material först (eller lägg in text från en textfil).", "bad");
          return;
        }

        setBusy(true, "Skapar mockprov...");
        setStatus("Skapar mockprov...", "");
        try{
          const r = await postJson("/api/generate-exam", {
            level: levelEl.value,
            course: courseEl.value.trim(),
            pastedText
          });

          if (!r.ok || !r.data || !r.data.ok){
            setBusy(false, "Redo.");
            setStatus(`Fel vid generering (HTTP ${r.status}).`, "bad");
            showDebug(r.raw);
            return;
          }

          renderExam(r.data.exam);
          setBusy(false, "Redo.");
          setStatus("Mockprov klart.", "ok");
        } catch(e){
          setBusy(false, "Redo.");
          setStatus("Fel vid generering.", "bad");
          showDebug(String(e));
        }
      });

      gradeBtn.addEventListener("click", async () => {
        hideDebug();
        clearResult();

        if (!currentExam || !Array.isArray(currentExam.questions) || currentExam.questions.length === 0){
          setStatus("Skapa mockprov först.", "bad");
          return;
        }

        const answers = Array.from(document.querySelectorAll("textarea.answer")).map(el => ({
          id: el.dataset.qid,
          answer: el.value.trim()
        }));

        setBusy(true, "Rättar prov...");
        setStatus("Rättar prov...", "");
        try{
          const r = await postJson("/api/grade", {
            level: levelEl.value,
            course: courseEl.value.trim(),
            pastedText: pastedTextEl.value.trim(),
            questions: currentExam.questions,
            answers
          });

          if (!r.ok || !r.data || !r.data.ok){
            setBusy(false, "Redo.");
            setStatus(`Fel vid rättning (HTTP ${r.status}).`, "bad");
            showDebug(r.raw);
            return;
          }

          renderResult(r.data.result);
          setBusy(false, "Redo.");
          setStatus("Rättning klar.", "ok");
        } catch(e){
          setBusy(false, "Redo.");
          setStatus("Fel vid rättning.", "bad");
          showDebug(String(e));
        }
      });

      clearBtn.addEventListener("click", () => {
        hideDebug();
        pastedTextEl.value = "";
        courseEl.value = "";
        levelEl.value = "C";
        materials.length = 0;
        updateMaterialUI();
        imgPreview.style.display = "none";
        previewImg.src = "";
        clearExam();
        clearResult();
        setStatus("");
      });

      // ÄNDRING: Logga ut ska logga ut direkt och skicka till startsidan
      logoutBtn.addEventListener("click", () => {
        logout();
        window.location.href = "index.html";
      });

      // init
      updateMaterialUI();
      setBusy(false, "Redo.");
      setStatus("");
    });
  </script>
</body>
</html>
