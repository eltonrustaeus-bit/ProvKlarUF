<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ProvKlar ‚Äì App</title>
  <meta name="description" content="ProvKlar ‚Äì multimodal material ‚Üí OCR ‚Üí mockprov ‚Üí r√§ttning + modellsvar + f√∂rb√§ttringar." />

  <style>
    :root{
      --navy:#0B1F3A;
      --teal:#18B88A;
      --bg:#F6F8FB;
      --muted:#556072;
      --border:rgba(11,31,58,.12);
      --shadow:0 18px 50px rgba(11,31,58,.14);
      --radius:18px;
      --font:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      --max:1080px;
      --danger:#8b1d1d;
      --ok:#0f7a5a;
      --warn:#946200;
      --card:#ffffff;
    }
    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{
      margin:0;
      font-family:var(--font);
      background:
        radial-gradient(900px 450px at 20% -10%, rgba(24,184,138,.18), transparent 60%),
        radial-gradient(700px 380px at 95% 20%, rgba(24,184,138,.10), transparent 55%),
        var(--bg);
      color:#0C1220;
    }
    a{text-decoration:none;color:inherit}
    :target{scroll-margin-top:92px}

    /* Header */
    header{
      background:rgba(255,255,255,.86);
      backdrop-filter:saturate(140%) blur(10px);
      border-bottom:1px solid var(--border);
      position:sticky;top:0;z-index:1000;
      overflow:visible;
    }
    .wrap{max-width:var(--max);margin:0 auto;padding:clamp(14px,3vw,22px)}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:14px}
    .brand{display:flex;align-items:center;gap:12px;min-width:0}
    .brand img{height:54px;width:auto;display:block}
    .brand .name{font-weight:1000;color:var(--navy);font-size:18px;line-height:1.05}
    .brand .tag{margin-top:3px;color:var(--muted);font-weight:800;font-size:12px}

    /* Buttons */
    .btn{
      display:inline-flex;align-items:center;justify-content:center;
      padding:12px 16px;border-radius:14px;
      font-weight:1000;font-size:14px;border:1px solid var(--border);
      cursor:pointer;white-space:nowrap;
      background:rgba(255,255,255,.92);
      color:var(--navy);
      transition:transform .06s ease, opacity .06s ease;
      user-select:none;
    }
    .btn:active{transform:translateY(1px)}
    .btnPrimary{
      background:var(--teal);color:#fff;border-color:rgba(24,184,138,.28);
      box-shadow:0 14px 28px rgba(24,184,138,.22)
    }
    .btnGhost{
      background:#fff;border-color:var(--border);color:var(--navy);
    }
    .btnDanger{
      background:#fff;border-color:rgba(139,29,29,.22);color:var(--danger);
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}

    /* Menu (checkbox + overlay, robust on mobile) */
    .menuWrap{position:relative;z-index:2000}
    #navToggleApp{position:absolute;left:-9999px}
    .menuBtn{
      width:46px;height:46px;border-radius:14px;
      display:inline-flex;align-items:center;justify-content:center;
      border:1px solid var(--border);
      background:rgba(255,255,255,.92);
      cursor:pointer;
    }
    .burger{width:18px;height:12px;position:relative}
    .burger span{
      position:absolute;left:0;right:0;height:2px;border-radius:2px;background:var(--navy);
      transition:transform .12s ease, top .12s ease, opacity .12s ease;
    }
    .burger span:nth-child(1){top:0}
    .burger span:nth-child(2){top:5px}
    .burger span:nth-child(3){top:10px}
    #navToggleApp:checked + label .burger span:nth-child(1){top:5px;transform:rotate(45deg)}
    #navToggleApp:checked + label .burger span:nth-child(2){opacity:0}
    #navToggleApp:checked + label .burger span:nth-child(3){top:5px;transform:rotate(-45deg)}
    .overlay{
      position:fixed;inset:0;
      background:transparent;
      z-index:1500;
      display:none;
    }
    #navToggleApp:checked ~ .overlay{display:block}
    .dropdown{
      position:absolute;right:0;top:56px;
      width:min(380px, calc(100vw - 28px));
      background:rgba(255,255,255,.97);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:0 18px 60px rgba(11,31,58,.18);
      padding:10px;
      display:none;
      z-index:2001;
      pointer-events:auto;
    }
    #navToggleApp:checked ~ .dropdown{display:block}
    .dropHead{
      padding:10px 10px 8px;
      font-weight:1100;color:var(--navy);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .dropList{display:grid;gap:8px;padding:0 6px 8px}
    .dropItem{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px;border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      font-weight:1000;color:var(--navy);
    }
    .dropItem small{color:var(--muted);font-weight:800}
    .dropItem.danger{color:var(--danger);border-color:rgba(139,29,29,.22);cursor:pointer}

    /* Cards */
    .card{
      background:rgba(255,255,255,.92);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:clamp(16px,3vw,22px);
      margin:14px 0;
      overflow:hidden;
      position:relative;
    }
    .card:before{
      content:"";
      position:absolute;inset:-70px -70px auto auto;
      width:190px;height:190px;border-radius:999px;
      background:radial-gradient(circle at 30% 30%, rgba(24,184,138,.16), transparent 60%);
      pointer-events:none;
    }
    .sectionTitle{
      margin:0 0 8px;
      font-weight:1100;
      letter-spacing:-.01em;
      color:var(--navy);
      font-size:16px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .sectionSub{margin:0;color:var(--muted);font-weight:780;font-size:12px;line-height:1.35}

    /* Chips */
    .chipRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;
      background:#fff;border:1px solid var(--border);
      color:var(--navy);font-weight:950;font-size:12px;
    }
    .dot{width:9px;height:9px;border-radius:999px;background:var(--teal);box-shadow:0 0 0 6px rgba(24,184,138,.16)}

    /* Inputs */
    label{display:block;margin:12px 0 6px;font-weight:1000;color:var(--navy);font-size:13px}
    select,input,textarea{
      width:100%;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      font-family:inherit;
      font-size:14px;
      outline:none;
    }
    textarea{min-height:165px;resize:vertical}
    input:focus, textarea:focus, select:focus{
      border-color:rgba(24,184,138,.45);
      box-shadow:0 0 0 5px rgba(24,184,138,.14);
    }

    /* Layout blocks */
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width: 920px){ .grid2{grid-template-columns:1fr} }
    .grid1{display:grid;grid-template-columns:1fr;gap:12px}

    /* Upload/OCR box */
    .pickBox{
      border:1px dashed rgba(11,31,58,.28);
      border-radius:16px;
      background:rgba(255,255,255,.92);
      padding:14px;
      display:grid;gap:10px;
    }
    .fileRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .fileBtn{
      display:inline-flex;align-items:center;justify-content:center;
      padding:12px 14px;border-radius:14px;
      border:1px solid rgba(24,184,138,.28);
      background:var(--teal);
      color:#fff;font-weight:1000;font-size:14px;
      box-shadow:0 14px 28px rgba(24,184,138,.22);
      cursor:pointer;user-select:none;
    }
    .fileHelp{color:var(--muted);font-weight:800;font-size:12px}
    .hiddenInput{position:absolute;left:-9999px;opacity:0;width:1px;height:1px}

    /* List */
    .list{
      border:1px solid var(--border);
      border-radius:16px;
      background:#fff;
      padding:12px;
    }
    .listHeader{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .listHeader b{color:var(--navy)}
    .listHeader small{color:var(--muted);font-weight:800}
    .item{
      margin-top:10px;padding:10px;border:1px solid var(--border);border-radius:14px;
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
    }
    .meta{display:flex;flex-direction:column;gap:2px;min-width:0}
    .name{font-weight:950;color:#0C1220;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:520px}
    .desc{font-size:12px;color:var(--muted);font-weight:820}
    .itemActions{display:flex;gap:8px;flex-wrap:wrap}
    .tinyBtn{
      padding:8px 10px;border-radius:12px;border:1px solid var(--border);
      background:#fff;color:var(--navy);font-weight:950;font-size:12px;cursor:pointer
    }
    .tinyBtn.danger{color:var(--danger);border-color:rgba(139,29,29,.22)}

    /* Preview & OCR */
    .preview{
      margin-top:10px;border:1px solid var(--border);border-radius:16px;background:#fff;padding:12px;display:none;
    }
    .previewGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width: 920px){ .previewGrid{grid-template-columns:1fr} }
    .preview img{
      max-width:100%;height:auto;border-radius:14px;border:1px solid var(--border);
      background:#fff;
    }
    .badgeRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-weight:950;font-size:12px;color:var(--navy);
    }
    .badge.ok{border-color:rgba(15,122,90,.24);color:var(--ok)}
    .badge.warn{border-color:rgba(148,98,0,.24);color:var(--warn)}
    .badge.bad{border-color:rgba(139,29,29,.24);color:var(--danger)}

    /* Actions card */
    .actionCard{
      border:1px solid var(--border);
      border-radius:18px;
      background:rgba(255,255,255,.92);
      padding:14px;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
    .status{margin-top:10px;color:var(--muted);font-weight:850;font-size:12px;line-height:1.35;word-break:break-word}
    .status.ok{color:var(--ok)}
    .status.bad{color:var(--danger)}
    .status.warn{color:var(--warn)}
    pre{
      margin:10px 0 0;padding:12px;border-radius:14px;border:1px solid var(--border);
      background:#fff;overflow:auto;font-size:12px;line-height:1.35;white-space:pre-wrap;word-break:break-word;
      display:none;
    }
    .spinner{
      width:16px;height:16px;border-radius:999px;border:2px solid rgba(11,31,58,.18);
      border-top-color:rgba(24,184,138,.95);animation:spin .8s linear infinite;display:none;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Exam blocks */
    .qBox{
      margin-top:12px;padding:12px;border:1px solid rgba(11,31,58,.12);border-radius:16px;background:#fff
    }
    .qMeta{color:var(--muted);font-weight:900;font-size:12px;margin-bottom:6px}
    .qText{font-weight:900;color:#0C1220;line-height:1.45}
    .answer{margin-top:10px}

    /* Coaching / adaptive */
    .coachGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    @media (max-width: 920px){ .coachGrid{grid-template-columns:1fr} }
    .coachBox{background:#fff;border:1px solid var(--border);border-radius:16px;padding:14px}
    .coachBox b{display:block;color:var(--navy);font-weight:1100}
    .coachBox span{display:block;margin-top:6px;color:var(--muted);font-weight:820;font-size:12px;line-height:1.45}

    /* Login overlay */
    .loginOverlay{
      position:fixed;inset:0;z-index:9999;
      background:
        radial-gradient(800px 420px at 20% 10%, rgba(24,184,138,.22), transparent 60%),
        radial-gradient(700px 380px at 90% 20%, rgba(24,184,138,.10), transparent 55%),
        linear-gradient(135deg, rgba(11,31,58,.98), rgba(11,31,58,.92));
      display:flex;align-items:center;justify-content:center;padding:18px;
    }
    .loginCard{
      width:min(580px, 100%);
      background:rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.22);
      border-radius:22px;
      box-shadow:0 24px 70px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .loginTop{display:flex;gap:14px;align-items:center;padding:18px 18px 10px}
    .loginTop img{height:68px;width:auto;display:block}
    .loginTop .ltTitle{font-weight:1000;color:var(--navy);font-size:20px;line-height:1.1}
    .loginTop .ltSub{margin-top:4px;color:var(--muted);font-weight:800;font-size:12px}
    .loginBody{padding:12px 18px 18px}
    .fieldLabel{display:block;font-weight:1000;color:var(--navy);font-size:13px;margin:10px 0 6px}
    .field{width:100%;padding:12px;border-radius:14px;border:1px solid var(--border);background:#fff;font-family:inherit;font-size:14px}
    .loginRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .err{margin-top:10px;color:var(--danger);font-weight:900;font-size:12px}
    .hint{margin-top:10px;color:var(--muted);font-weight:800;font-size:12px;line-height:1.35}
    .kbd{display:inline-flex;align-items:center;justify-content:center;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#fff;color:var(--navy);font-weight:1000;font-size:11px}

    footer{border-top:1px solid var(--border);padding:18px;text-align:center;color:var(--muted);font-size:12px;font-weight:750}

    /* Print export (PDF via browser print dialog) */
    @media print{
      header, .noPrint {display:none !important;}
      body{background:#fff}
      .card{box-shadow:none;border-color:#ddd}
      .wrap{max-width:none;padding:0}
    }
  </style>
</head>

<body>

  <!-- App lock -->
  <div id="loginScreen" class="loginOverlay" aria-hidden="false">
    <div class="loginCard" role="dialog" aria-modal="true" aria-label="√Ötkomstkod">
      <div class="loginTop">
        <img src="image/provklar-logo.png" alt="ProvKlar UF logga">
        <div>
          <div class="ltTitle">ProvKlar UF</div>
          <div class="ltSub">√Ötkomst kr√§vs f√∂r att anv√§nda appen</div>
        </div>
      </div>
      <div class="loginBody">
        <label class="fieldLabel" for="accessCode">√Ötkomstkod</label>
        <input class="field" id="accessCode" type="password" placeholder="Skriv koden‚Ä¶" autocomplete="off" />
        <div class="loginRow">
          <button class="btn btnPrimary" type="button" onclick="checkCode()">L√•s upp</button>
          <a class="btn" href="index.html">Till infosidan</a>
        </div>
        <div id="errorMsg" class="err" aria-live="polite"></div>
        <div class="hint">Tryck <span class="kbd">Enter</span> f√∂r att l√•sa upp.</div>
      </div>
    </div>
  </div>

  <header>
    <div class="wrap topbar">
      <a class="brand" href="index.html" aria-label="Till infosidan">
        <img src="image/provklar-logo.png" alt="ProvKlar UF logga">
        <div>
          <div class="name">ProvKlar</div>
          <div class="tag">Multimodal ‚Ä¢ OCR ‚Ä¢ Mockprov</div>
        </div>
      </a>

      <div class="menuWrap">
        <input id="navToggleApp" type="checkbox" />
        <label class="menuBtn" for="navToggleApp" aria-label="Meny">
          <div class="burger" aria-hidden="true"><span></span><span></span><span></span></div>
        </label>

        <label class="overlay" for="navToggleApp" aria-hidden="true"></label>

        <nav class="dropdown" aria-label="Meny">
          <div class="dropHead"><span>Meny</span><small>App</small></div>
          <div class="dropList">
            <a class="dropItem" href="index.html"><span>Infosida</span><small>√∂ppnar</small></a>
            <a class="dropItem" href="#material"><span>Material + OCR</span><small>steg 1</small></a>
            <a class="dropItem" href="#actions"><span>Skapa/R√§tta</span><small>steg 2</small></a>
            <a class="dropItem" href="#exam"><span>Mockprov</span><small>steg 3</small></a>
            <a class="dropItem" href="#result"><span>R√§ttning</span><small>steg 4</small></a>
            <a class="dropItem" href="#coach"><span>F√∂rb√§ttringar</span><small>adaptivt</small></a>
            <a class="dropItem" href="#export"><span>Export</span><small>PDF</small></a>
            <div class="dropItem danger" id="logoutMenuBtn"><span>Logga ut</span><small>l√•ser appen</small></div>
          </div>
        </nav>
      </div>
    </div>
  </header>

  <main class="wrap">

    <!-- Guide -->
    <section class="card">
      <div class="sectionTitle">
        <span>Stegprocess</span>
        <div class="chipRow">
          <a class="chip" href="#material"><span class="dot"></span> 1) Material</a>
          <a class="chip" href="#actions"><span class="dot"></span> 2) Skapa</a>
          <a class="chip" href="#exam"><span class="dot"></span> 3) Svara</a>
          <a class="chip" href="#result"><span class="dot"></span> 4) R√§tta</a>
        </div>
      </div>
      <p class="sectionSub">
        Klistra in text (viktigast). L√§gg till bilder och k√∂r OCR vid behov. Skapa mockprov, svara, r√§tta och f√• modellsvar + f√∂rb√§ttringar.
      </p>
    </section>

    <!-- Material + OCR -->
    <section class="card" id="material">
      <div class="sectionTitle">
        <span>Steg 1 ‚Äì Material + OCR (multimodal)</span>
        <div class="noPrint" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <label class="chip" style="cursor:pointer">
            <input type="checkbox" id="langToggle" style="margin:0 6px 0 0;transform:translateY(1px)">
            Engelska l√§ge
          </label>
        </div>
      </div>
      <p class="sectionSub">
        Prim√§rt: klistra in provmaterial. Sekund√§rt: l√§gg till bilder (bok/anteckning) och k√∂r OCR ‚Üí granska ‚Üí l√§gg till i materialet.
      </p>

      <div class="grid2" style="margin-top:12px">
        <div>
          <label for="pastedText">Material (klistra in text)</label>
          <textarea id="pastedText" placeholder="Rubriker ‚Üí punktlista ‚Üí definitioner/formler ‚Üí exempel"></textarea>
          <div class="status warn" style="margin-top:10px" id="formatHint">Tips: rubriker + punktlistor ger b√§ttre fr√•gor och mer exakt r√§ttning.</div>

          <div class="grid2" style="margin-top:12px">
            <div>
              <label for="level">Niv√•</label>
              <select id="level">
                <option value="E">E</option>
                <option value="C" selected>C</option>
                <option value="A">A</option>
              </select>
            </div>
            <div>
              <label for="course">√Ñmne/kurs (valfritt)</label>
              <input id="course" placeholder="Ex: Matematik 2b / Historia 1b" />
            </div>
          </div>
        </div>

        <div>
          <div class="pickBox">
            <div>
              <b style="color:var(--navy)">Bilder/filer</b>
              <div class="sectionSub" style="margin-top:6px">
                Mobil: v√§lj bild eller ta foto. Desktop: v√§lj filer. Bilder kan OCR:as.
              </div>
            </div>
            <div class="fileRow">
              <label class="fileBtn" for="fileInput">V√§lj fil / ta bild</label>
              <span class="fileHelp">.png .jpg .pdf .txt .md</span>
              <input id="fileInput" class="hiddenInput" type="file" multiple accept=".txt,.md,text/plain,application/pdf,image/*" />
            </div>

            <div class="list">
              <div class="listHeader"><b>Materiallista</b><small id="matCount">0 objekt</small></div>
              <div id="matList"></div>
              <div class="status" id="matHint" style="margin-top:10px">Inga bilagor √§nnu.</div>

              <div class="preview" id="ocrPanel">
                <div class="sectionTitle" style="margin:0 0 8px">
                  <span>OCR-panel</span>
                  <div class="noPrint" style="display:flex;gap:8px;flex-wrap:wrap">
                    <button class="tinyBtn" type="button" id="ocrRunBtn">K√∂r OCR</button>
                    <button class="tinyBtn" type="button" id="ocrAppendBtn" disabled>L√§gg till i material</button>
                    <button class="tinyBtn danger" type="button" id="ocrCloseBtn">St√§ng</button>
                  </div>
                </div>

                <div class="previewGrid">
                  <div>
                    <img id="ocrPreviewImg" alt="OCR-f√∂rhandsvisning">
                    <div class="badgeRow" id="qualityBadges"></div>
                    <div class="status" id="ocrStatus"></div>
                  </div>
                  <div>
                    <label for="ocrText">OCR-text (granska och justera innan du l√§gger till)</label>
                    <textarea id="ocrText" placeholder="OCR-resultat visas h√§r..." style="min-height:210px"></textarea>
                    <div class="status warn" id="ocrHint" style="margin-top:10px">
                      OCR kr√§ver backend-endpoint: <code>/api/ocr</code>. Om den saknas visas fel i debug.
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>

          <div class="pickBox" style="margin-top:12px">
            <div>
              <b style="color:var(--navy)">R√∂stinmatning (svar)</b>
              <div class="sectionSub" style="margin-top:6px">
                I provdelen kan du anv√§nda ‚Äúüé§‚Äù per fr√•ga (om webbl√§saren st√∂djer tal-till-text).
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Actions -->
    <section class="card" id="actions">
      <div class="sectionTitle"><span>Steg 2 ‚Äì Skapa och r√§tta</span></div>
      <p class="sectionSub">Skapa mockprov efter du lagt in material. R√§tta n√§r du svarat. R√§ttning ger √§ven ‚Äúvad som ger full po√§ng‚Äù.</p>

      <div class="actionCard">
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <div class="spinner" id="spinner"></div>
          <span class="sectionSub" id="miniState">Redo.</span>
        </div>

        <div class="row noPrint">
          <button class="btn btnPrimary" id="generateBtn" type="button">Skapa mockprov</button>
          <button class="btn" id="gradeBtn" type="button" disabled>R√§tta prov</button>
          <button class="btn btnGhost" id="clearBtn" type="button">Rensa</button>
        </div>

        <div class="status" id="status"></div>
        <pre id="debug"></pre>
      </div>
    </section>

    <!-- Exam -->
    <section class="card" id="exam">
      <div class="sectionTitle"><span>Steg 3 ‚Äì Mockprov</span></div>
      <div class="status" id="examMeta">Ingen provdata √§nnu.</div>
      <div id="examBody"></div>
    </section>

    <!-- Result -->
    <section class="card" id="result">
      <div class="sectionTitle"><span>Steg 4 ‚Äì R√§ttning</span></div>
      <div class="status" id="resultMeta">Ingen r√§ttning √§nnu.</div>
      <div id="resultBody"></div>
    </section>

    <!-- Adaptive coaching -->
    <section class="card" id="coach">
      <div class="sectionTitle"><span>F√∂rb√§ttringar (adaptivt)</span></div>
      <p class="sectionSub">Baserat p√• tidigare r√§ttningar (sparas lokalt i webbl√§saren).</p>

      <div class="coachGrid">
        <div class="coachBox">
          <b>Top 3 fokusomr√•den</b>
          <span id="weaknesses">Ingen data √§nnu.</span>
        </div>
        <div class="coachBox">
          <b>N√§sta pass (10‚Äì15 min)</b>
          <span id="nextSession">Skapa och r√§tta minst ett prov f√∂r att f√• rekommendationer.</span>
        </div>
      </div>

      <div class="row noPrint" style="margin-top:12px">
        <button class="btn btnGhost" id="resetCoachBtn" type="button">Nollst√§ll statistik</button>
      </div>
    </section>

    <!-- Export -->
    <section class="card" id="export">
      <div class="sectionTitle"><span>Export (PDF)</span></div>
      <p class="sectionSub">PDF via webbl√§sarens ‚ÄúSkriv ut‚Äù (v√§lj ‚ÄúSpara som PDF‚Äù).</p>
      <div class="row noPrint">
        <button class="btn" id="exportExamBtn" type="button" disabled>Exportera mockprov (PDF)</button>
        <button class="btn" id="exportResultBtn" type="button" disabled>Exportera r√§ttning (PDF)</button>
      </div>
      <div class="status" id="exportStatus"></div>
    </section>

  </main>

  <footer>ProvKlar UF √§r studiest√∂d och ger ingen officiell betygss√§ttning.</footer>

  <script>
    /* ========= App-lock ========= */
    const CORRECT_CODE = "provklar123";
    function checkCode(){
      const inp = document.getElementById("accessCode");
      const msg = document.getElementById("errorMsg");
      const val = (inp.value || "").trim();
      if(val === CORRECT_CODE){
        localStorage.setItem("provklar_app_access", "true");
        document.getElementById("loginScreen").style.display = "none";
        msg.textContent = "";
      } else {
        msg.textContent = "Fel kod.";
      }
    }
    function lockOut(){
      localStorage.removeItem("provklar_app_access");
      document.getElementById("loginScreen").style.display = "flex";
      document.getElementById("accessCode").value = "";
      document.getElementById("errorMsg").textContent = "";
    }
    document.addEventListener("keydown", (e) => {
      const visible = document.getElementById("loginScreen").style.display !== "none";
      if(visible && e.key === "Enter") checkCode();
    });
    if(localStorage.getItem("provklar_app_access") === "true"){
      document.getElementById("loginScreen").style.display = "none";
    }

    /* ========= Menu close behavior ========= */
    const navToggleApp = document.getElementById("navToggleApp");
    document.addEventListener("click", (e) => {
      const link = e.target.closest(".dropdown a");
      if(link) navToggleApp.checked = false;
    });
    document.getElementById("logoutMenuBtn").addEventListener("click", () => {
      navToggleApp.checked = false;
      lockOut();
      window.location.href = "index.html";
    });

    /* ========= Utilities ========= */
    const $ = (id) => document.getElementById(id);
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    async function postJson(path, payload){
      const resp = await fetch(path, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      const raw = await resp.text();
      let data = null;
      try{ data = JSON.parse(raw); } catch {}
      return { status: resp.status, ok: resp.ok, raw, data };
    }

    /* ========= State ========= */
    let currentExam = null;
    let lastResult = null;

    const materials = [];
    const makeId = () => Math.random().toString(16).slice(2) + Date.now().toString(16);

    /* ========= UI refs ========= */
    const spinnerEl = $("spinner");
    const miniStateEl = $("miniState");
    const statusEl = $("status");
    const debugEl = $("debug");

    const generateBtn = $("generateBtn");
    const gradeBtn = $("gradeBtn");
    const clearBtn = $("clearBtn");

    const levelEl = $("level");
    const courseEl = $("course");
    const pastedTextEl = $("pastedText");
    const langToggleEl = $("langToggle");

    const fileInput = $("fileInput");
    const matListEl = $("matList");
    const matCountEl = $("matCount");
    const matHintEl = $("matHint");

    const ocrPanel = $("ocrPanel");
    const ocrPreviewImg = $("ocrPreviewImg");
    const ocrText = $("ocrText");
    const ocrStatus = $("ocrStatus");
    const ocrRunBtn = $("ocrRunBtn");
    const ocrAppendBtn = $("ocrAppendBtn");
    const ocrCloseBtn = $("ocrCloseBtn");
    const qualityBadges = $("qualityBadges");

    const examMetaEl = $("examMeta");
    const examBodyEl = $("examBody");

    const resultMetaEl = $("resultMeta");
    const resultBodyEl = $("resultBody");

    const weaknessesEl = $("weaknesses");
    const nextSessionEl = $("nextSession");
    const resetCoachBtn = $("resetCoachBtn");

    const exportExamBtn = $("exportExamBtn");
    const exportResultBtn = $("exportResultBtn");
    const exportStatus = $("exportStatus");

    /* ========= Busy/status ========= */
    function setBusy(isBusy, label){
      spinnerEl.style.display = isBusy ? "inline-block" : "none";
      miniStateEl.textContent = label || (isBusy ? "Arbetar..." : "Redo.");
      generateBtn.disabled = isBusy;
      gradeBtn.disabled = isBusy || !currentExam;
      clearBtn.disabled = isBusy;
      ocrRunBtn.disabled = isBusy;
      exportExamBtn.disabled = isBusy || !currentExam;
      exportResultBtn.disabled = isBusy || !lastResult;
    }
    function setStatus(t, kind){
      statusEl.className = "status" + (kind ? (" " + kind) : "");
      statusEl.textContent = t || "";
    }
    function showDebug(t){
      debugEl.style.display = "block";
      debugEl.textContent = t || "";
    }
    function hideDebug(){
      debugEl.style.display = "none";
      debugEl.textContent = "";
    }

    /* ========= Materials UI ========= */
    function updateMaterialUI(){
      matCountEl.textContent = `${materials.length} objekt`;
      matListEl.innerHTML = "";

      if(materials.length === 0){
        matHintEl.textContent = "Inga bilagor √§nnu.";
        return;
      }
      matHintEl.textContent = "Bilder kan OCR:as. Textfiler kan l√§ggas in i materialf√§ltet.";

      for(const m of materials){
        const row = document.createElement("div");
        row.className = "item";

        const meta = document.createElement("div");
        meta.className = "meta";

        const name = document.createElement("div");
        name.className = "name";
        name.textContent = m.name;

        const desc = document.createElement("div");
        desc.className = "desc";
        desc.textContent = `${m.type.toUpperCase()} ‚Ä¢ ${(m.size/1024).toFixed(1)} KB`;

        meta.appendChild(name);
        meta.appendChild(desc);

        const actions = document.createElement("div");
        actions.className = "itemActions";

        if(m.type === "image"){
          const preview = document.createElement("button");
          preview.type="button";
          preview.className="tinyBtn";
          preview.textContent="OCR / f√∂rhandsvisa";
          preview.addEventListener("click", () => openOcrPanel(m));
          actions.appendChild(preview);
        }

        if(m.type === "text" && m.contentText){
          const insert = document.createElement("button");
          insert.type="button";
          insert.className="tinyBtn";
          insert.textContent="L√§gg i material";
          insert.addEventListener("click", () => {
            const cur = pastedTextEl.value.trim();
            const add = m.contentText.trim();
            pastedTextEl.value = (cur ? (cur + "\n\n") : "") + add;
            setStatus("Text fr√•n fil inlagd i materialf√§ltet.", "ok");
            $("material").scrollIntoView({behavior:"smooth", block:"start"});
          });
          actions.appendChild(insert);
        }

        const remove = document.createElement("button");
        remove.type="button";
        remove.className="tinyBtn danger";
        remove.textContent="Ta bort";
        remove.addEventListener("click", () => {
          const idx = materials.findIndex(x => x.id === m.id);
          if(idx >= 0) materials.splice(idx, 1);
          updateMaterialUI();
        });
        actions.appendChild(remove);

        row.appendChild(meta);
        row.appendChild(actions);
        matListEl.appendChild(row);
      }
    }

    async function addSelectedFiles(fileList){
      const files = Array.from(fileList || []);
      for(const f of files){
        const ext = (f.name.split(".").pop() || "").toLowerCase();
        const isText = f.type.startsWith("text/") || ["txt","md","csv","json"].includes(ext);
        const isImage = f.type.startsWith("image/");
        if(isText){
          const text = await f.text();
          materials.push({ id: makeId(), type:"text", name:f.name, size:f.size, contentText:text });
        } else if(isImage){
          const dataUrl = await new Promise((resolve, reject) => {
            const r = new FileReader();
            r.onload = () => resolve(String(r.result));
            r.onerror = reject;
            r.readAsDataURL(f);
          });
          materials.push({ id: makeId(), type:"image", name:f.name, size:f.size, dataUrl });
        } else {
          materials.push({ id: makeId(), type:"file", name:f.name, size:f.size });
        }
      }
      updateMaterialUI();
      setStatus("Bilagor tillagda i materiallistan.", "ok");
    }

    fileInput.addEventListener("change", async () => {
      hideDebug();
      try{
        await addSelectedFiles(fileInput.files);
        fileInput.value = "";
      }catch(e){
        setStatus("Kunde inte l√§sa fil.", "bad");
        showDebug(String(e));
      }
    });

    /* ========= OCR panel (multimodal) ========= */
    let activeOcrImage = null;

    function openOcrPanel(imageItem){
      activeOcrImage = imageItem;
      ocrPanel.style.display = "block";
      ocrPreviewImg.src = imageItem.dataUrl;
      ocrText.value = "";
      ocrAppendBtn.disabled = true;
      ocrStatus.className = "status";
      ocrStatus.textContent = "F√∂rhandsvisning klar. K√∂r OCR f√∂r att extrahera text.";
      qualityBadges.innerHTML = "";

      // Quality checks
      runQualityChecks(imageItem.dataUrl).then((q) => renderQualityBadges(q)).catch(()=>{});
      ocrPanel.scrollIntoView({behavior:"smooth", block:"start"});
    }

    ocrCloseBtn.addEventListener("click", () => {
      ocrPanel.style.display = "none";
      activeOcrImage = null;
      ocrPreviewImg.src = "";
      ocrText.value = "";
      qualityBadges.innerHTML = "";
      ocrStatus.textContent = "";
      ocrAppendBtn.disabled = true;
    });

    async function runQualityChecks(dataUrl){
      const img = await loadImage(dataUrl);
      const w = img.naturalWidth || img.width;
      const h = img.naturalHeight || img.height;

      // draw to canvas for brightness/contrast estimate
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d", { willReadFrequently: true });
      canvas.width = Math.min(w, 1200);
      canvas.height = Math.round(canvas.width * (h / w));
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      const { data } = ctx.getImageData(0, 0, canvas.width, canvas.height);

      // compute brightness mean and variance (rough)
      let sum = 0, sum2 = 0;
      for(let i=0;i<data.length;i+=4){
        const r=data[i], g=data[i+1], b=data[i+2];
        const y = 0.2126*r + 0.7152*g + 0.0722*b;
        sum += y;
        sum2 += y*y;
      }
      const n = data.length/4;
      const mean = sum/n;
      const varr = Math.max(0, (sum2/n) - (mean*mean));
      const std = Math.sqrt(varr);

      // heuristics
      const resolutionOk = (w >= 1200 || h >= 1200);
      const brightnessOk = (mean >= 70 && mean <= 210);
      const contrastOk = (std >= 35);

      return {
        width:w, height:h,
        resolutionOk,
        brightnessOk,
        contrastOk,
        mean:Math.round(mean),
        std:Math.round(std)
      };
    }

    function renderQualityBadges(q){
      const badges = [];
      badges.push(q.resolutionOk
        ? {t:`Uppl√∂sning OK (${q.width}√ó${q.height})`, c:"ok"}
        : {t:`L√•g uppl√∂sning (${q.width}√ó${q.height})`, c:"warn"}
      );
      badges.push(q.brightnessOk
        ? {t:`Ljusstyrka OK (‚âà${q.mean})`, c:"ok"}
        : {t:`Ljusstyrka avvikande (‚âà${q.mean})`, c:"warn"}
      );
      badges.push(q.contrastOk
        ? {t:`Kontrast OK (‚âà${q.std})`, c:"ok"}
        : {t:`L√•g kontrast (‚âà${q.std})`, c:"warn"}
      );

      qualityBadges.innerHTML = "";
      badges.forEach(b=>{
        const el = document.createElement("div");
        el.className = "badge " + (b.c || "");
        el.textContent = b.t;
        qualityBadges.appendChild(el);
      });

      // extra guidance
      if(!q.resolutionOk || !q.brightnessOk || !q.contrastOk){
        ocrStatus.className = "status warn";
        ocrStatus.textContent = "Kvalitet kan vara f√∂r l√•g f√∂r bra OCR. Testa: mer ljus, n√§rmare, och att sidan fyller bilden.";
      }
    }

    function loadImage(dataUrl){
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = dataUrl;
      });
    }

    ocrRunBtn.addEventListener("click", async () => {
      hideDebug();
      if(!activeOcrImage){
        ocrStatus.className = "status bad";
        ocrStatus.textContent = "Ingen bild vald.";
        return;
      }
      setBusy(true, "K√∂r OCR...");
      ocrStatus.className = "status";
      ocrStatus.textContent = "OCR p√•g√•r...";
      ocrAppendBtn.disabled = true;

      try{
        const lang = langToggleEl.checked ? "en" : "sv";
        const r = await postJson("/api/ocr", {
          imageDataUrl: activeOcrImage.dataUrl,
          lang
        });

        if(!r.ok || !r.data){
          setBusy(false, "Redo.");
          ocrStatus.className = "status bad";
          ocrStatus.textContent = `OCR fel (HTTP ${r.status}).`;
          showDebug(r.raw);
          return;
        }

        // Expected shape: { ok:true, text:"...", warnings:[...] }
        if(!r.data.ok){
          setBusy(false, "Redo.");
          ocrStatus.className = "status bad";
          ocrStatus.textContent = "OCR misslyckades.";
          showDebug(r.raw);
          return;
        }

        const text = String(r.data.text || "").trim();
        ocrText.value = text;
        ocrAppendBtn.disabled = text.length === 0;

        const warnings = Array.isArray(r.data.warnings) ? r.data.warnings : [];
        if(text.length === 0){
          ocrStatus.className = "status warn";
          ocrStatus.textContent = "OCR gav tom text. Prova en skarpare bild med b√§ttre ljus.";
        } else if(warnings.length){
          ocrStatus.className = "status warn";
          ocrStatus.textContent = "OCR klar med varningar. Granska texten innan du l√§gger till.";
        } else {
          ocrStatus.className = "status ok";
          ocrStatus.textContent = "OCR klar. Granska och l√§gg till i materialet.";
        }

        setBusy(false, "Redo.");
      }catch(e){
        setBusy(false, "Redo.");
        ocrStatus.className = "status bad";
        ocrStatus.textContent = "OCR fel.";
        showDebug(String(e));
      }
    });

    ocrAppendBtn.addEventListener("click", () => {
      const add = ocrText.value.trim();
      if(!add){
        ocrStatus.className = "status warn";
        ocrStatus.textContent = "Ingen text att l√§gga till.";
        return;
      }
      const cur = pastedTextEl.value.trim();
      pastedTextEl.value = (cur ? (cur + "\n\n") : "") + add;
      ocrStatus.className = "status ok";
      ocrStatus.textContent = "OCR-text tillagd i materialf√§ltet.";
      ocrAppendBtn.disabled = true;
      $("material").scrollIntoView({behavior:"smooth", block:"start"});
    });

    /* ========= Exam rendering + voice input ========= */
    function supportsSpeech(){
      return ("webkitSpeechRecognition" in window) || ("SpeechRecognition" in window);
    }

    function createMicButton(textarea){
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "tinyBtn";
      btn.textContent = "üé§";
      btn.title = "Tala ditt svar (tal-till-text)";
      btn.style.padding = "8px 10px";

      if(!supportsSpeech()){
        btn.disabled = true;
        btn.title = "Tal-till-text st√∂ds inte i denna webbl√§sare.";
        return btn;
      }

      btn.addEventListener("click", () => {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const rec = new SpeechRecognition();
        rec.lang = langToggleEl.checked ? "en-US" : "sv-SE";
        rec.interimResults = true;
        rec.continuous = false;

        btn.disabled = true;
        btn.textContent = "‚Ä¶";

        let finalText = "";

        rec.onresult = (event) => {
          let interim = "";
          for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) finalText += transcript + " ";
            else interim += transcript;
          }
          const base = textarea.value.trim();
          const combined = (base ? base + " " : "") + (finalText + interim).trim();
          textarea.value = combined;
        };

        rec.onerror = () => {
          btn.disabled = false;
          btn.textContent = "üé§";
        };
        rec.onend = () => {
          btn.disabled = false;
          btn.textContent = "üé§";
        };

        rec.start();
      });

      return btn;
    }

    function renderExam(exam){
      currentExam = exam;
      lastResult = null;

      exportExamBtn.disabled = false;
      exportResultBtn.disabled = true;

      const qs = Array.isArray(exam.questions) ? exam.questions : [];
      examMetaEl.textContent = `${exam.title || "Mockprov"} ‚Ä¢ Niv√•: ${exam.level || "‚Äî"} ‚Ä¢ Fr√•gor: ${qs.length}`;
      examBodyEl.innerHTML = "";

      qs.forEach((q, idx) => {
        const box = document.createElement("div");
        box.className = "qBox";

        const top = document.createElement("div");
        top.style.display = "flex";
        top.style.alignItems = "center";
        top.style.justifyContent = "space-between";
        top.style.gap = "10px";
        top.style.flexWrap = "wrap";

        const meta = document.createElement("div");
        meta.className = "qMeta";
        meta.textContent = `ID: ${q.id ?? (idx+1)} ‚Ä¢ Po√§ng: ${q.points ?? "‚Äî"}`;

        const micSlot = document.createElement("div");
        micSlot.className = "noPrint";
        micSlot.style.display = "flex";
        micSlot.style.gap = "8px";
        micSlot.style.alignItems = "center";

        const text = document.createElement("div");
        text.className = "qText";
        text.textContent = q.question ?? "";

        const answer = document.createElement("textarea");
        answer.className = "answer";
        answer.placeholder = langToggleEl.checked ? "Write your answer here..." : "Skriv ditt svar h√§r...";
        answer.dataset.qid = String(q.id ?? (idx+1));

        const micBtn = createMicButton(answer);
        micSlot.appendChild(micBtn);

        top.appendChild(meta);
        top.appendChild(micSlot);

        box.appendChild(top);
        box.appendChild(text);
        box.appendChild(answer);
        examBodyEl.appendChild(box);
      });

      gradeBtn.disabled = qs.length === 0;
    }

    function renderResult(r){
      lastResult = r;
      exportResultBtn.disabled = false;

      resultMetaEl.textContent = `R√§ttning: ${r.total_points}/${r.max_points}`;
      const wrap = document.createElement("div");

      (r.per_question || []).forEach(item => {
        const d = document.createElement("div");
        d.className = "qBox";

        const model = String(item.model_answer || "").trim();
        const full = model
          ? `<div style="margin-top:10px;border-top:1px solid rgba(11,31,58,.12);padding-top:10px">
               <div style="font-weight:1100;color:#0B1F3A;margin-bottom:6px;font-size:13px">Vad som ger full po√§ng (modellsvar)</div>
               <div style="white-space:pre-wrap;font-weight:800;line-height:1.45">${escapeHtml(model)}</div>
             </div>`
          : "";

        d.innerHTML = `
          <div class="qMeta">ID: ${escapeHtml(item.id)} ‚Ä¢ ${item.points}/${item.max_points}</div>
          <div style="font-weight:850;line-height:1.45">${escapeHtml(item.feedback || "")}</div>
          ${full}
        `;
        wrap.appendChild(d);
      });

      resultBodyEl.innerHTML = "";
      resultBodyEl.appendChild(wrap);
    }

    /* ========= Adaptive learning (local profile) ========= */
    const PROFILE_KEY = "provklar_profile_v1";

    function loadProfile(){
      try{
        const raw = localStorage.getItem(PROFILE_KEY);
        if(!raw) return { tags:{}, attempts:0, lastUpdated:0 };
        const obj = JSON.parse(raw);
        if(!obj || typeof obj !== "object") return { tags:{}, attempts:0, lastUpdated:0 };
        if(!obj.tags) obj.tags = {};
        if(!obj.attempts) obj.attempts = 0;
        return obj;
      }catch{
        return { tags:{}, attempts:0, lastUpdated:0 };
      }
    }
    function saveProfile(p){
      localStorage.setItem(PROFILE_KEY, JSON.stringify(p));
    }

    function updateProfileFromResult(exam, result){
      // Expected: exam.questions may include tags per question (optional)
      // If no tags exist, fallback to course bucket.
      const p = loadProfile();
      p.attempts += 1;
      p.lastUpdated = Date.now();

      const qMap = new Map();
      (exam.questions || []).forEach(q => qMap.set(String(q.id), q));

      (result.per_question || []).forEach(item => {
        const q = qMap.get(String(item.id));
        const tags = Array.isArray(q?.tags) && q.tags.length ? q.tags : [ (courseEl.value.trim() || "Allm√§nt") ];
        const maxP = Number(item.max_points || 0) || 0;
        const gotP = Number(item.points || 0) || 0;
        const miss = Math.max(0, maxP - gotP);

        tags.forEach(t => {
          const key = String(t);
          if(!p.tags[key]) p.tags[key] = { miss:0, total:0, seen:0 };
          p.tags[key].miss += miss;
          p.tags[key].total += maxP;
          p.tags[key].seen += 1;
        });
      });

      saveProfile(p);
      renderCoaching();
    }

    function renderCoaching(){
      const p = loadProfile();
      const entries = Object.entries(p.tags || {});
      if(!entries.length){
        weaknessesEl.textContent = "Ingen data √§nnu.";
        nextSessionEl.textContent = "Skapa och r√§tta minst ett prov f√∂r att f√• rekommendationer.";
        return;
      }

      // score = miss/total (higher = worse)
      const scored = entries.map(([tag, v]) => {
        const total = Math.max(1, Number(v.total || 1));
        const miss = Number(v.miss || 0);
        const ratio = miss / total;
        return { tag, ratio, seen: Number(v.seen||0) };
      }).sort((a,b)=> b.ratio - a.ratio);

      const top = scored.slice(0,3);
      weaknessesEl.innerHTML = top.map(x => `‚Ä¢ ${escapeHtml(x.tag)} (sv√•righet ‚âà ${(x.ratio*100).toFixed(0)}%)`).join("\n");

      // next session suggestion
      const focus = top.map(x=>x.tag);
      nextSessionEl.textContent =
        `Fokus: ${focus.join(", ")}. Skapa ett nytt prov p√• samma niv√• och f√∂rs√∂k att inkludera fler definitioner, samband och exempel i svaren.`;
    }

    resetCoachBtn.addEventListener("click", () => {
      localStorage.removeItem(PROFILE_KEY);
      renderCoaching();
      setStatus("Statistik nollst√§lld.", "ok");
    });

    /* ========= Export (PDF via print) ========= */
    function exportMode(mode){
      // mode: "exam" or "result"
      // hide/show by adding a temporary attribute
      document.body.setAttribute("data-export", mode);

      // For print: keep everything visible, but user can choose what to print by collapsing sections if needed.
      // Here we just scroll to relevant section and print.
      if(mode === "exam") $("exam").scrollIntoView({behavior:"instant", block:"start"});
      if(mode === "result") $("result").scrollIntoView({behavior:"instant", block:"start"});

      exportStatus.className = "status ok";
      exportStatus.textContent = "√ñppnar utskriftsdialog. V√§lj ‚ÄúSpara som PDF‚Äù.";
      setTimeout(() => window.print(), 150);
      setTimeout(() => {
        document.body.removeAttribute("data-export");
      }, 600);
    }
    exportExamBtn.addEventListener("click", () => {
      if(!currentExam) return;
      exportMode("exam");
    });
    exportResultBtn.addEventListener("click", () => {
      if(!lastResult) return;
      exportMode("result");
    });

    /* ========= Core app flow ========= */
    function clearExam(){
      currentExam = null;
      examMetaEl.textContent = "Ingen provdata √§nnu.";
      examBodyEl.innerHTML = "";
      gradeBtn.disabled = true;
      exportExamBtn.disabled = true;
    }
    function clearResult(){
      lastResult = null;
      resultMetaEl.textContent = "Ingen r√§ttning √§nnu.";
      resultBodyEl.innerHTML = "";
      exportResultBtn.disabled = true;
    }

    generateBtn.addEventListener("click", async () => {
      hideDebug();
      clearResult();
      clearExam();

      const pastedText = pastedTextEl.value.trim();
      if(!pastedText){
        setStatus(langToggleEl.checked ? "Paste material first." : "Klistra in material f√∂rst.", "bad");
        $("material").scrollIntoView({behavior:"smooth", block:"start"});
        return;
      }

      setBusy(true, langToggleEl.checked ? "Generating mock exam..." : "Skapar mockprov...");
      setStatus(langToggleEl.checked ? "Generating..." : "Skapar mockprov...", "");

      try{
        const lang = langToggleEl.checked ? "en" : "sv";
        const r = await postJson("/api/generate-exam", {
          lang,
          level: levelEl.value,
          course: courseEl.value.trim(),
          pastedText,
          // Optional: include material summaries (lightweight metadata only)
          materials: materials.map(m => ({ type:m.type, name:m.name }))
        });

        if(!r.ok || !r.data || !r.data.ok){
          setBusy(false, "Redo.");
          setStatus(`Fel vid generering (HTTP ${r.status}).`, "bad");
          showDebug(r.raw);
          return;
        }

        renderExam(r.data.exam);
        setBusy(false, "Redo.");
        setStatus(langToggleEl.checked ? "Mock exam ready." : "Mockprov klart.", "ok");
        $("exam").scrollIntoView({behavior:"smooth", block:"start"});
      }catch(e){
        setBusy(false, "Redo.");
        setStatus(langToggleEl.checked ? "Generation error." : "Fel vid generering.", "bad");
        showDebug(String(e));
      }
    });

    gradeBtn.addEventListener("click", async () => {
      hideDebug();
      clearResult();

      if(!currentExam || !Array.isArray(currentExam.questions) || currentExam.questions.length===0){
        setStatus(langToggleEl.checked ? "Generate an exam first." : "Skapa mockprov f√∂rst.", "bad");
        return;
      }

      const answers = Array.from(document.querySelectorAll("textarea.answer"))
        .map(el => ({ id: el.dataset.qid, answer: el.value.trim() }));

      setBusy(true, langToggleEl.checked ? "Grading..." : "R√§ttar prov...");
      setStatus(langToggleEl.checked ? "Grading..." : "R√§ttar prov...", "");

      try{
        const lang = langToggleEl.checked ? "en" : "sv";
        const r = await postJson("/api/grade", {
          lang,
          level: levelEl.value,
          course: courseEl.value.trim(),
          pastedText: pastedTextEl.value.trim(),
          questions: currentExam.questions,
          answers
        });

        if(!r.ok || !r.data || !r.data.ok){
          setBusy(false, "Redo.");
          setStatus(`Fel vid r√§ttning (HTTP ${r.status}).`, "bad");
          showDebug(r.raw);
          return;
        }

        renderResult(r.data.result);

        // Update adaptive profile (local)
        updateProfileFromResult(currentExam, r.data.result);

        setBusy(false, "Redo.");
        setStatus(langToggleEl.checked ? "Grading complete." : "R√§ttning klar.", "ok");
        $("result").scrollIntoView({behavior:"smooth", block:"start"});
      }catch(e){
        setBusy(false, "Redo.");
        setStatus(langToggleEl.checked ? "Grading error." : "Fel vid r√§ttning.", "bad");
        showDebug(String(e));
      }
    });

    clearBtn.addEventListener("click", () => {
      hideDebug();
      pastedTextEl.value = "";
      courseEl.value = "";
      levelEl.value = "C";
      langToggleEl.checked = false;

      materials.length = 0;
      updateMaterialUI();

      ocrPanel.style.display = "none";
      activeOcrImage = null;
      ocrPreviewImg.src = "";
      ocrText.value = "";
      qualityBadges.innerHTML = "";
      ocrStatus.textContent = "";
      ocrAppendBtn.disabled = true;

      clearExam();
      clearResult();
      setStatus("");
      exportStatus.textContent = "";
      renderCoaching();

      $("material").scrollIntoView({behavior:"smooth", block:"start"});
    });

    /* ========= Init ========= */
    updateMaterialUI();
    renderCoaching();
    setBusy(false, "Redo.");
    setStatus("");
  </script>
</body>
</html>
