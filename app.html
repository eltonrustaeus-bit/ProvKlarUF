<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ProvKlar – App</title>
  <meta name="description" content="ProvKlar – material → mockprov → rättning + modellsvar." />
  <style>
    :root{
      --navy:#0B1F3A; --teal:#18B88A; --bg:#F6F8FB; --muted:#556072; --border:rgba(11,31,58,.12);
      --shadow:0 18px 50px rgba(11,31,58,.14); --radius:18px; --font:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      --danger:#8b1d1d; --ok:#0f7a5a; --warn:#946200; --max:1080px;
    }
    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    :target{scroll-margin-top:92px}
    body{
      margin:0;font-family:var(--font);background:
        radial-gradient(900px 450px at 20% -10%, rgba(24,184,138,.18), transparent 60%),
        radial-gradient(700px 380px at 95% 20%, rgba(24,184,138,.10), transparent 55%),
        var(--bg);
      color:#0C1220;
    }
    a{text-decoration:none;color:inherit}
    header{
      background:rgba(255,255,255,.86);backdrop-filter:saturate(140%) blur(10px);
      border-bottom:1px solid var(--border);position:sticky;top:0;z-index:1000;
    }
    .wrap{max-width:var(--max);margin:0 auto;padding:clamp(14px,3vw,22px)}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:14px}
    .brand{display:flex;align-items:center;gap:12px;min-width:0}
    .brand img{height:54px;width:auto;display:block}
    .brand .name{font-weight:1000;color:var(--navy);font-size:18px;line-height:1.05}
    .brand .tag{margin-top:3px;color:var(--muted);font-weight:800;font-size:12px}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;
      padding:12px 16px;border-radius:14px;
      font-weight:1000;font-size:14px;border:1px solid var(--border);
      cursor:pointer;white-space:nowrap;background:rgba(255,255,255,.92);color:var(--navy);
    }
    .btnPrimary{
      background:var(--teal);color:#fff;border-color:rgba(24,184,138,.28);
      box-shadow:0 14px 28px rgba(24,184,138,.22)
    }
    .btnGhost{background:#fff}
    .btnDanger{background:#fff;border-color:rgba(139,29,29,.22);color:var(--danger)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .card{
      background:rgba(255,255,255,.92);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:clamp(16px,3vw,22px);
      margin:14px 0;
      overflow:hidden;
      position:relative;
    }
    .card:before{
      content:"";
      position:absolute;inset:-70px -70px auto auto;
      width:190px;height:190px;border-radius:999px;
      background:radial-gradient(circle at 30% 30%, rgba(24,184,138,.16), transparent 60%);
      pointer-events:none;
    }
    .sectionTitle{
      margin:0 0 8px;font-weight:1100;letter-spacing:-.01em;color:var(--navy);
      font-size:16px;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .sectionSub{margin:0;color:var(--muted);font-weight:780;font-size:12px;line-height:1.35}
    label{display:block;margin:12px 0 6px;font-weight:1000;color:var(--navy);font-size:13px}
    select,input,textarea{
      width:100%;padding:12px;border-radius:14px;border:1px solid var(--border);background:#fff;
      font-family:inherit;font-size:14px;outline:none;
    }
    textarea{min-height:165px;resize:vertical}
    input:focus, textarea:focus, select:focus{border-color:rgba(24,184,138,.45);box-shadow:0 0 0 5px rgba(24,184,138,.14)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:920px){ .grid2{grid-template-columns:1fr} }
    .status{margin-top:10px;color:var(--muted);font-weight:850;font-size:12px;line-height:1.35;word-break:break-word}
    .status.ok{color:var(--ok)} .status.bad{color:var(--danger)} .status.warn{color:var(--warn)}
    pre{
      margin:10px 0 0;padding:12px;border-radius:14px;border:1px solid var(--border);
      background:#fff;overflow:auto;font-size:12px;line-height:1.35;white-space:pre-wrap;word-break:break-word;display:none;
    }
    .spinner{width:16px;height:16px;border-radius:999px;border:2px solid rgba(11,31,58,.18);border-top-color:rgba(24,184,138,.95);animation:spin .8s linear infinite;display:none}
    @keyframes spin{to{transform:rotate(360deg)}}
    .qBox{margin-top:12px;padding:12px;border:1px solid rgba(11,31,58,.12);border-radius:16px;background:#fff}
    .qMeta{color:var(--muted);font-weight:900;font-size:12px;margin-bottom:6px}
    .qText{font-weight:900;color:#0C1220;line-height:1.45}
    footer{border-top:1px solid var(--border);padding:18px;text-align:center;color:var(--muted);font-size:12px;font-weight:750}
    .loginOverlay{
      position:fixed;inset:0;z-index:9999;
      background:
        radial-gradient(800px 420px at 20% 10%, rgba(24,184,138,.22), transparent 60%),
        radial-gradient(700px 380px at 90% 20%, rgba(24,184,138,.10), transparent 55%),
        linear-gradient(135deg, rgba(11,31,58,.98), rgba(11,31,58,.92));
      display:flex;align-items:center;justify-content:center;padding:18px;
    }
    .loginCard{
      width:min(580px, 100%);
      background:rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.22);
      border-radius:22px;
      box-shadow:0 24px 70px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .loginTop{display:flex;gap:14px;align-items:center;padding:18px 18px 10px}
    .loginTop img{height:68px;width:auto;display:block}
    .loginTop .ltTitle{font-weight:1000;color:var(--navy);font-size:20px;line-height:1.1}
    .loginTop .ltSub{margin-top:4px;color:var(--muted);font-weight:800;font-size:12px}
    .loginBody{padding:12px 18px 18px}
    .fieldLabel{display:block;font-weight:1000;color:var(--navy);font-size:13px;margin:10px 0 6px}
    .field{width:100%;padding:12px;border-radius:14px;border:1px solid var(--border);background:#fff;font-family:inherit;font-size:14px}
    .loginRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .err{margin-top:10px;color:var(--danger);font-weight:900;font-size:12px}
  </style>
</head>
<body>

  <!-- App lock -->
  <div id="loginScreen" class="loginOverlay">
    <div class="loginCard" role="dialog" aria-modal="true" aria-label="Åtkomstkod">
      <div class="loginTop">
        <img src="image/provklar-logo.png" alt="ProvKlar logga">
        <div>
          <div class="ltTitle">ProvKlar UF</div>
          <div class="ltSub">Åtkomst krävs för att använda appen</div>
        </div>
      </div>
      <div class="loginBody">
        <label class="fieldLabel" for="accessCode">Åtkomstkod</label>
        <input class="field" id="accessCode" type="password" placeholder="Skriv koden…" autocomplete="off" />
        <div class="loginRow">
          <button class="btn btnPrimary" type="button" id="unlockBtn">Lås upp</button>
          <a class="btn" href="index.html">Till infosidan</a>
          <button class="btn btnDanger" type="button" id="logoutBtn">Logga ut</button>
        </div>
        <div id="errorMsg" class="err" aria-live="polite"></div>
      </div>
    </div>
  </div>

  <header>
    <div class="wrap topbar">
      <a class="brand" href="index.html">
        <img src="image/provklar-logo.png" alt="ProvKlar logga">
        <div>
          <div class="name">ProvKlar</div>
          <div class="tag">Mockprov • Rättning • Modellsvar</div>
        </div>
      </a>

      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <a class="btn" href="#material">Material</a>
        <a class="btn" href="#exam">Mockprov</a>
        <a class="btn" href="#result">Rättning</a>
      </div>
    </div>
  </header>

  <main class="wrap">

    <section class="card" id="material">
      <div class="sectionTitle"><span>Steg 1 – Material</span></div>
      <p class="sectionSub">Klistra in provmaterial. Välj frågetyp och exakt antal frågor. Tryck “Skapa mockprov”.</p>

      <label for="pastedText">Material (klistra in text)</label>
      <textarea id="pastedText" placeholder="Rubriker → punktlista → definitioner/formler → exempel"></textarea>

      <div class="grid2" style="margin-top:12px">
        <div>
          <label for="level">Nivå</label>
          <select id="level">
            <option value="E">E</option>
            <option value="C" selected>C</option>
            <option value="A">A</option>
          </select>
        </div>
        <div>
          <label for="course">Ämne/kurs (valfritt)</label>
          <input id="course" placeholder="Ex: Matematik 2b / Historia 1b" />
        </div>
      </div>

      <div class="grid2" style="margin-top:12px">
        <div>
          <label for="qType">Frågetyp</label>
          <select id="qType">
            <option value="mix" selected>Blandat</option>
            <option value="mc">Flervalsfrågor</option>
            <option value="short">Kortsvar</option>
            <option value="essay">Essä</option>
          </select>
        </div>
        <div>
          <label for="numQuestions">Antal frågor</label>
          <select id="numQuestions">
            <option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option>
            <option>9</option><option>10</option><option>11</option><option selected>12</option>
          </select>
        </div>
      </div>

      <div class="status warn" id="formatHint" style="margin-top:12px">
        Tips: rubriker + punktlistor ger bättre frågor och mer exakt rättning.
      </div>
    </section>

    <section class="card" id="actions">
      <div class="sectionTitle"><span>Steg 2 – Skapa och rätta</span></div>
      <p class="sectionSub">AI genererar exakt antal frågor och rätt frågetyp utifrån dina val.</p>

      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
        <div class="spinner" id="spinner"></div>
        <span class="sectionSub" id="miniState">Redo.</span>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
        <button class="btn btnPrimary" id="generateExamBtn" type="button">Skapa mockprov</button>
        <button class="btn" id="gradeBtn" type="button" disabled>Rätta prov</button>
        <button class="btn btnGhost" id="clearBtn" type="button">Rensa</button>
      </div>

      <div class="status" id="status"></div>
      <pre id="debug"></pre>
    </section>

    <section class="card" id="exam">
      <div class="sectionTitle"><span>Steg 3 – Mockprov</span></div>
      <div class="status" id="examMeta">Ingen provdata ännu.</div>
      <div id="examBody"></div>
    </section>

    <section class="card" id="result">
      <div class="sectionTitle"><span>Steg 4 – Rättning</span></div>
      <div class="status" id="resultMeta">Ingen rättning ännu.</div>
      <div id="resultBody"></div>
    </section>

  </main>

  <footer>ProvKlar UF är studiestöd och ger ingen officiell betygssättning.</footer>

  <script>
    const $ = (id) => document.getElementById(id);

    // ===== App lock =====
    const CORRECT_CODE = "provklar123";
    function unlock(){
      const v = ($("accessCode").value || "").trim();
      if(v === CORRECT_CODE){
        localStorage.setItem("provklar_app_access","true");
        $("loginScreen").style.display = "none";
        $("errorMsg").textContent = "";
      } else {
        $("errorMsg").textContent = "Fel kod.";
      }
    }
    function lock(){
      localStorage.removeItem("provklar_app_access");
      $("loginScreen").style.display = "flex";
      $("accessCode").value = "";
      $("errorMsg").textContent = "";
    }
    $("unlockBtn").addEventListener("click", unlock);
    $("logoutBtn").addEventListener("click", () => { lock(); window.location.href="index.html"; });
    document.addEventListener("keydown", (e) => {
      if($("loginScreen").style.display !== "none" && e.key === "Enter") unlock();
    });
    if(localStorage.getItem("provklar_app_access") === "true"){
      $("loginScreen").style.display = "none";
    }

    // ===== UI state =====
    const spinnerEl = $("spinner");
    const miniStateEl = $("miniState");
    const statusEl = $("status");
    const debugEl = $("debug");

    const pastedTextEl = $("pastedText");
    const levelEl = $("level");
    const courseEl = $("course");
    const qTypeEl = $("qType");
    const numQuestionsEl = $("numQuestions");

    const generateExamBtn = $("generateExamBtn");
    const gradeBtn = $("gradeBtn");
    const clearBtn = $("clearBtn");

    const examMetaEl = $("examMeta");
    const examBodyEl = $("examBody");
    const resultMetaEl = $("resultMeta");
    const resultBodyEl = $("resultBody");

    let currentExam = null;
    let lastResult = null;

    function setBusy(isBusy, label){
      spinnerEl.style.display = isBusy ? "inline-block" : "none";
      miniStateEl.textContent = label || (isBusy ? "Arbetar…" : "Redo.");
      generateExamBtn.disabled = isBusy;
      gradeBtn.disabled = isBusy || !currentExam;
      clearBtn.disabled = isBusy;
    }
    function setStatus(txt, kind){
      statusEl.className = "status" + (kind ? (" " + kind) : "");
      statusEl.textContent = txt || "";
    }
    function showDebug(txt){
      debugEl.style.display = "block";
      debugEl.textContent = txt || "";
    }
    function hideDebug(){
      debugEl.style.display = "none";
      debugEl.textContent = "";
    }
    async function postJson(path, payload){
      const resp = await fetch(path, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      const raw = await resp.text();
      let data = null;
      try{ data = JSON.parse(raw); } catch {}
      return { ok: resp.ok, status: resp.status, raw, data };
    }
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function renderExam(exam){
      currentExam = exam;
      lastResult = null;

      const qs = Array.isArray(exam.questions) ? exam.questions : [];
      examMetaEl.textContent = `${exam.title || "Mockprov"} • Nivå: ${exam.level || "—"} • Frågor: ${qs.length}`;
      examBodyEl.innerHTML = "";

      qs.forEach((q, idx) => {
        const box = document.createElement("div");
        box.className = "qBox";

        const meta = document.createElement("div");
        meta.className = "qMeta";
        meta.textContent = `ID: ${q.id ?? (idx+1)} • Poäng: ${q.points ?? "—"} • Typ: ${q.type ?? qTypeEl.value}`;

        const text = document.createElement("div");
        text.className = "qText";
        text.textContent = q.question ?? "";

        const ans = document.createElement("textarea");
        ans.className = "answer";
        ans.placeholder = "Skriv ditt svar här…";
        ans.dataset.qid = String(q.id ?? (idx+1));
        ans.style.minHeight = (String(q.type||"").includes("essay") || String(q.type||"").includes("essä")) ? "150px" : "110px";

        // Om flerval: visa alternativen
        if(Array.isArray(q.options) && q.options.length){
          const opt = document.createElement("div");
          opt.className = "status";
          opt.style.marginTop = "8px";
          opt.innerHTML = q.options.map((o,i)=>`<div><b>${String.fromCharCode(65+i)}.</b> ${escapeHtml(o)}</div>`).join("");
          box.appendChild(meta); box.appendChild(text); box.appendChild(opt); box.appendChild(ans);
        } else {
          box.appendChild(meta); box.appendChild(text); box.appendChild(ans);
        }

        examBodyEl.appendChild(box);
      });

      gradeBtn.disabled = qs.length === 0;
    }

    function renderResult(r){
      lastResult = r;
      resultMetaEl.textContent = `Rättning: ${r.total_points}/${r.max_points}`;
      const wrap = document.createElement("div");

      (r.per_question || []).forEach(item => {
        const d = document.createElement("div");
        d.className = "qBox";

        const model = String(item.model_answer || "").trim();
        const full = model
          ? `<div style="margin-top:10px;border-top:1px solid rgba(11,31,58,.12);padding-top:10px">
               <div style="font-weight:1100;color:#0B1F3A;margin-bottom:6px;font-size:13px">Vad som ger full poäng (modellsvar)</div>
               <div style="white-space:pre-wrap;font-weight:800;line-height:1.45">${escapeHtml(model)}</div>
             </div>`
          : "";

        d.innerHTML = `
          <div class="qMeta">ID: ${escapeHtml(item.id)} • ${item.points}/${item.max_points}</div>
          <div style="font-weight:850;line-height:1.45">${escapeHtml(item.feedback || "")}</div>
          ${full}
        `;
        wrap.appendChild(d);
      });

      resultBodyEl.innerHTML = "";
      resultBodyEl.appendChild(wrap);
    }

    function clearAll(){
      pastedTextEl.value = "";
      courseEl.value = "";
      levelEl.value = "C";
      qTypeEl.value = "mix";
      numQuestionsEl.value = "12";

      currentExam = null;
      lastResult = null;
      examMetaEl.textContent = "Ingen provdata ännu.";
      examBodyEl.innerHTML = "";
      resultMetaEl.textContent = "Ingen rättning ännu.";
      resultBodyEl.innerHTML = "";
      gradeBtn.disabled = true;

      setStatus("Rensat.", "ok");
      hideDebug();
    }

    generateExamBtn.addEventListener("click", async () => {
      hideDebug();
      const pastedText = pastedTextEl.value.trim();
      if(!pastedText){
        setStatus("Klistra in material först.", "bad");
        document.querySelector("#material").scrollIntoView({behavior:"smooth"});
        return;
      }

      const payload = {
        lang:"sv",
        level: levelEl.value,
        course: courseEl.value.trim(),
        qType: qTypeEl.value,
        pastedText,
        numQuestions: Number(numQuestionsEl.value)
      };

      setBusy(true, "Skapar mockprov…");
      setStatus(`Skapar mockprov… (${payload.qType}, ${payload.numQuestions} frågor)`, "");

      const res = await postJson("/api/generate-exam", payload);
      if(!res.ok || !res.data || !res.data.ok){
        setBusy(false, "Redo.");
        setStatus(`Fel vid generering (HTTP ${res.status}).`, "bad");
        showDebug(res.raw);
        return;
      }

      renderExam(res.data.exam);
      setBusy(false, "Redo.");
      setStatus("Mockprov klart.", "ok");
      document.querySelector("#exam").scrollIntoView({behavior:"smooth"});
    });

    gradeBtn.addEventListener("click", async () => {
      hideDebug();
      if(!currentExam || !Array.isArray(currentExam.questions) || currentExam.questions.length === 0){
        setStatus("Skapa mockprov först.", "bad");
        return;
      }

      const answers = Array.from(document.querySelectorAll("textarea.answer"))
        .map(el => ({ id: el.dataset.qid, answer: el.value.trim() }));

      const payload = {
        lang:"sv",
        level: levelEl.value,
        course: courseEl.value.trim(),
        qType: qTypeEl.value,
        pastedText: pastedTextEl.value.trim(),
        questions: currentExam.questions,
        answers
      };

      setBusy(true, "Rättar prov…");
      setStatus("Rättar prov…", "");

      const res = await postJson("/api/grade", payload);
      if(!res.ok || !res.data || !res.data.ok){
        setBusy(false, "Redo.");
        setStatus(`Fel vid rättning (HTTP ${res.status}).`, "bad");
        showDebug(res.raw);
        return;
      }

      renderResult(res.data.result);
      setBusy(false, "Redo.");
      setStatus("Rättning klar.", "ok");
      document.querySelector("#result").scrollIntoView({behavior:"smooth"});
    });

    clearBtn.addEventListener("click", clearAll);

    setBusy(false, "Redo.");
    setStatus("");
  </script>
</body>
</html>
