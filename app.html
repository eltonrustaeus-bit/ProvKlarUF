<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ProvKlar – App</title>
  <meta name="description" content="ProvKlar – skapa mockprov, skriv svar och få rättning + tips." />
  <style>
    :root{
      --navy:#0B1F3A;
      --teal:#18B88A;
      --bg:#F6F8FB;
      --card:#FFFFFF;
      --muted:#556072;
      --border:rgba(11,31,58,.12);
      --shadow:0 18px 50px rgba(11,31,58,.14);
      --radius:18px;
      --font:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      --max:980px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:var(--font);background:radial-gradient(900px 450px at 20% -10%, rgba(24,184,138,.18), transparent 60%), var(--bg);color:#0C1220}
    a{text-decoration:none;color:inherit}
    header{background:rgba(255,255,255,.86);backdrop-filter:saturate(140%) blur(10px);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:5}
    .wrap{max-width:var(--max);margin:0 auto;padding:clamp(14px,3vw,22px)}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:14px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:12px;min-width:0}
    .brand img{height:56px;width:auto;display:block}
    .brand .name{font-weight:1000;color:var(--navy);font-size:18px;line-height:1.05}
    .brand .tag{margin-top:3px;color:var(--muted);font-weight:800;font-size:12px}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;
      padding:12px 16px;border-radius:14px;
      font-weight:1000;font-size:14px;border:1px solid transparent;
      cursor:pointer;white-space:nowrap
    }
    .btnPrimary{background:var(--teal);color:#fff;border-color:rgba(24,184,138,.28);box-shadow:0 14px 28px rgba(24,184,138,.22)}
    .btnGhost{background:rgba(255,255,255,.9);color:var(--navy);border-color:var(--border)}
    .btnDanger{background:#fff;color:#8b1d1d;border-color:rgba(139,29,29,.25)}
    .card{
      background:rgba(255,255,255,.92);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:clamp(16px,3vw,22px);
      margin:14px 0;
      overflow:hidden;
      position:relative;
    }
    .card:before{
      content:"";
      position:absolute;inset:-70px -70px auto auto;
      width:190px;height:190px;border-radius:999px;
      background:radial-gradient(circle at 30% 30%, rgba(24,184,138,.18), transparent 60%);
      pointer-events:none;
    }
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:820px){.grid{grid-template-columns:1fr}}
    label{display:block;margin:12px 0 6px;font-weight:1000;color:var(--navy);font-size:13px}
    select,input,textarea{
      width:100%;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      font-family:inherit;
      font-size:14px;
    }
    textarea{min-height:130px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
    .status{margin-top:10px;color:var(--muted);font-weight:850;font-size:12px;line-height:1.35;word-break:break-word}
    pre{
      margin:10px 0 0;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      overflow:auto;
      font-size:12px;
      line-height:1.35;
      white-space:pre-wrap;
      word-break:break-word;
      display:none;
    }
    .q{
      border:1px solid var(--border);
      border-radius:16px;
      padding:14px;
      background:#fff;
      margin-top:10px;
    }
    .q .meta{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px;color:var(--muted);font-size:12px;font-weight:900}
    .q .text{margin:0 0 10px;font-weight:850;color:#0C1220;line-height:1.45}
    footer{border-top:1px solid var(--border);padding:18px;text-align:center;color:var(--muted);font-size:12px;font-weight:750}

    /* LOGIN OVERLAY (same as index) */
    .loginOverlay{
      position:fixed;inset:0;z-index:9999;
      background:
        radial-gradient(800px 420px at 20% 10%, rgba(24,184,138,.22), transparent 60%),
        radial-gradient(700px 380px at 90% 20%, rgba(24,184,138,.10), transparent 55%),
        linear-gradient(135deg, rgba(11,31,58,.98), rgba(11,31,58,.92));
      display:flex;align-items:center;justify-content:center;
      padding:18px;
    }
    .loginCard{
      width:min(520px, 100%);
      background:rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.22);
      border-radius:22px;
      box-shadow:0 24px 70px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .loginTop{display:flex;gap:14px;align-items:center;padding:18px 18px 10px 18px}
    .loginTop img{height:68px;width:auto;display:block}
    .loginTop .ltTitle{font-weight:1000;color:var(--navy);font-size:20px;line-height:1.1}
    .loginTop .ltSub{margin-top:4px;color:var(--muted);font-weight:800;font-size:12px}
    .loginBody{padding:12px 18px 18px 18px}
    .fieldLabel{display:block;font-weight:1000;color:var(--navy);font-size:13px;margin:10px 0 6px}
    .field{width:100%;padding:12px;border-radius:14px;border:1px solid var(--border);background:#fff;font-family:inherit;font-size:14px}
    .loginRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .err{margin-top:10px;color:#8b1d1d;font-weight:900;font-size:12px}
    .hint{margin-top:10px;color:var(--muted);font-weight:800;font-size:12px;line-height:1.35}
    .kbd{display:inline-flex;align-items:center;justify-content:center;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#fff;color:var(--navy);font-weight:1000;font-size:11px}
  </style>
</head>
<body>

  <!-- LOGIN OVERLAY -->
  <div id="loginScreen" class="loginOverlay" aria-hidden="false">
    <div class="loginCard" role="dialog" aria-modal="true" aria-label="Åtkomstkod">
      <div class="loginTop">
        <img src="image/provklar-logo.png" alt="ProvKlar UF logga">
        <div>
          <div class="ltTitle">ProvKlar UF</div>
          <div class="ltSub">Åtkomst krävs för att fortsätta</div>
        </div>
      </div>
      <div class="loginBody">
        <label class="fieldLabel" for="accessCode">Åtkomstkod</label>
        <input class="field" id="accessCode" type="password" placeholder="Skriv koden…" autocomplete="off" />
        <div class="loginRow">
          <button class="btn btnPrimary" type="button" onclick="checkCode()">Lås upp</button>
          <button class="btn btnGhost" type="button" onclick="logout()">Rensa</button>
        </div>
        <div id="errorMsg" class="err" aria-live="polite"></div>
        <div class="hint">Tips: tryck <span class="kbd">Enter</span> efter att du skrivit koden.</div>
      </div>
    </div>
  </div>

  <header>
    <div class="wrap topbar">
      <a class="brand" href="index.html" aria-label="Till startsidan">
        <img src="image/provklar-logo.png" alt="ProvKlar UF logga">
        <div>
          <div class="name">ProvKlar</div>
          <div class="tag">Skapa • Svara • Rätta</div>
        </div>
      </a>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <a class="btn btnGhost" href="index.html">Startsida</a>
        <button class="btn btnDanger" type="button" onclick="forceLogout()">Logga ut</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="grid">
        <div>
          <label for="level">Nivå</label>
          <select id="level">
            <option value="E">E</option>
            <option value="C" selected>C</option>
            <option value="A">A</option>
          </select>

          <label for="course">Ämne/kurs (valfritt)</label>
          <input id="course" placeholder="Ex: Matematik 2b" />
        </div>

        <div>
          <label for="pastedText">Material (klistra in text)</label>
          <textarea id="pastedText" placeholder="Klistra in anteckningar eller text här..."></textarea>
        </div>
      </div>

      <div class="row">
        <button class="btn btnGhost" id="testBtn" type="button">Testa AI</button>
        <button class="btn btnPrimary" id="generateBtn" type="button">Skapa mockprov</button>
        <button class="btn btnGhost" id="gradeBtn" type="button" disabled>Rätta prov</button>
        <button class="btn btnGhost" id="clearBtn" type="button">Rensa</button>
      </div>

      <div class="status" id="status"></div>
      <pre id="debug"></pre>
    </section>

    <section class="card">
      <div class="status" id="examMeta">Ingen provdata ännu.</div>
      <div id="exam"></div>
    </section>

    <section class="card">
      <div class="status" id="resultMeta">Ingen rättning ännu.</div>
      <div id="result"></div>
    </section>
  </main>

  <footer>ProvKlar UF är studiestöd och ger ingen officiell betygssättning.</footer>

  <script>
    const CORRECT_CODE = "provklar123";

    function checkCode(){
      const inp = document.getElementById("accessCode");
      const msg = document.getElementById("errorMsg");
      const val = (inp.value || "").trim();

      if(val === CORRECT_CODE){
        localStorage.setItem("provklar_logged_in", "true");
        document.getElementById("loginScreen").style.display = "none";
        msg.textContent = "";
      } else {
        msg.textContent = "Fel kod.";
      }
    }

    function logout(){
      localStorage.removeItem("provklar_logged_in");
      const inp = document.getElementById("accessCode");
      const msg = document.getElementById("errorMsg");
      inp.value = "";
      msg.textContent = "";
    }

    function forceLogout(){
      logout();
      document.getElementById("loginScreen").style.display = "flex";
    }

    document.addEventListener("keydown", (e) => {
      const visible = document.getElementById("loginScreen").style.display !== "none";
      if(visible && e.key === "Enter") checkCode();
    });

    if(localStorage.getItem("provklar_logged_in") === "true"){
      document.getElementById("loginScreen").style.display = "none";
    }

    // ===== App logic =====
    document.addEventListener("DOMContentLoaded", () => {
      const statusEl = document.getElementById("status");
      const debugEl = document.getElementById("debug");

      const examMetaEl = document.getElementById("examMeta");
      const examEl = document.getElementById("exam");
      const resultMetaEl = document.getElementById("resultMeta");
      const resultEl = document.getElementById("result");

      const testBtn = document.getElementById("testBtn");
      const generateBtn = document.getElementById("generateBtn");
      const gradeBtn = document.getElementById("gradeBtn");
      const clearBtn = document.getElementById("clearBtn");

      const levelEl = document.getElementById("level");
      const courseEl = document.getElementById("course");
      const pastedTextEl = document.getElementById("pastedText");

      let currentExam = null;

      function setStatus(t){ statusEl.textContent = t || ""; }
      function showDebug(t){ debugEl.style.display="block"; debugEl.textContent = t || ""; }
      function hideDebug(){ debugEl.style.display="none"; debugEl.textContent = ""; }

      function clearExam(){
        currentExam = null;
        examMetaEl.textContent = "Ingen provdata ännu.";
        examEl.innerHTML = "";
        gradeBtn.disabled = true;
      }
      function clearResult(){
        resultMetaEl.textContent = "Ingen rättning ännu.";
        resultEl.innerHTML = "";
      }

      async function postJson(path, payload){
        const resp = await fetch(path, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const raw = await resp.text();
        let data = null; try { data = JSON.parse(raw); } catch {}
        return { status: resp.status, ok: resp.ok, raw, data };
      }

      function renderExam(exam){
        currentExam = exam;
        const qs = Array.isArray(exam.questions) ? exam.questions : [];
        examMetaEl.textContent = `${exam.title || "Mockprov"} • Nivå: ${exam.level || "—"} • Frågor: ${qs.length}`;
        examEl.innerHTML = "";

        qs.forEach((q, idx) => {
          const box = document.createElement("div");
          box.className = "q";

          const meta = document.createElement("div");
          meta.className = "meta";
          meta.textContent = `ID: ${q.id ?? (idx+1)} • Poäng: ${q.points ?? "—"}`;

          const text = document.createElement("p");
          text.className = "text";
          text.textContent = q.question ?? "";

          const answer = document.createElement("textarea");
          answer.className = "answer";
          answer.placeholder = "Skriv ditt svar här...";
          answer.dataset.qid = String(q.id ?? (idx+1));

          box.appendChild(meta);
          box.appendChild(text);
          box.appendChild(answer);
          examEl.appendChild(box);
        });

        gradeBtn.disabled = qs.length === 0;
      }

      function renderResult(r){
        resultMetaEl.textContent = `Rättning: ${r.total_points}/${r.max_points}`;
        const wrap = document.createElement("div");

        (r.per_question || []).forEach(item => {
          const d = document.createElement("div");
          d.className = "q";
          d.innerHTML = `
            <div class="meta">ID: ${item.id} • ${item.points}/${item.max_points}</div>
            <p class="text" style="margin:0">${item.feedback || ""}</p>
          `;
          wrap.appendChild(d);
        });

        if (Array.isArray(r.tips) && r.tips.length){
          const ul = document.createElement("ul");
          r.tips.forEach(t => { const li = document.createElement("li"); li.textContent = t; ul.appendChild(li); });
          wrap.appendChild(ul);
        }

        resultEl.innerHTML = "";
        resultEl.appendChild(wrap);
      }

      testBtn.addEventListener("click", async () => {
        hideDebug();
        setStatus("Testar AI...");
        const r = await fetch("/api/test-ai");
        const raw = await r.text();
        setStatus(`Test AI: HTTP ${r.status}`);
        showDebug(raw);
      });

      generateBtn.addEventListener("click", async () => {
        hideDebug();
        clearResult();
        clearExam();

        const pastedText = pastedTextEl.value.trim();
        if (!pastedText){ setStatus("Klistra in material först."); return; }

        setStatus("Skapar mockprov...");
        const r = await postJson("/api/generate-exam", {
          level: levelEl.value,
          course: courseEl.value.trim(),
          pastedText
        });

        if (!r.ok || !r.data || !r.data.ok){
          setStatus(`Fel vid generering (HTTP ${r.status}).`);
          showDebug(r.raw);
          return;
        }

        renderExam(r.data.exam);
        setStatus("Mockprov klart.");
      });

      gradeBtn.addEventListener("click", async () => {
        hideDebug();
        clearResult();

        if (!currentExam || !Array.isArray(currentExam.questions) || currentExam.questions.length === 0){
          setStatus("Skapa mockprov först.");
          return;
        }

        const answers = Array.from(document.querySelectorAll("textarea.answer")).map(el => ({
          id: el.dataset.qid,
          answer: el.value.trim()
        }));

        setStatus("Rättar prov...");
        const r = await postJson("/api/grade", {
          level: levelEl.value,
          course: courseEl.value.trim(),
          pastedText: pastedTextEl.value.trim(),
          questions: currentExam.questions,
          answers
        });

        if (!r.ok || !r.data || !r.data.ok){
          setStatus(`Fel vid rättning (HTTP ${r.status}).`);
          showDebug(r.raw);
          return;
        }

        renderResult(r.data.result);
        setStatus("Rättning klar.");
      });

      clearBtn.addEventListener("click", () => {
        hideDebug();
        pastedTextEl.value = "";
        courseEl.value = "";
        levelEl.value = "C";
        clearExam();
        clearResult();
        setStatus("");
      });

      setStatus("");
    });
  </script>
</body>
</html>
