<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ProviaAi – App</title>

  <style>
    :root{
      --deep:#052A1E; --deep2:#041E16;
      --mint:#2BE38C; --mint2:#16B876;
      --bg:#F6FBF8; --muted:#556072; --border:rgba(5,42,30,.14);
      --shadow:0 18px 55px rgba(5,42,30,.14);
      --radius:18px; --font:system-ui,-apple-system,Segoe UI,Roboto,Arial; --max:1080px;
      --danger:#8b1d1d; --ok:#0f7a5a; --warn:#946200;
    }
    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    :target{scroll-margin-top:92px}
    body{
      margin:0;font-family:var(--font);
      background:
        radial-gradient(900px 450px at 20% -10%, rgba(43,227,140,.18), transparent 60%),
        radial-gradient(700px 380px at 95% 20%, rgba(43,227,140,.10), transparent 55%),
        var(--bg);
      color:#071812;
    }
    a{text-decoration:none;color:inherit}

    header{
      background:rgba(255,255,255,.88);backdrop-filter:saturate(140%) blur(10px);
      border-bottom:1px solid var(--border);
      position:sticky;top:0;z-index:3000;
    }
    .wrap{max-width:var(--max);margin:0 auto;padding:clamp(14px,3vw,22px)}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:12px;min-width:0}
    .brand img{height:54px;width:auto;display:block}
    .brand .name{font-weight:1100;color:var(--deep);font-size:18px;line-height:1.05}
    .brand .tag{margin-top:3px;color:var(--muted);font-weight:850;font-size:12px;line-height:1.1}

    .btn{
      display:inline-flex;align-items:center;justify-content:center;
      padding:12px 16px;border-radius:14px;
      font-weight:1000;font-size:14px;border:1px solid var(--border);
      cursor:pointer;white-space:nowrap;
      background:rgba(255,255,255,.92);color:var(--deep);
    }
    .btnPrimary{
      background:var(--mint2);color:#fff;border-color:rgba(22,184,118,.28);
      box-shadow:0 14px 28px rgba(22,184,118,.22)
    }

    .card{
      background:rgba(255,255,255,.92);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:clamp(16px,3vw,22px);
      margin:14px 0;
      overflow:hidden;
      position:relative;
    }
    .card:before{
      content:"";
      position:absolute;inset:-70px -70px auto auto;
      width:190px;height:190px;border-radius:999px;
      background:radial-gradient(circle at 30% 30%, rgba(43,227,140,.16), transparent 60%);
      pointer-events:none;
    }
    .sectionTitle{
      margin:0 0 6px;font-weight:1100;letter-spacing:-.01em;color:var(--deep);
      font-size:16px;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .sectionSub{margin:0;color:var(--muted);font-weight:780;font-size:12px;line-height:1.35}

    label{display:block;margin:12px 0 6px;font-weight:1000;color:var(--deep);font-size:13px}
    select,input,textarea{
      width:100%;padding:12px;border-radius:14px;border:1px solid var(--border);background:#fff;
      font-family:inherit;font-size:14px;outline:none;
    }
    textarea{min-height:170px;resize:vertical}
    input:focus, textarea:focus, select:focus{border-color:rgba(43,227,140,.55);box-shadow:0 0 0 5px rgba(43,227,140,.14)}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:920px){ .grid2{grid-template-columns:1fr} }

    .status{margin-top:10px;color:var(--muted);font-weight:850;font-size:12px;line-height:1.35;word-break:break-word}
    .status.ok{color:var(--ok)} .status.bad{color:var(--danger)} .status.warn{color:var(--warn)}

    details{margin-top:10px}
    summary{cursor:pointer;font-weight:1000;color:var(--deep);font-size:13px}
    pre{
      margin:10px 0 0;padding:12px;border-radius:14px;border:1px solid var(--border);
      background:#fff;overflow:auto;font-size:12px;line-height:1.35;white-space:pre-wrap;word-break:break-word;
    }

    .spinner{width:16px;height:16px;border-radius:999px;border:2px solid rgba(5,42,30,.18);border-top-color:rgba(22,184,118,.95);animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .qBox{margin-top:12px;padding:12px;border:1px solid rgba(5,42,30,.12);border-radius:16px;background:#fff}
    .qMeta{color:var(--muted);font-weight:900;font-size:12px;margin-bottom:6px}
    .qText{font-weight:900;color:#071812;line-height:1.45}

    footer{border-top:1px solid var(--border);padding:18px;text-align:center;color:var(--muted);font-size:12px;font-weight:750}

    /* menu */
    .menuWrap{position:relative;z-index:4000}
    .iconBtn{
      width:44px;height:44px;border-radius:14px;border:1px solid var(--border);
      background:rgba(255,255,255,.92);cursor:pointer;display:grid;place-items:center;
    }
    .bars{width:18px;height:12px;display:grid;gap:3px}
    .bars span{display:block;height:2px;background:var(--deep);border-radius:2px;opacity:.9}
    .dropdown{
      position:absolute;right:0;top:54px;min-width:270px;
      background:rgba(255,255,255,.98);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:0 22px 60px rgba(5,42,30,.18);
      padding:8px;
      display:none;
      z-index:5000;
    }
    .dropdown a, .dropdown button{
      width:100%;
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid transparent;
      background:transparent;
      cursor:pointer;
      font-weight:950;
      color:var(--deep);
      font-size:13px;
      text-align:left;
    }
    .dropdown a:hover, .dropdown button:hover{background:rgba(43,227,140,.10);border-color:rgba(43,227,140,.18)}
    .pill{
      font-size:11px;font-weight:1000;color:var(--muted);
      border:1px solid var(--border);
      border-radius:999px;padding:4px 8px;background:#fff;
    }

    /* lock */
    .loginOverlay{
      position:fixed;inset:0;z-index:9999;
      background:
        radial-gradient(800px 420px at 20% 10%, rgba(43,227,140,.22), transparent 60%),
        radial-gradient(700px 380px at 90% 20%, rgba(43,227,140,.10), transparent 55%),
        linear-gradient(135deg, rgba(5,42,30,.98), rgba(4,30,22,.92));
      display:flex;align-items:center;justify-content:center;padding:18px;
    }
    .loginCard{
      width:min(680px, 100%);
      background:rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.22);
      border-radius:22px;
      box-shadow:0 24px 70px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .loginTop{display:flex;gap:14px;align-items:center;padding:18px 18px 10px}
    .loginTop img{height:68px;width:auto;display:block}
    .loginTop .ltTitle{font-weight:1100;color:var(--deep);font-size:20px;line-height:1.1}
    .loginTop .ltSub{margin-top:4px;color:var(--muted);font-weight:800;font-size:12px}
    .loginBody{padding:12px 18px 18px}
    .loginRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .err{margin-top:10px;color:var(--danger);font-weight:900;font-size:12px}

    .authBox{
      border:1px solid rgba(5,42,30,.12);
      border-radius:16px;
      padding:12px;
      background:rgba(255,255,255,.7);
    }
    .authTitle{font-weight:1100;color:var(--deep);font-size:13px}
    .miniHint{margin-top:6px;color:var(--muted);font-weight:850;font-size:12px;line-height:1.35}

    /* upload */
    .uploadBox{
      border:1px dashed rgba(5,42,30,.22);
      border-radius:16px;
      padding:12px;
      background:rgba(255,255,255,.7);
    }
    .uploadTop{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .smallHint{color:var(--muted);font-weight:850;font-size:12px;line-height:1.35;margin-top:6px}
    .fileRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .fileRow input[type="file"]{max-width:320px}

    /* MC clickable */
    .mcGroup{display:grid;gap:8px;margin-top:10px}
    .mcOpt{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(5,42,30,.14);
      background:#fff; cursor:pointer;
      font-weight:900; line-height:1.35;
      text-align:left;
    }
    .mcOpt:hover{border-color:rgba(43,227,140,.35)}
    .mcOpt.sel{
      border-color:rgba(43,227,140,.60);
      box-shadow:0 0 0 5px rgba(43,227,140,.12);
    }
    .mcLetter{
      width:28px;height:28px;border-radius:10px;
      display:grid;place-items:center;
      background:rgba(5,42,30,.06);
      font-weight:1100;color:var(--deep);
      flex:0 0 28px;
    }
    .mcText{font-weight:850;color:#071812}
  </style>
</head>

<body>

  <!-- LOCK SCREEN -->
  <div id="loginScreen" class="loginOverlay" aria-hidden="false">
    <div class="loginCard" role="dialog" aria-modal="true" aria-label="Inloggning">
      <div class="loginTop">
        <img src="image/proviaai-logo.png" alt="ProviaAi logga">
        <div>
          <div class="ltTitle" id="lockTitle">ProviaAi</div>
          <div class="ltSub" id="lockSub">Åtkomst krävs för att använda appen</div>
        </div>
      </div>

      <div class="loginBody">
        <!-- Email/Pass login (Supabase) -->
        <div class="authBox" id="authBox">
          <div class="authTitle" id="authTitle">Logga in / Skapa konto</div>

          <div class="grid2" style="margin-top:10px">
            <div>
              <label for="authEmail" id="authEmailLabel">E-post</label>
              <input id="authEmail" type="email" autocomplete="email" placeholder="du@skola.se" />
            </div>
            <div>
              <label for="authPass" id="authPassLabel">Lösenord</label>
              <input id="authPass" type="password" autocomplete="current-password" placeholder="Minst 8 tecken" />
            </div>
          </div>

          <div class="loginRow">
            <button class="btn btnPrimary" type="button" id="signInBtn">Logga in</button>
            <button class="btn" type="button" id="signUpBtn">Skapa konto</button>
            <a class="btn" href="index.html" id="toInfoBtn">Till infosidan</a>
            <a class="btn" href="förbättring.html" id="toImproveBtn">Förbättring</a>
          </div>

          <div class="miniHint" id="authHint">
            Om du har “admin-godkännande”: nya konton kan fastna på “Väntar på godkännande” tills admin godkänner.
          </div>
        </div>

        <!-- Access code fallback -->
        <details style="margin-top:12px" open>
          <summary id="codeSummary">Alternativ inloggning: kod</summary>
          <label for="accessCode" id="lockLabel">Åtkomstkod</label>
          <input id="accessCode" type="password" placeholder="Skriv koden…" autocomplete="off" />
          <div class="loginRow">
            <button class="btn btnPrimary" type="button" id="unlockBtn">Lås upp</button>
          </div>
        </details>

        <div id="errorMsg" class="err" aria-live="polite"></div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <header>
    <div class="wrap topbar">
      <a class="brand" href="index.html">
        <img src="image/proviaai-logo.png" alt="ProviaAi logga">
        <div>
          <div class="name" id="brandName">ProviaAi</div>
          <div class="tag" id="brandTag">Mockprov • Rättning • Modellsvar</div>
        </div>
      </a>

      <div class="menuWrap">
        <button class="iconBtn" id="menuBtn" type="button" aria-label="Meny">
          <div class="bars" aria-hidden="true"><span></span><span></span><span></span></div>
        </button>

        <div class="dropdown" id="menu" aria-label="Menyval">
          <a href="#material" data-scroll="#material"><span id="m1">1) Material</span><span class="pill">Text/OCR</span></a>
          <a href="#settings" data-scroll="#settings"><span id="m2">2) Inställningar</span><span class="pill">Nivå</span></a>
          <a href="#exam" data-scroll="#exam"><span id="m3">3) Mockprov</span><span class="pill">Frågor</span></a>
          <a href="#result" data-scroll="#result"><span id="m4">4) Rättning</span><span class="pill">Modellsvar</span></a>

          <a href="förbättring.html"><span id="mImprove">Förbättring</span><span class="pill">Coach</span></a>

          <button type="button" id="langBtn"><span id="mLang">English</span><span class="pill" id="langPill">SV</span></button>
          <button type="button" id="logoutTopBtn"><span id="mLogout">Logga ut</span><span class="pill">Lås</span></button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap" id="appRoot">

    <section class="card" id="material">
      <div class="sectionTitle"><span id="tStep1">Steg 1 – Material</span></div>
      <p class="sectionSub" id="tStep1Sub">Klistra in text. Valfritt: välj en bild eller ta foto → OCR lägger in text i materialet.</p>

      <label for="pastedText" id="tPasteLabel">Material (klistra in text)</label>
      <textarea id="pastedText" placeholder="Rubriker → punktlista → definitioner/formler → exempel"></textarea>

      <div class="uploadBox" style="margin-top:12px">
        <div class="uploadTop">
          <div style="font-weight:1000;color:var(--deep);font-size:13px" id="tOcrTitle">Bild → OCR (valfritt)</div>
          <div class="fileRow">
            <input id="imageInput" type="file" accept="image/*" capture="environment" />
            <button class="btn" id="ocrBtn" type="button">OCR till material</button>
          </div>
        </div>
        <div class="smallHint" id="tOcrHint">Tips: tydlig bild rakt ovanifrån, bra ljus, hög kontrast.</div>
        <div class="status" id="ocrStatus"></div>
      </div>

      <div class="status warn" id="formatHint" style="margin-top:12px">
        Tips: rubriker + punktlistor ger mer exakta frågor och bättre rättning.
      </div>
    </section>

    <section class="card" id="settings">
      <div class="sectionTitle">
        <span id="tStep2">Steg 2 – Inställningar</span>
        <a class="btn" href="förbättring.html" id="improveBtnInline">Förbättring</a>
      </div>
      <p class="sectionSub" id="tStep2Sub">Välj betygsnivå (E/C/A), frågetyp och exakt antal frågor.</p>

      <div class="grid2">
        <div>
          <label for="level" id="tLevel">Nivå (E/C/A)</label>
          <select id="level">
            <option value="E">E</option>
            <option value="C" selected>C</option>
            <option value="A">A</option>
          </select>
        </div>
        <div>
          <label for="course" id="tCourse">Ämne/kurs (valfritt)</label>
          <input id="course" placeholder="Ex: Matematik 2b / Historia 1b" />
        </div>
      </div>

      <div class="grid2" style="margin-top:12px">
        <div>
          <label for="qType" id="tQType">Frågetyp</label>
          <select id="qType">
            <option value="mix" selected id="qtMix">Blandat</option>
            <option value="mc" id="qtMc">Flervalsfrågor</option>
            <option value="short" id="qtShort">Kortsvar</option>
            <option value="essay" id="qtEssay">Essä</option>
          </select>
        </div>
        <div>
          <label for="numQuestions" id="tNum">Antal frågor (exakt)</label>
          <select id="numQuestions">
            <option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option>
            <option>9</option><option>10</option><option>11</option><option selected>12</option>
          </select>
        </div>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;align-items:center">
        <button class="btn btnPrimary" id="generateExamBtn" type="button">Skapa mockprov</button>
        <button class="btn" id="gradeBtn" type="button" disabled>Rätta prov</button>
        <button class="btn" id="clearBtn" type="button">Rensa</button>

        <span style="display:flex;gap:10px;align-items:center">
          <span id="spinWrap" style="display:none"><span class="spinner" aria-hidden="true"></span></span>
          <span class="sectionSub" id="miniState">Redo.</span>
        </span>
      </div>

      <div class="status" id="status"></div>

      <details id="debugWrap" style="display:none">
        <summary id="debugTitle">Debug</summary>
        <pre id="debug"></pre>
      </details>
    </section>

    <section class="card" id="exam">
      <div class="sectionTitle"><span id="tStep3">Steg 3 – Mockprov</span></div>
      <div class="status" id="examMeta">Ingen provdata ännu.</div>
      <div id="examBody"></div>
    </section>

    <section class="card" id="result">
      <div class="sectionTitle"><span id="tStep4">Steg 4 – Rättning</span></div>
      <div class="status" id="resultMeta">Ingen rättning ännu.</div>
      <div id="resultBody"></div>
    </section>

  </main>

  <footer id="footerText">ProviaAi är studiestöd och ger ingen officiell betygssättning.</footer>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // ============================
    // SUPABASE KEYS
    // ============================
const SUPABASE_URL = "https://mnmotdluigzeehdjbhbu.supabase.co".trim();
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ubW90ZGx1aWd6ZWVoZGpiaGJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMzcwODQsImV4cCI6MjA4NTkxMzA4NH0.pEV4zBWqxnrPVyvrenPVArXxvXr1eRU1eRaXhl7AIY8".trim();
const SUPABASE_ANON_KEY = (SUPABASE_ANON_KEY_RAW || "").trim(); // viktigt: tar bort trailing space

    // ===== LOGIN CONFIG (fallback kod) =====
    const ACCESS_CODE = "provia123";
    const ACCESS_FLAG_KEY = "proviaai_app_access";

    // ===== STORAGE KEYS =====
    const LS_HISTORY = "proviaai_history";
    const LS_MISTAKES = "proviaai_mistakes";
    const LS_LAST = "proviaai_last_result";
    const LS_MATERIAL = "proviaai_last_material";

    const $ = (id) => document.getElementById(id);

    function safeJsonParse(s, fallback){ try{ return JSON.parse(s); } catch { return fallback; } }
    function lsGetArray(key){ const v = localStorage.getItem(key); const arr = safeJsonParse(v, []); return Array.isArray(arr) ? arr : []; }
    function lsSet(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); } catch {} }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    async function postJson(path, payload){
      const resp = await fetch(path, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      const raw = await resp.text();
      let data = null;
      try{ data = JSON.parse(raw); } catch {}
      return { ok: resp.ok, status: resp.status, raw, data };
    }

    // ===== I18N =====
    let LANG = localStorage.getItem("proviaai_lang") || "sv";
    const T = {
      sv:{
        brandTag:"Mockprov • Rättning • Modellsvar",
        lockSub:"Åtkomst krävs för att använda appen",
        lockLabel:"Åtkomstkod",
        unlock:"Lås upp",
        toInfo:"Till infosidan",
        toImprove:"Förbättring",
        m1:"1) Material", m2:"2) Inställningar", m3:"3) Mockprov", m4:"4) Rättning",
        mImprove:"Förbättring", mLang:"English", mLogout:"Logga ut",
        step1:"Steg 1 – Material",
        step1Sub:"Klistra in text. Valfritt: välj en bild eller ta foto → OCR lägger in text i materialet.",
        pasteLabel:"Material (klistra in text)",
        pastePH:"Rubriker → punktlista → definitioner/formler → exempel",
        ocrTitle:"Bild → OCR (valfritt)",
        ocrBtn:"OCR till material",
        ocrHint:"Tips: tydlig bild rakt ovanifrån, bra ljus, hög kontrast.",
        tip:"Tips: rubriker + punktlistor ger mer exakta frågor och bättre rättning.",
        step2:"Steg 2 – Inställningar",
        step2Sub:"Välj betygsnivå (E/C/A), frågetyp och exakt antal frågor.",
        level:"Nivå (E/C/A)",
        course:"Ämne/kurs (valfritt)",
        coursePH:"Ex: Matematik 2b / Historia 1b",
        qType:"Frågetyp",
        qtMix:"Blandat", qtMc:"Flervalsfrågor", qtShort:"Kortsvar", qtEssay:"Essä",
        num:"Antal frågor (exakt)",
        gen:"Skapa mockprov", grade:"Rätta prov", clear:"Rensa",
        ready:"Redo.",
        debug:"Debug",
        step3:"Steg 3 – Mockprov",
        step4:"Steg 4 – Rättning",
        noExam:"Ingen provdata ännu.",
        noGrade:"Ingen rättning ännu.",
        needMat:"Klistra in material först.",
        genWorking:"Skapar mockprov…",
        gradeWorking:"Rättar prov…",
        genDone:"Mockprov klart.",
        gradeDone:"Rättning klar. Sparad till förbättring.",
        wrongCode:"Fel kod.",
        ocrNoFile:"Välj en bild först.",
        ocrWorking:"OCR pågår…",
        ocrDone:"OCR klart. Texten lades in i materialet.",
        writeAnswer:"Skriv ditt svar här…",
        fullScore:"Vad som ger full poäng (modellsvar)",
        genFirst:"Skapa mockprov först.",
        cleared:"Allt rensat. Börja om.",
        footer:"ProviaAi är studiestöd och ger ingen officiell betygssättning.",
        pending:"Väntar på admin-godkännande. Du får tillgång när du blir godkänd."
      },
      en:{
        brandTag:"Mock exams • Grading • Model answers",
        lockSub:"Access is required to use the app",
        lockLabel:"Access code",
        unlock:"Unlock",
        toInfo:"Go to info page",
        toImprove:"Improve",
        m1:"1) Material", m2:"2) Settings", m3:"3) Mock exam", m4:"4) Grading",
        mImprove:"Improve", mLang:"Svenska", mLogout:"Log out",
        step1:"Step 1 – Material",
        step1Sub:"Paste text. Optional: choose an image or take a photo → OCR adds text into your material.",
        pasteLabel:"Material (paste text)",
        pastePH:"Headings → bullet points → definitions/formulas → examples",
        ocrTitle:"Image → OCR (optional)",
        ocrBtn:"OCR into material",
        ocrHint:"Tip: sharp photo from above, good light, high contrast.",
        tip:"Tip: headings + bullet points produce more accurate questions and grading.",
        step2:"Step 2 – Settings",
        step2Sub:"Choose level (E/C/A), question type and an exact number of questions.",
        level:"Level (E/C/A)",
        course:"Subject/course (optional)",
        coursePH:"e.g., Math / History",
        qType:"Question type",
        qtMix:"Mixed", qtMc:"Multiple choice", qtShort:"Short answer", qtEssay:"Essay",
        num:"Number of questions (exact)",
        gen:"Generate mock exam", grade:"Grade exam", clear:"Clear",
        ready:"Ready.",
        debug:"Debug",
        step3:"Step 3 – Mock exam",
        step4:"Step 4 – Grading",
        noExam:"No exam data yet.",
        noGrade:"No grading yet.",
        needMat:"Paste material first.",
        genWorking:"Generating mock exam…",
        gradeWorking:"Grading…",
        genDone:"Mock exam ready.",
        gradeDone:"Grading done. Saved to Improve page.",
        wrongCode:"Wrong code.",
        ocrNoFile:"Choose an image first.",
        ocrWorking:"Running OCR…",
        ocrDone:"OCR done. Text was added to the material.",
        writeAnswer:"Write your answer here…",
        fullScore:"Full-score model answer",
        genFirst:"Generate an exam first.",
        cleared:"Cleared. Start again.",
        footer:"ProviaAi is study support and does not provide official grades.",
        pending:"Waiting for admin approval. You’ll get access once approved."
      }
    };

    // ===== SAFE HELPERS (no crash if element missing) =====
    function onClick(id, fn){
      const el = $(id);
      if(!el) return false;
      el.addEventListener("click", (e) => {
        try{ fn(e); } catch(err){ reportErr(err); }
      });
      return true;
    }
    function onKey(fn){
      document.addEventListener("keydown", (e) => {
        try{ fn(e); } catch(err){ reportErr(err); }
      });
    }

    // ===== DEBUG/ERROR REPORTING =====
    function showDebug(txt){
      const wrap = $("debugWrap"), pre = $("debug");
      if(!wrap || !pre) return;
      wrap.style.display = "block";
      pre.textContent = txt || "";
    }
    function hideDebug(){
      const wrap = $("debugWrap"), pre = $("debug");
      if(!wrap || !pre) return;
      wrap.style.display = "none";
      pre.textContent = "";
    }
    function reportErr(err){
      const msg = (err && (err.stack || err.message)) ? String(err.stack || err.message) : String(err);
      showDebug(msg);
      const statusEl = $("status");
      if(statusEl){
        statusEl.className = "status bad";
        statusEl.textContent = "JS-fel: se Debug.";
      }
      const em = $("errorMsg");
      if(em) em.textContent = "JS-fel: se Debug.";
    }
    window.addEventListener("error", (e) => reportErr(e.error || e.message));
    window.addEventListener("unhandledrejection", (e) => reportErr(e.reason));

    // ===== SUPABASE INIT (robust) =====
    const USE_SUPABASE =
      typeof SUPABASE_URL === "string" && SUPABASE_URL.startsWith("http") &&
      typeof SUPABASE_ANON_KEY === "string" && SUPABASE_ANON_KEY.length > 40;

    // CDN v2 exponerar normalt window.supabase (objekt med createClient)
    const SupabaseGlobal = (typeof window !== "undefined") ? window.supabase : null;
    const db = (USE_SUPABASE && SupabaseGlobal && typeof SupabaseGlobal.createClient === "function")
      ? SupabaseGlobal.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
      : null;

    // ===== UI refs =====
    const spinWrap = () => $("spinWrap");
    const miniStateEl = () => $("miniState");
    const statusEl = () => $("status");
    const pastedTextEl = () => $("pastedText");
    const levelEl = () => $("level");
    const courseEl = () => $("course");
    const qTypeEl = () => $("qType");
    const numQuestionsEl = () => $("numQuestions");
    const examMetaEl = () => $("examMeta");
    const examBodyEl = () => $("examBody");
    const resultMetaEl = () => $("resultMeta");
    const resultBodyEl = () => $("resultBody");
    const imageInputEl = () => $("imageInput");
    const ocrStatusEl = () => $("ocrStatus");

    let currentExam = null;

    function setBusy(isBusy, label){
      const sw = spinWrap(), ms = miniStateEl();
      if(sw) sw.style.display = isBusy ? "inline-flex" : "none";
      if(ms) ms.textContent = label || (isBusy ? "…" : T[LANG].ready);
      const genBtn = $("generateExamBtn");
      const gradeBtn = $("gradeBtn");
      const clearBtn = $("clearBtn");
      const ocrBtn = $("ocrBtn");
      if(genBtn) genBtn.disabled = isBusy;
      if(gradeBtn) gradeBtn.disabled = isBusy || !currentExam;
      if(clearBtn) clearBtn.disabled = isBusy;
      if(ocrBtn) ocrBtn.disabled = isBusy;
    }
    function setStatus(txt, kind){
      const s = statusEl();
      if(!s) return;
      s.className = "status" + (kind ? (" " + kind) : "");
      s.textContent = txt || "";
    }
    function setOcrStatus(txt, kind){
      const s = ocrStatusEl();
      if(!s) return;
      s.className = "status" + (kind ? (" " + kind) : "");
      s.textContent = txt || "";
    }

    // ===== LOCK / UNLOCK =====
    function isUnlocked(){ return localStorage.getItem(ACCESS_FLAG_KEY) === "true"; }
    function showLock(){
      const s = $("loginScreen");
      if(!s) return;
      s.style.display = "flex";
      s.setAttribute("aria-hidden","false");
      document.documentElement.style.overflow = "hidden";
      document.body.style.overflow = "hidden";
    }
    function hideLock(){
      const s = $("loginScreen");
      if(!s) return;
      s.style.display = "none";
      s.setAttribute("aria-hidden","true");
      document.documentElement.style.overflow = "";
      document.body.style.overflow = "";
    }
    function setLockError(msg){
      const em = $("errorMsg");
      if(em) em.textContent = msg || "";
    }
    function unlockByCode(){
      const input = $("accessCode");
      const v = (input?.value || "").trim();
      if(v === ACCESS_CODE){
        localStorage.setItem(ACCESS_FLAG_KEY, "true");
        setLockError("");
        hideLock();
      } else {
        setLockError(T[LANG].wrongCode);
      }
    }
    async function logout(){
      localStorage.removeItem(ACCESS_FLAG_KEY);
      const m = $("menu"); if(m) m.style.display = "none";
      if(db){
        try{ await db.auth.signOut(); } catch {}
      }
      showLock();
    }

    // ===== APPROVAL CHECK =====
    async function checkApprovalAndUnlock(session){
      if(!db) return false;
      const user = session?.user;
      if(!user?.id) return false;

      const { data: prof, error } = await supabase
  .from("profiles")
  .select("approved, role")
  .eq("id", user.id)
  .maybeSingle();

if (error) {
  setLockError(String(error.message || error));
  return false;
}

if (!prof) {
  setLockError("Profil saknas i databasen (profiles). Skapa profilen för användaren eller lägg en trigger som skapar den automatiskt.");
  showLock();
  return false;
}

if (!prof.approved) {
  setLockError(T[LANG].pending);
  showLock();
  return false;
}

setLockError("");
hideLock();
return true;


      if(error){
        setLockError(String(error.message || error));
        return false;
      }

      if(!prof?.approved){
        setLockError(T[LANG].pending);
        showLock();
        return false;
      }

      setLockError("");
      hideLock();
      return true;
    }

    async function signInEmail(){
      hideDebug();
      if(!db){
        setLockError("Supabase SDK laddades inte eller keys är fel.");
        return;
      }
      const email = ($("authEmail")?.value || "").trim();
      const password = $("authPass")?.value || "";
      if(!email || !password){
        setLockError("Fyll i e-post och lösenord.");
        return;
      }

      const { data, error } = await db.auth.signInWithPassword({ email, password });
      if(error){
        setLockError(error.message);
        return;
      }
      await checkApprovalAndUnlock(data.session);
    }

    async function signUpEmail(){
      hideDebug();
      if(!db){
        setLockError("Supabase SDK laddades inte eller keys är fel.");
        return;
      }
      const email = ($("authEmail")?.value || "").trim();
      const password = $("authPass")?.value || "";
      if(!email || !password){
        setLockError("Fyll i e-post och lösenord.");
        return;
      }

      const { data, error } = await db.auth.signUp({ email, password });
      if(error){
        setLockError(error.message);
        return;
      }

      // Om email-confirmation är på: ingen session direkt -> visa pending/confirmation-läge
      if(data?.session){
        await checkApprovalAndUnlock(data.session);
      } else {
        setLockError(T[LANG].pending);
        showLock();
      }
    }

    // ===== APP RENDERING =====
    function applyLang(){
      const t = T[LANG];
      const set = (id, val) => { const el = $(id); if(el) el.textContent = val; };

      set("brandTag", t.brandTag);
      set("lockSub", t.lockSub);
      set("lockLabel", t.lockLabel);
      set("unlockBtn", t.unlock);
      set("toInfoBtn", t.toInfo);
      set("toImproveBtn", t.toImprove);

      set("m1", t.m1); set("m2", t.m2); set("m3", t.m3); set("m4", t.m4);
      set("mImprove", t.mImprove);
      set("mLang", t.mLang);
      set("mLogout", t.mLogout);
      set("langPill", LANG.toUpperCase());

      set("tStep1", t.step1);
      set("tStep1Sub", t.step1Sub);
      set("tPasteLabel", t.pasteLabel);
      const pt = $("pastedText"); if(pt) pt.placeholder = t.pastePH;
      set("tOcrTitle", t.ocrTitle);
      set("ocrBtn", t.ocrBtn);
      set("tOcrHint", t.ocrHint);
      set("formatHint", t.tip);

      set("tStep2", t.step2);
      set("tStep2Sub", t.step2Sub);
      set("tLevel", t.level);
      set("tCourse", t.course);
      const c = $("course"); if(c) c.placeholder = t.coursePH;
      set("tQType", t.qType);
      set("qtMix", t.qtMix);
      set("qtMc", t.qtMc);
      set("qtShort", t.qtShort);
      set("qtEssay", t.qtEssay);
      set("tNum", t.num);
      set("generateExamBtn", t.gen);
      set("gradeBtn", t.grade);
      set("clearBtn", t.clear);
      set("improveBtnInline", t.mImprove);

      set("miniState", t.ready);
      set("debugTitle", t.debug);
      set("tStep3", t.step3);
      set("tStep4", t.step4);
      set("footerText", t.footer);

      const eb = examBodyEl(), rb = resultBodyEl();
      if(eb && !eb.children.length) set("examMeta", t.noExam);
      if(rb && !rb.children.length) set("resultMeta", t.noGrade);
    }

    async function fileToDataUrl(file){
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => resolve(String(fr.result || ""));
        fr.onerror = () => reject(new Error("FileReader error"));
        fr.readAsDataURL(file);
      });
    }

    function renderExam(exam){
      currentExam = exam;
      const qs = Array.isArray(exam.questions) ? exam.questions : [];
      const t = T[LANG];

      const em = examMetaEl(), eb = examBodyEl(), rm = resultMetaEl(), rb = resultBodyEl();
      if(em) em.textContent = `${exam.title || (LANG==="sv"?"Mockprov":"Mock exam")} • ${LANG==="sv"?"Nivå":"Level"}: ${exam.level || "—"} • ${qs.length} ${LANG==="sv"?"frågor":"questions"}`;
      if(eb) eb.innerHTML = "";
      if(rm) rm.textContent = t.noGrade;
      if(rb) rb.innerHTML = "";

      qs.forEach((q, idx) => {
        const box = document.createElement("div");
        box.className = "qBox";
        const qid = String(q.id ?? (idx+1));

        const meta = document.createElement("div");
        meta.className = "qMeta";
        meta.textContent = `ID: ${qid} • ${LANG==="sv"?"Poäng":"Points"}: ${q.points ?? "—"} • ${LANG==="sv"?"Typ":"Type"}: ${q.type ?? ($("qType")?.value || "")}`;

        const text = document.createElement("div");
        text.className = "qText";
        text.textContent = q.question ?? "";

        box.appendChild(meta);
        box.appendChild(text);

        if((q.type === "mc") && Array.isArray(q.options) && q.options.length){
          const group = document.createElement("div");
          group.className = "mcGroup";
          group.dataset.qid = qid;

          const hidden = document.createElement("input");
          hidden.type = "hidden";
          hidden.className = "mcAnswer";
          hidden.dataset.qid = qid;
          hidden.value = "";
          box.appendChild(hidden);

          q.options.forEach((opt, i) => {
            const letter = String.fromCharCode(65 + i);
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "mcOpt";
            btn.dataset.letter = letter;
            btn.dataset.qid = qid;
            btn.innerHTML = `<span class="mcLetter">${letter}</span><span class="mcText">${escapeHtml(opt)}</span>`;
            btn.addEventListener("click", () => {
              group.querySelectorAll(".mcOpt").forEach(x => x.classList.remove("sel"));
              btn.classList.add("sel");
              hidden.value = letter;
            });
            group.appendChild(btn);
          });

          box.appendChild(group);
          eb?.appendChild(box);
          return;
        }

        const ans = document.createElement("textarea");
        ans.className = "answer";
        ans.placeholder = t.writeAnswer;
        ans.dataset.qid = qid;
        ans.style.marginTop = "10px";
        ans.style.minHeight = (q.type === "essay") ? "150px" : "110px";
        box.appendChild(ans);
        eb?.appendChild(box);
      });

      const gradeBtn = $("gradeBtn");
      if(gradeBtn) gradeBtn.disabled = qs.length === 0;
    }

    function renderResult(r){
      const t = T[LANG];
      const rm = resultMetaEl(), rb = resultBodyEl();
      if(rm) rm.textContent = `${LANG==="sv"?"Rättning":"Grading"}: ${r.total_points}/${r.max_points}`;

      const wrap = document.createElement("div");
      (r.per_question || []).forEach(item => {
        const d = document.createElement("div");
        d.className = "qBox";
        const model = String(item.model_answer || "").trim();
        d.innerHTML = `
          <div class="qMeta">ID: ${escapeHtml(item.id)} • ${item.points}/${item.max_points}</div>
          <div style="font-weight:850;line-height:1.45">${escapeHtml(item.feedback || "")}</div>
          <div style="margin-top:10px;border-top:1px solid rgba(5,42,30,.12);padding-top:10px">
            <div style="font-weight:1100;color:#052A1E;margin-bottom:6px;font-size:13px">${t.fullScore}</div>
            <div style="white-space:pre-wrap;font-weight:800;line-height:1.45">${escapeHtml(model)}</div>
          </div>
        `;
        wrap.appendChild(d);
      });

      if(rb){
        rb.innerHTML = "";
        rb.appendChild(wrap);
      }
    }

    function clearAll(){
      const t = T[LANG];
      if(pastedTextEl()) pastedTextEl().value = "";
      if(courseEl()) courseEl().value = "";
      if(levelEl()) levelEl().value = "C";
      if(qTypeEl()) qTypeEl().value = "mix";
      if(numQuestionsEl()) numQuestionsEl().value = "12";
      if(imageInputEl()) imageInputEl().value = "";
      setOcrStatus("");
      currentExam = null;

      if(examMetaEl()) examMetaEl().textContent = t.noExam;
      if(examBodyEl()) examBodyEl().innerHTML = "";
      if(resultMetaEl()) resultMetaEl().textContent = t.noGrade;
      if(resultBodyEl()) resultBodyEl().innerHTML = "";

      const gradeBtn = $("gradeBtn");
      if(gradeBtn) gradeBtn.disabled = true;

      setStatus(t.cleared, "ok");
      hideDebug();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    // ===== INIT EVENTS (ALL IN DOMContentLoaded) =====
    window.addEventListener("DOMContentLoaded", async () => {
      try{
        applyLang();
        setBusy(false, T[LANG].ready);
        setStatus("");

        // MENU
        onClick("menuBtn", (e) => {
          e.preventDefault(); e.stopPropagation();
          const m = $("menu");
          if(!m) return;
          m.style.display = (m.style.display === "block") ? "none" : "block";
        });

        document.addEventListener("click", (e) => {
          const m = $("menu");
          const mb = $("menuBtn");
          if(!m || !mb) return;
          if(m.style.display !== "block") return;
          if(m.contains(e.target) || mb.contains(e.target)) return;
          m.style.display = "none";
        });

        const menuEl = $("menu");
        if(menuEl){
          menuEl.addEventListener("click", (e) => {
            const a = e.target.closest("a[data-scroll]");
            if(!a) return;
            e.preventDefault();
            const sel = a.getAttribute("data-scroll");
            menuEl.style.display = "none";
            const el = document.querySelector(sel);
            if(el) el.scrollIntoView({behavior:"smooth", block:"start"});
          });
        }

        onKey((e) => { if(e.key === "Escape"){ const m=$("menu"); if(m) m.style.display="none"; }});

        // LANGUAGE
        onClick("langBtn", () => {
          LANG = (LANG === "sv") ? "en" : "sv";
          localStorage.setItem("proviaai_lang", LANG);
          applyLang();
          const m = $("menu"); if(m) m.style.display = "none";
        });

        // LOGOUT
        onClick("logoutTopBtn", logout);

        // LOGIN BUTTONS
        onClick("unlockBtn", unlockByCode);
        onClick("signInBtn", () => signInEmail());
        onClick("signUpBtn", () => signUpEmail());

        // ENTER KEY (lock screen)
        onKey((e) => {
          if(e.key !== "Enter") return;
          const s = $("loginScreen");
          const visible = s && s.style.display !== "none";
          if(!visible) return;
          const email = ($("authEmail")?.value || "").trim();
          const pass = $("authPass")?.value || "";
          if(email && pass) signInEmail();
          else unlockByCode();
        });

        // OCR
        onClick("ocrBtn", async () => {
          hideDebug();
          const t = T[LANG];
          const inp = imageInputEl();
          const file = inp?.files && inp.files[0];
          if(!file){ setOcrStatus(t.ocrNoFile, "bad"); return; }
          setBusy(true, t.ocrWorking);
          setOcrStatus(t.ocrWorking, "warn");
          try{
            const dataUrl = await fileToDataUrl(file);
            const res = await postJson("/api/ocr", { imageDataUrl: dataUrl, lang: LANG });
            if(!res.ok || !res.data || !res.data.ok){
              setBusy(false, t.ready);
              setOcrStatus(`OCR error (HTTP ${res.status}).`, "bad");
              showDebug(res.raw);
              return;
            }
            const extracted = String(res.data.text || "").trim();
            if(extracted){
              const prefix = (LANG==="sv") ? "\n\n--- OCR (bild) ---\n" : "\n\n--- OCR (image) ---\n";
              const base = (pastedTextEl()?.value || "").trim();
              if(pastedTextEl()) pastedTextEl().value = (base ? base + prefix : "") + extracted + "\n";
            }
            setBusy(false, t.ready);
            setOcrStatus(t.ocrDone, "ok");
          }catch(e){
            setBusy(false, t.ready);
            setOcrStatus("OCR error.", "bad");
            reportErr(e);
          }
        });

        // GENERATE EXAM
        onClick("generateExamBtn", async () => {
          hideDebug();
          setStatus("");
          const t = T[LANG];

          const pastedText = (pastedTextEl()?.value || "").trim();
          if(!pastedText){
            setStatus(t.needMat, "bad");
            document.querySelector("#material")?.scrollIntoView({behavior:"smooth"});
            return;
          }

          const payload = {
            lang: LANG,
            level: levelEl()?.value || "C",
            course: (courseEl()?.value || "").trim(),
            qType: qTypeEl()?.value || "mix",
            pastedText,
            numQuestions: Number(numQuestionsEl()?.value || 12)
          };

          setBusy(true, t.genWorking);
          setStatus(`${t.genWorking} (${payload.qType}, ${payload.numQuestions})`, "");

          const res = await postJson("/api/generate-exam", payload);
          if(!res.ok || !res.data || !res.data.ok){
            setBusy(false, t.ready);
            setStatus(`Error (HTTP ${res.status}).`, "bad");
            showDebug(res.raw);
            return;
          }

          try{ localStorage.setItem(LS_MATERIAL, pastedText); } catch {}
          renderExam(res.data.exam);

          setBusy(false, t.ready);
          setStatus(t.genDone, "ok");
          document.querySelector("#exam")?.scrollIntoView({behavior:"smooth"});
        });

        // GRADE
        onClick("gradeBtn", async () => {
          hideDebug();
          setStatus("");
          const t = T[LANG];

          if(!currentExam || !Array.isArray(currentExam.questions) || currentExam.questions.length === 0){
            setStatus(t.genFirst, "bad");
            return;
          }

          const answers = [];
          currentExam.questions.forEach((q, idx) => {
            const qid = String(q.id ?? (idx+1));
            if(q.type === "mc"){
              const hidden = document.querySelector(`input.mcAnswer[data-qid="${CSS.escape(qid)}"]`);
              answers.push({ id: qid, answer: (hidden?.value || "").trim() });
            } else {
              const ta = document.querySelector(`textarea.answer[data-qid="${CSS.escape(qid)}"]`);
              answers.push({ id: qid, answer: (ta?.value || "").trim() });
            }
          });

          const pastedText = (pastedTextEl()?.value || "").trim();
          const payload = { lang: LANG, pastedText, questions: currentExam.questions, answers };

          setBusy(true, t.gradeWorking);
          setStatus(t.gradeWorking, "");

          const res = await postJson("/api/grade", payload);
          if(!res.ok || !res.data || !res.data.ok){
            setBusy(false, t.ready);
            setStatus(`Error (HTTP ${res.status}).`, "bad");
            showDebug(res.raw);
            return;
          }

          const result = res.data.result;
          renderResult(result);

          const ts = Date.now();
          const max = Number(result.max_points || 0);
          const total = Number(result.total_points || 0);
          const percent = max > 0 ? Math.round((total / max) * 100) : 0;

          const attempt = {
            ts,
            course: (courseEl()?.value || "").trim(),
            level: levelEl()?.value || "C",
            qType: qTypeEl()?.value || "mix",
            numQuestions: Number(numQuestionsEl()?.value || 12),
            total_points: total,
            max_points: max,
            percent
          };

          const history = lsGetArray(LS_HISTORY);
          history.push(attempt);
          while(history.length > 60) history.shift();
          lsSet(LS_HISTORY, history);

          lsSet(LS_LAST, {
            ts,
            attempt,
            exam: {
              title: currentExam.title || "",
              level: currentExam.level || (levelEl()?.value || "C"),
              questions: currentExam.questions || []
            },
            result
          });

          const mistakes = lsGetArray(LS_MISTAKES);
          const qById = new Map((currentExam.questions || []).map(q => [String(q.id), q]));
          const aById = new Map(answers.map(a => [String(a.id), a.answer]));

          (result.per_question || []).forEach(item => {
            const got = Number(item.points || 0);
            const m = Number(item.max_points || 0);
            if(m > 0 && got < m){
              const q = qById.get(String(item.id)) || {};
              mistakes.push({
                ts,
                course: attempt.course,
                level: attempt.level,
                qType: q.type || (qTypeEl()?.value || "mix"),
                id: String(item.id),
                question: String(q.question || ""),
                user_answer: String(aById.get(String(item.id)) || ""),
                feedback: String(item.feedback || ""),
                model_answer: String(item.model_answer || ""),
                points: got,
                max_points: m
              });
            }
          });

          while(mistakes.length > 200) mistakes.shift();
          lsSet(LS_MISTAKES, mistakes);

          try{ localStorage.setItem(LS_MATERIAL, pastedText); } catch {}

          setBusy(false, t.ready);
          setStatus(t.gradeDone, "ok");
          document.querySelector("#result")?.scrollIntoView({behavior:"smooth"});
        });

        // CLEAR
        onClick("clearBtn", clearAll);

        // LOCK STARTUP
        if(db){
          try{
            const { data } = await db.auth.getSession();
            if(data?.session){
              const ok = await checkApprovalAndUnlock(data.session);
              if(ok) return;
              showLock();
              return;
            }
          }catch(e){
            setLockError(String(e?.message || e));
          }
        }

        if(isUnlocked()) hideLock();
        else showLock();

      }catch(err){
        reportErr(err);
      }
    });
  </script>
</body>
</html>
