<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ProviaAi – App</title>

  <style>
    :root{
      --deep:#052A1E; --deep2:#041E16;
      --mint:#2BE38C; --mint2:#16B876;
      --bg:#F6FBF8; --muted:#556072; --border:rgba(5,42,30,.14);
      --shadow:0 18px 55px rgba(5,42,30,.14);
      --radius:18px; --font:system-ui,-apple-system,Segoe UI,Roboto,Arial; --max:1080px;
      --danger:#8b1d1d; --ok:#0f7a5a; --warn:#946200;
    }
    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    :target{scroll-margin-top:92px}
    body{
      margin:0;font-family:var(--font);
      background:
        radial-gradient(900px 450px at 20% -10%, rgba(43,227,140,.18), transparent 60%),
        radial-gradient(700px 380px at 95% 20%, rgba(43,227,140,.10), transparent 55%),
        var(--bg);
      color:#071812;
    }
    a{text-decoration:none;color:inherit}

    header{
      background:rgba(255,255,255,.88);backdrop-filter:saturate(140%) blur(10px);
      border-bottom:1px solid var(--border);
      position:sticky;top:0;z-index:3000;
    }
    .wrap{max-width:var(--max);margin:0 auto;padding:clamp(14px,3vw,22px)}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:12px;min-width:0}
    .brand img{height:54px;width:auto;display:block}
    .brand .name{font-weight:1100;color:var(--deep);font-size:18px;line-height:1.05}
    .brand .tag{margin-top:3px;color:var(--muted);font-weight:850;font-size:12px;line-height:1.1}

    .btn{
      display:inline-flex;align-items:center;justify-content:center;
      padding:12px 16px;border-radius:14px;
      font-weight:1000;font-size:14px;border:1px solid var(--border);
      cursor:pointer;white-space:nowrap;
      background:rgba(255,255,255,.92);color:var(--deep);
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .btnPrimary{
      background:var(--mint2);color:#fff;border-color:rgba(22,184,118,.28);
      box-shadow:0 14px 28px rgba(22,184,118,.22)
    }

    .card{
      background:rgba(255,255,255,.92);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:clamp(16px,3vw,22px);
      margin:14px 0;
      overflow:hidden;
      position:relative;
    }
    .card:before{
      content:"";
      position:absolute;inset:-70px -70px auto auto;
      width:190px;height:190px;border-radius:999px;
      background:radial-gradient(circle at 30% 30%, rgba(43,227,140,.16), transparent 60%);
      pointer-events:none;
    }
    .sectionTitle{
      margin:0 0 6px;font-weight:1100;letter-spacing:-.01em;color:var(--deep);
      font-size:16px;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;
    }
    .sectionSub{margin:0;color:var(--muted);font-weight:780;font-size:12px;line-height:1.35}

    label{display:block;margin:12px 0 6px;font-weight:1000;color:var(--deep);font-size:13px}
    select,input,textarea{
      width:100%;padding:12px;border-radius:14px;border:1px solid var(--border);background:#fff;
      font-family:inherit;font-size:14px;outline:none;
    }
    textarea{min-height:170px;resize:vertical}
    input:focus, textarea:focus, select:focus{border-color:rgba(43,227,140,.55);box-shadow:0 0 0 5px rgba(43,227,140,.14)}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:920px){ .grid2{grid-template-columns:1fr} }

    .status{margin-top:10px;color:var(--muted);font-weight:850;font-size:12px;line-height:1.35;word-break:break-word}
    .status.ok{color:var(--ok)} .status.bad{color:var(--danger)} .status.warn{color:var(--warn)}

    details{margin-top:10px}
    summary{cursor:pointer;font-weight:1000;color:var(--deep);font-size:13px}
    pre{
      margin:10px 0 0;padding:12px;border-radius:14px;border:1px solid var(--border);
      background:#fff;overflow:auto;font-size:12px;line-height:1.35;white-space:pre-wrap;word-break:break-word;
    }

    .spinner{width:16px;height:16px;border-radius:999px;border:2px solid rgba(5,42,30,.18);border-top-color:rgba(22,184,118,.95);animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .qBox{margin-top:12px;padding:12px;border:1px solid rgba(5,42,30,.12);border-radius:16px;background:#fff}
    .qMeta{color:var(--muted);font-weight:900;font-size:12px;margin-bottom:6px}
    .qText{font-weight:900;color:#071812;line-height:1.45}

    footer{border-top:1px solid var(--border);padding:18px;text-align:center;color:var(--muted);font-size:12px;font-weight:750}

    /* menu */
    .menuWrap{position:relative;z-index:4000}
    .iconBtn{
      width:44px;height:44px;border-radius:14px;border:1px solid var(--border);
      background:rgba(255,255,255,.92);cursor:pointer;display:grid;place-items:center;
    }
    .bars{width:18px;height:12px;display:grid;gap:3px}
    .bars span{display:block;height:2px;background:var(--deep);border-radius:2px;opacity:.9}
    .dropdown{
      position:absolute;right:0;top:54px;min-width:270px;
      background:rgba(255,255,255,.98);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:0 22px 60px rgba(5,42,30,.18);
      padding:8px;
      display:none;
      z-index:5000;
    }
    .dropdown a, .dropdown button{
      width:100%;
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid transparent;
      background:transparent;
      cursor:pointer;
      font-weight:950;
      color:var(--deep);
      font-size:13px;
      text-align:left;
    }
    .dropdown a:hover, .dropdown button:hover{background:rgba(43,227,140,.10);border-color:rgba(43,227,140,.18)}
    .pill{
      font-size:11px;font-weight:1000;color:var(--muted);
      border:1px solid var(--border);
      border-radius:999px;padding:4px 8px;background:#fff;
    }

    /* lock */
    .loginOverlay{
      position:fixed;inset:0;z-index:9999;
      background:
        radial-gradient(800px 420px at 20% 10%, rgba(43,227,140,.22), transparent 60%),
        radial-gradient(700px 380px at 90% 20%, rgba(43,227,140,.10), transparent 55%),
        linear-gradient(135deg, rgba(5,42,30,.98), rgba(4,30,22,.92));
      display:flex;align-items:center;justify-content:center;padding:18px;
    }
    .loginCard{
      width:min(640px, 100%);
      background:rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.22);
      border-radius:22px;
      box-shadow:0 24px 70px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .loginTop{display:flex;gap:14px;align-items:center;padding:18px 18px 10px}
    .loginTop img{height:68px;width:auto;display:block}
    .loginTop .ltTitle{font-weight:1100;color:var(--deep);font-size:20px;line-height:1.1}
    .loginTop .ltSub{margin-top:4px;color:var(--muted);font-weight:800;font-size:12px}
    .loginBody{padding:12px 18px 18px}
    .loginRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .err{margin-top:10px;color:var(--danger);font-weight:900;font-size:12px}

    /* upload */
    .uploadBox{
      border:1px dashed rgba(5,42,30,.22);
      border-radius:16px;
      padding:12px;
      background:rgba(255,255,255,.7);
    }
    .uploadTop{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .smallHint{color:var(--muted);font-weight:850;font-size:12px;line-height:1.35;margin-top:6px}
    .fileRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .fileRow input[type="file"]{max-width:320px}

    /* MC clickable */
    .mcGroup{display:grid;gap:8px;margin-top:10px}
    .mcOpt{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(5,42,30,.14);
      background:#fff; cursor:pointer;
      font-weight:900; line-height:1.35;
      text-align:left;
    }
    .mcOpt:hover{border-color:rgba(43,227,140,.35)}
    .mcOpt.sel{
      border-color:rgba(43,227,140,.60);
      box-shadow:0 0 0 5px rgba(43,227,140,.12);
    }
    .mcLetter{
      width:28px;height:28px;border-radius:10px;
      display:grid;place-items:center;
      background:rgba(5,42,30,.06);
      font-weight:1100;color:var(--deep);
      flex:0 0 28px;
    }
    .mcText{font-weight:850;color:#071812}
  </style>
</head>

<body>

  <!-- LOCK SCREEN -->
  <div id="loginScreen" class="loginOverlay" aria-hidden="false">
    <div class="loginCard" role="dialog" aria-modal="true" aria-label="Åtkomstkod">
      <div class="loginTop">
        <img src="image/proviaai-logo.png" alt="ProviaAi logga">
        <div>
          <div class="ltTitle" id="lockTitle">ProviaAi</div>
          <div class="ltSub" id="lockSub">Åtkomst krävs för att använda appen</div>
        </div>
      </div>
      <div class="loginBody">
        <label for="accessCode" id="lockLabel">Åtkomstkod</label>
        <input id="accessCode" type="password" placeholder="Skriv koden…" autocomplete="off" />
        <div class="loginRow">
          <button class="btn btnPrimary" type="button" id="unlockBtn" onclick="window.__unlock()">Lås upp</button>
          <a class="btn" href="index.html" id="toInfoBtn">Till infosidan</a>
          <a class="btn" href="förbättring.html" id="toImproveBtn">Förbättring</a>
        </div>
        <div id="errorMsg" class="err" aria-live="polite"></div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <header>
    <div class="wrap topbar">
      <a class="brand" href="index.html">
        <img src="image/proviaai-logo.png" alt="ProviaAi logga">
        <div>
          <div class="name" id="brandName">ProviaAi</div>
          <div class="tag" id="brandTag">Mockprov • Rättning • Modellsvar</div>
        </div>
      </a>

      <div class="menuWrap">
        <button class="iconBtn" id="menuBtn" type="button" aria-label="Meny" onclick="window.__toggleMenu(event)">
          <div class="bars" aria-hidden="true"><span></span><span></span><span></span></div>
        </button>

        <div class="dropdown" id="menu" aria-label="Menyval">
          <a href="#material" data-scroll="#material"><span id="m1">1) Material</span><span class="pill">Text/OCR</span></a>
          <a href="#settings" data-scroll="#settings"><span id="m2">2) Inställningar</span><span class="pill">Nivå</span></a>
          <a href="#exam" data-scroll="#exam"><span id="m3">3) Mockprov</span><span class="pill">Frågor</span></a>
          <a href="#result" data-scroll="#result"><span id="m4">4) Rättning</span><span class="pill">Modellsvar</span></a>

          <a href="förbättring.html"><span id="mImprove">Förbättring</span><span class="pill">Coach</span></a>

          <button type="button" id="langBtn" onclick="window.__toggleLang()"><span id="mLang">English</span><span class="pill" id="langPill">SV</span></button>
          <button type="button" id="logoutTopBtn" onclick="window.__logout()"><span id="mLogout">Logga ut</span><span class="pill">Lås</span></button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap" id="appRoot">

    <section class="card" id="material">
      <div class="sectionTitle"><span id="tStep1">Steg 1 – Material</span></div>
      <p class="sectionSub" id="tStep1Sub">Klistra in text. Valfritt: välj en bild eller ta foto → OCR lägger in text i materialet.</p>

      <label for="pastedText" id="tPasteLabel">Material (klistra in text)</label>
      <textarea id="pastedText" placeholder="Rubriker → punktlista → definitioner/formler → exempel"></textarea>

      <div class="uploadBox" style="margin-top:12px">
        <div class="uploadTop">
          <div style="font-weight:1000;color:var(--deep);font-size:13px" id="tOcrTitle">Bild → OCR (valfritt)</div>
          <div class="fileRow">
            <input id="imageInput" type="file" accept="image/*" capture="environment" />
            <button class="btn" id="ocrBtn" type="button" onclick="window.__doOcr()">OCR till material</button>
          </div>
        </div>
        <div class="smallHint" id="tOcrHint">Tips: tydlig bild rakt ovanifrån, bra ljus, hög kontrast.</div>
        <div class="status" id="ocrStatus"></div>
      </div>

      <div class="status warn" id="formatHint" style="margin-top:12px">
        Tips: rubriker + punktlistor ger mer exakta frågor och bättre rättning.
      </div>
    </section>

    <section class="card" id="settings">
      <div class="sectionTitle">
        <span id="tStep2">Steg 2 – Inställningar</span>
        <a class="btn" href="förbättring.html" id="improveBtnInline">Förbättring</a>
      </div>
      <p class="sectionSub" id="tStep2Sub">Välj betygsnivå (E/C/A), frågetyp och exakt antal frågor.</p>

      <div class="grid2">
        <div>
          <label for="level" id="tLevel">Nivå (E/C/A)</label>
          <select id="level">
            <option value="E">E</option>
            <option value="C" selected>C</option>
            <option value="A">A</option>
          </select>
        </div>
        <div>
          <label for="course" id="tCourse">Ämne/kurs (valfritt)</label>
          <input id="course" placeholder="Ex: Matematik 2b / Historia 1b" />
        </div>
      </div>

      <div class="grid2" style="margin-top:12px">
        <div>
          <label for="qType" id="tQType">Frågetyp</label>
          <select id="qType">
            <option value="mix" selected id="qtMix">Blandat</option>
            <option value="mc" id="qtMc">Flervalsfrågor</option>
            <option value="short" id="qtShort">Kortsvar</option>
            <option value="essay" id="qtEssay">Essä</option>
          </select>
        </div>
        <div>
          <label for="numQuestions" id="tNum">Antal frågor (exakt)</label>
          <select id="numQuestions">
            <option>3</option><option>4</option><option>5</option><option>6</option><option>7</option><option>8</option>
            <option>9</option><option>10</option><option>11</option><option selected>12</option>
          </select>
        </div>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;align-items:center">
        <button class="btn btnPrimary" id="generateExamBtn" type="button" onclick="window.__generate()">Skapa mockprov</button>
        <button class="btn" id="gradeBtn" type="button" disabled onclick="window.__grade()">Rätta prov</button>
        <button class="btn" id="clearBtn" type="button" onclick="window.__clearAll()">Rensa</button>

        <span style="display:flex;gap:10px;align-items:center">
          <span id="spinWrap" style="display:none"><span class="spinner" aria-hidden="true"></span></span>
          <span class="sectionSub" id="miniState">Redo.</span>
        </span>
      </div>

      <div class="status" id="status"></div>

      <details id="debugWrap" style="display:none">
        <summary id="debugTitle">Debug</summary>
        <pre id="debug"></pre>
      </details>
    </section>

    <section class="card" id="exam">
      <div class="sectionTitle"><span id="tStep3">Steg 3 – Mockprov</span></div>
      <div class="status" id="examMeta">Ingen provdata ännu.</div>
      <div id="examBody"></div>
    </section>

    <section class="card" id="result">
      <div class="sectionTitle"><span id="tStep4">Steg 4 – Rättning</span></div>
      <div class="status" id="resultMeta">Ingen rättning ännu.</div>
      <div id="resultBody"></div>
    </section>

  </main>

  <footer id="footerText">ProviaAi är studiestöd och ger ingen officiell betygssättning.</footer>

  <script>
    // ===== LOGIN CONFIG =====
    const ACCESS_CODE = "provia123";
    const ACCESS_FLAG_KEY = "proviaai_app_access";

    // ===== STORAGE KEYS (för förbättringssidan) =====
    const LS_HISTORY = "proviaai_history";        // array
    const LS_MISTAKES = "proviaai_mistakes";      // array
    const LS_LAST = "proviaai_last_result";       // object
    const LS_MATERIAL = "proviaai_last_material"; // string

    const $ = (id) => document.getElementById(id);

    function safeJsonParse(s, fallback){
      try{ return JSON.parse(s); } catch { return fallback; }
    }
    function lsGetArray(key){
      const v = localStorage.getItem(key);
      const arr = safeJsonParse(v, []);
      return Array.isArray(arr) ? arr : [];
    }
    function lsSet(key, val){
      try{ localStorage.setItem(key, JSON.stringify(val)); } catch {}
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    async function postJson(path, payload){
      const resp = await fetch(path, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      const raw = await resp.text();
      let data = null;
      try{ data = JSON.parse(raw); } catch {}
      return { ok: resp.ok, status: resp.status, raw, data };
    }

    // ===== I18N =====
    let LANG = localStorage.getItem("proviaai_lang") || "sv";
    const T = {
      sv:{
        brandTag:"Mockprov • Rättning • Modellsvar",
        lockSub:"Åtkomst krävs för att använda appen",
        lockLabel:"Åtkomstkod",
        unlock:"Lås upp",
        toInfo:"Till infosidan",
        toImprove:"Förbättring",
        m1:"1) Material", m2:"2) Inställningar", m3:"3) Mockprov", m4:"4) Rättning",
        mImprove:"Förbättring", mLang:"English", mLogout:"Logga ut",
        step1:"Steg 1 – Material",
        step1Sub:"Klistra in text. Valfritt: välj en bild eller ta foto → OCR lägger in text i materialet.",
        pasteLabel:"Material (klistra in text)",
        pastePH:"Rubriker → punktlista → definitioner/formler → exempel",
        ocrTitle:"Bild → OCR (valfritt)",
        ocrBtn:"OCR till material",
        ocrHint:"Tips: tydlig bild rakt ovanifrån, bra ljus, hög kontrast.",
        tip:"Tips: rubriker + punktlistor ger mer exakta frågor och bättre rättning.",
        step2:"Steg 2 – Inställningar",
        step2Sub:"Välj betygsnivå (E/C/A), frågetyp och exakt antal frågor.",
        level:"Nivå (E/C/A)",
        course:"Ämne/kurs (valfritt)",
        coursePH:"Ex: Matematik 2b / Historia 1b",
        qType:"Frågetyp",
        qtMix:"Blandat", qtMc:"Flervalsfrågor", qtShort:"Kortsvar", qtEssay:"Essä",
        num:"Antal frågor (exakt)",
        gen:"Skapa mockprov", grade:"Rätta prov", clear:"Rensa",
        ready:"Redo.",
        debug:"Debug",
        step3:"Steg 3 – Mockprov",
        step4:"Steg 4 – Rättning",
        noExam:"Ingen provdata ännu.",
        noGrade:"Ingen rättning ännu.",
        needMat:"Klistra in material först.",
        genWorking:"Skapar mockprov…",
        gradeWorking:"Rättar prov…",
        genDone:"Mockprov klart.",
        gradeDone:"Rättning klar. Sparad till förbättring.",
        wrongCode:"Fel kod.",
        ocrNoFile:"Välj en bild först.",
        ocrWorking:"OCR pågår…",
        ocrDone:"OCR klart. Texten lades in i materialet.",
        writeAnswer:"Skriv ditt svar här…",
        fullScore:"Vad som ger full poäng (modellsvar)",
        genFirst:"Skapa mockprov först.",
        cleared:"Allt rensat. Börja om.",
        footer:"ProviaAi är studiestöd och ger ingen officiell betygssättning."
      },
      en:{
        brandTag:"Mock exams • Grading • Model answers",
        lockSub:"Access is required to use the app",
        lockLabel:"Access code",
        unlock:"Unlock",
        toInfo:"Go to info page",
        toImprove:"Improve",
        m1:"1) Material", m2:"2) Settings", m3:"3) Mock exam", m4:"4) Grading",
        mImprove:"Improve", mLang:"Svenska", mLogout:"Log out",
        step1:"Step 1 – Material",
        step1Sub:"Paste text. Optional: choose an image or take a photo → OCR adds text into your material.",
        pasteLabel:"Material (paste text)",
        pastePH:"Headings → bullet points → definitions/formulas → examples",
        ocrTitle:"Image → OCR (optional)",
        ocrBtn:"OCR into material",
        ocrHint:"Tip: sharp photo from above, good light, high contrast.",
        tip:"Tip: headings + bullet points produce more accurate questions and grading.",
        step2:"Step 2 – Settings",
        step2Sub:"Choose level (E/C/A), question type and an exact number of questions.",
        level:"Level (E/C/A)",
        course:"Subject/course (optional)",
        coursePH:"e.g., Math / History",
        qType:"Question type",
        qtMix:"Mixed", qtMc:"Multiple choice", qtShort:"Short answer", qtEssay:"Essay",
        num:"Number of questions (exact)",
        gen:"Generate mock exam", grade:"Grade exam", clear:"Clear",
        ready:"Ready.",
        debug:"Debug",
        step3:"Step 3 – Mock exam",
        step4:"Step 4 – Grading",
        noExam:"No exam data yet.",
        noGrade:"No grading yet.",
        needMat:"Paste material first.",
        genWorking:"Generating mock exam…",
        gradeWorking:"Grading…",
        genDone:"Mock exam ready.",
        gradeDone:"Grading done. Saved to Improve page.",
        wrongCode:"Wrong code.",
        ocrNoFile:"Choose an image first.",
        ocrWorking:"Running OCR…",
        ocrDone:"OCR done. Text was added to the material.",
        writeAnswer:"Write your answer here…",
        fullScore:"Full-score model answer",
        genFirst:"Generate an exam first.",
        cleared:"Cleared. Start again.",
        footer:"ProviaAi is study support and does not provide official grades."
      }
    };

    // ===== MENU =====
    function openMenu(){ $("menu").style.display = "block"; }
    function closeMenu(){ $("menu").style.display = "none"; }
    function toggleMenu(){
      const m = $("menu");
      m.style.display = (m.style.display === "block") ? "none" : "block";
    }

    // ===== LOCK / UNLOCK =====
    function isUnlocked(){ return localStorage.getItem(ACCESS_FLAG_KEY) === "true"; }
    function showLock(){
      const s = $("loginScreen");
      s.style.display = "flex";
      s.setAttribute("aria-hidden","false");
      document.documentElement.style.overflow = "hidden";
      document.body.style.overflow = "hidden";
    }
    function hideLock(){
      const s = $("loginScreen");
      s.style.display = "none";
      s.setAttribute("aria-hidden","true");
      document.documentElement.style.overflow = "";
      document.body.style.overflow = "";
    }
    function unlock(){
      const input = $("accessCode");
      const msg = $("errorMsg");
      const v = (input.value || "").trim();
      if(v === ACCESS_CODE){
        localStorage.setItem(ACCESS_FLAG_KEY, "true");
        msg.textContent = "";
        hideLock();
      } else {
        msg.textContent = T[LANG].wrongCode;
      }
    }
    function logout(){
      localStorage.removeItem(ACCESS_FLAG_KEY);
      closeMenu();
      showLock();
    }

    // ===== APP STATE ELEMENTS =====
    const spinWrap = $("spinWrap");
    const miniStateEl = $("miniState");
    const statusEl = $("status");
    const debugWrap = $("debugWrap");
    const debugEl = $("debug");

    const pastedTextEl = $("pastedText");
    const levelEl = $("level");
    const courseEl = $("course");
    const qTypeEl = $("qType");
    const numQuestionsEl = $("numQuestions");

    const generateExamBtn = $("generateExamBtn");
    const gradeBtn = $("gradeBtn");
    const clearBtn = $("clearBtn");

    const examMetaEl = $("examMeta");
    const examBodyEl = $("examBody");
    const resultMetaEl = $("resultMeta");
    const resultBodyEl = $("resultBody");

    const imageInput = $("imageInput");
    const ocrBtn = $("ocrBtn");
    const ocrStatus = $("ocrStatus");

    let currentExam = null;

    function applyLang(){
      const t = T[LANG];
      $("brandTag").textContent = t.brandTag;
      $("lockSub").textContent = t.lockSub;
      $("lockLabel").textContent = t.lockLabel;
      $("unlockBtn").textContent = t.unlock;
      $("toInfoBtn").textContent = t.toInfo;
      $("toImproveBtn").textContent = t.toImprove;

      $("m1").textContent = t.m1;
      $("m2").textContent = t.m2;
      $("m3").textContent = t.m3;
      $("m4").textContent = t.m4;
      $("mImprove").textContent = t.mImprove;
      $("mLang").textContent = t.mLang;
      $("mLogout").textContent = t.mLogout;
      $("langPill").textContent = LANG.toUpperCase();

      $("tStep1").textContent = t.step1;
      $("tStep1Sub").textContent = t.step1Sub;
      $("tPasteLabel").textContent = t.pasteLabel;
      $("pastedText").placeholder = t.pastePH;
      $("tOcrTitle").textContent = t.ocrTitle;
      $("ocrBtn").textContent = t.ocrBtn;
      $("tOcrHint").textContent = t.ocrHint;
      $("formatHint").textContent = t.tip;

      $("tStep2").textContent = t.step2;
      $("tStep2Sub").textContent = t.step2Sub;
      $("tLevel").textContent = t.level;
      $("tCourse").textContent = t.course;
      $("course").placeholder = t.coursePH;
      $("tQType").textContent = t.qType;
      $("qtMix").textContent = t.qtMix;
      $("qtMc").textContent = t.qtMc;
      $("qtShort").textContent = t.qtShort;
      $("qtEssay").textContent = t.qtEssay;
      $("tNum").textContent = t.num;
      $("generateExamBtn").textContent = t.gen;
      $("gradeBtn").textContent = t.grade;
      $("clearBtn").textContent = t.clear;
      $("improveBtnInline").textContent = t.mImprove;

      $("miniState").textContent = t.ready;
      $("debugTitle").textContent = t.debug;
      $("tStep3").textContent = t.step3;
      $("tStep4").textContent = t.step4;
      $("footerText").textContent = t.footer;

      if(!examBodyEl.children.length) examMetaEl.textContent = t.noExam;
      if(!resultBodyEl.children.length) resultMetaEl.textContent = t.noGrade;
    }

    function setBusy(isBusy, label){
      spinWrap.style.display = isBusy ? "inline-flex" : "none";
      miniStateEl.textContent = label || (isBusy ? "…" : T[LANG].ready);
      generateExamBtn.disabled = isBusy;
      gradeBtn.disabled = isBusy || !currentExam;
      clearBtn.disabled = isBusy;
      ocrBtn.disabled = isBusy;
    }
    function setStatus(txt, kind){
      statusEl.className = "status" + (kind ? (" " + kind) : "");
      statusEl.textContent = txt || "";
    }
    function setOcrStatus(txt, kind){
      ocrStatus.className = "status" + (kind ? (" " + kind) : "");
      ocrStatus.textContent = txt || "";
    }
    function showDebug(txt){
      debugWrap.style.display = "block";
      debugEl.textContent = txt || "";
    }
    function hideDebug(){
      debugWrap.style.display = "none";
      debugEl.textContent = "";
    }

    async function fileToDataUrl(file){
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => resolve(String(fr.result || ""));
        fr.onerror = () => reject(new Error("FileReader error"));
        fr.readAsDataURL(file);
      });
    }

    function renderExam(exam){
      currentExam = exam;
      const qs = Array.isArray(exam.questions) ? exam.questions : [];
      const t = T[LANG];

      examMetaEl.textContent =
        `${exam.title || (LANG==="sv"?"Mockprov":"Mock exam")} • ${LANG==="sv"?"Nivå":"Level"}: ${exam.level || "—"} • ${qs.length} ${LANG==="sv"?"frågor":"questions"}`;
      examBodyEl.innerHTML = "";
      resultMetaEl.textContent = t.noGrade;
      resultBodyEl.innerHTML = "";

      qs.forEach((q, idx) => {
        const box = document.createElement("div");
        box.className = "qBox";
        const qid = String(q.id ?? (idx+1));

        const meta = document.createElement("div");
        meta.className = "qMeta";
        meta.textContent = `ID: ${qid} • ${LANG==="sv"?"Poäng":"Points"}: ${q.points ?? "—"} • ${LANG==="sv"?"Typ":"Type"}: ${q.type ?? qTypeEl.value}`;

        const text = document.createElement("div");
        text.className = "qText";
        text.textContent = q.question ?? "";

        box.appendChild(meta);
        box.appendChild(text);

        if((q.type === "mc") && Array.isArray(q.options) && q.options.length){
          const group = document.createElement("div");
          group.className = "mcGroup";
          group.dataset.qid = qid;

          const hidden = document.createElement("input");
          hidden.type = "hidden";
          hidden.className = "mcAnswer";
          hidden.dataset.qid = qid;
          hidden.value = "";
          box.appendChild(hidden);

          q.options.forEach((opt, i) => {
            const letter = String.fromCharCode(65 + i);
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "mcOpt";
            btn.dataset.letter = letter;
            btn.dataset.qid = qid;
            btn.innerHTML = `<span class="mcLetter">${letter}</span><span class="mcText">${escapeHtml(opt)}</span>`;
            btn.addEventListener("click", () => {
              group.querySelectorAll(".mcOpt").forEach(x => x.classList.remove("sel"));
              btn.classList.add("sel");
              hidden.value = letter;
            });
            group.appendChild(btn);
          });

          box.appendChild(group);
          examBodyEl.appendChild(box);
          return;
        }

        const ans = document.createElement("textarea");
        ans.className = "answer";
        ans.placeholder = t.writeAnswer;
        ans.dataset.qid = qid;
        ans.style.marginTop = "10px";
        ans.style.minHeight = (q.type === "essay") ? "150px" : "110px";
        box.appendChild(ans);
        examBodyEl.appendChild(box);
      });

      gradeBtn.disabled = qs.length === 0;
    }

    function renderResult(r){
      const t = T[LANG];
      resultMetaEl.textContent = `${LANG==="sv"?"Rättning":"Grading"}: ${r.total_points}/${r.max_points}`;
      const wrap = document.createElement("div");

      (r.per_question || []).forEach(item => {
        const d = document.createElement("div");
        d.className = "qBox";
        const model = String(item.model_answer || "").trim();
        d.innerHTML = `
          <div class="qMeta">ID: ${escapeHtml(item.id)} • ${item.points}/${item.max_points}</div>
          <div style="font-weight:850;line-height:1.45">${escapeHtml(item.feedback || "")}</div>
          <div style="margin-top:10px;border-top:1px solid rgba(5,42,30,.12);padding-top:10px">
            <div style="font-weight:1100;color:#052A1E;margin-bottom:6px;font-size:13px">${t.fullScore}</div>
            <div style="white-space:pre-wrap;font-weight:800;line-height:1.45">${escapeHtml(model)}</div>
          </div>
        `;
        wrap.appendChild(d);
      });

      resultBodyEl.innerHTML = "";
      resultBodyEl.appendChild(wrap);
    }

    function clearAll(){
      const t = T[LANG];
      pastedTextEl.value = "";
      courseEl.value = "";
      levelEl.value = "C";
      qTypeEl.value = "mix";
      numQuestionsEl.value = "12";
      imageInput.value = "";
      setOcrStatus("");
      currentExam = null;
      examMetaEl.textContent = t.noExam;
      examBodyEl.innerHTML = "";
      resultMetaEl.textContent = t.noGrade;
      resultBodyEl.innerHTML = "";
      gradeBtn.disabled = true;
      setStatus(t.cleared, "ok");
      hideDebug();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    // ===== OCR =====
    async function doOcr(){
      hideDebug();
      const t = T[LANG];
      const file = imageInput.files && imageInput.files[0];
      if(!file){ setOcrStatus(t.ocrNoFile, "bad"); return; }

      setBusy(true, t.ocrWorking);
      setOcrStatus(t.ocrWorking, "warn");

      try{
        const dataUrl = await fileToDataUrl(file);
        const res = await postJson("/api/ocr", { imageDataUrl: dataUrl, lang: LANG });

        if(!res.ok || !res.data || !res.data.ok){
          setBusy(false, t.ready);
          setOcrStatus(`OCR error (HTTP ${res.status}).`, "bad");
          showDebug(res.raw);
          return;
        }

        const extracted = String(res.data.text || "").trim();
        if(extracted){
          const prefix = (LANG==="sv") ? "\n\n--- OCR (bild) ---\n" : "\n\n--- OCR (image) ---\n";
          const base = pastedTextEl.value.trim();
          pastedTextEl.value = (base ? base + prefix : "") + extracted + "\n";
        }

        setBusy(false, t.ready);
        setOcrStatus(t.ocrDone, "ok");
      }catch(e){
        setBusy(false, t.ready);
        setOcrStatus("OCR error.", "bad");
        showDebug(String(e));
      }
    }

    // ===== GENERATE EXAM =====
    async function generate(){
      hideDebug();
      setStatus("");
      const t = T[LANG];

      const pastedText = pastedTextEl.value.trim();
      if(!pastedText){
        setStatus(t.needMat, "bad");
        document.querySelector("#material").scrollIntoView({behavior:"smooth"});
        return;
      }

      const payload = {
        lang: LANG,
        level: levelEl.value,
        course: courseEl.value.trim(),
        qType: qTypeEl.value,
        pastedText,
        numQuestions: Number(numQuestionsEl.value)
      };

      setBusy(true, t.genWorking);
      setStatus(`${t.genWorking} (${payload.qType}, ${payload.numQuestions})`, "");

      const res = await postJson("/api/generate-exam", payload);
      if(!res.ok || !res.data || !res.data.ok){
        setBusy(false, t.ready);
        setStatus(`Error (HTTP ${res.status}).`, "bad");
        showDebug(res.raw);
        return;
      }

      try{ localStorage.setItem(LS_MATERIAL, pastedText); } catch {}

      renderExam(res.data.exam);
      setBusy(false, t.ready);
      setStatus(t.genDone, "ok");
      document.querySelector("#exam").scrollIntoView({behavior:"smooth"});
    }

    // ===== GRADE EXAM + SAVE =====
    async function grade(){
      hideDebug();
      setStatus("");
      const t = T[LANG];

      if(!currentExam || !Array.isArray(currentExam.questions) || currentExam.questions.length === 0){
        setStatus(t.genFirst, "bad");
        return;
      }

      const answers = [];
      currentExam.questions.forEach((q, idx) => {
        const qid = String(q.id ?? (idx+1));
        if(q.type === "mc"){
          const hidden = document.querySelector(`input.mcAnswer[data-qid="${CSS.escape(qid)}"]`);
          answers.push({ id: qid, answer: (hidden?.value || "").trim() });
        } else {
          const ta = document.querySelector(`textarea.answer[data-qid="${CSS.escape(qid)}"]`);
          answers.push({ id: qid, answer: (ta?.value || "").trim() });
        }
      });

      const pastedText = pastedTextEl.value.trim();
      const payload = {
        lang: LANG,
        pastedText,
        questions: currentExam.questions,
        answers
      };

      setBusy(true, t.gradeWorking);
      setStatus(t.gradeWorking, "");

      const res = await postJson("/api/grade", payload);
      if(!res.ok || !res.data || !res.data.ok){
        setBusy(false, t.ready);
        setStatus(`Error (HTTP ${res.status}).`, "bad");
        showDebug(res.raw);
        return;
      }

      const result = res.data.result;
      renderResult(result);

      const ts = Date.now();
      const max = Number(result.max_points || 0);
      const total = Number(result.total_points || 0);
      const percent = max > 0 ? Math.round((total / max) * 100) : 0;

      const attempt = {
        ts,
        course: (courseEl.value || "").trim(),
        level: levelEl.value,
        qType: qTypeEl.value,
        numQuestions: Number(numQuestionsEl.value),
        total_points: total,
        max_points: max,
        percent
      };

      const history = lsGetArray(LS_HISTORY);
      history.push(attempt);
      while(history.length > 60) history.shift();
      lsSet(LS_HISTORY, history);

      lsSet(LS_LAST, {
        ts,
        attempt,
        exam: {
          title: currentExam.title || "",
          level: currentExam.level || levelEl.value,
          questions: currentExam.questions || []
        },
        result
      });

      const mistakes = lsGetArray(LS_MISTAKES);
      const qById = new Map((currentExam.questions || []).map(q => [String(q.id), q]));
      const aById = new Map(answers.map(a => [String(a.id), a.answer]));

      (result.per_question || []).forEach(item => {
        const got = Number(item.points || 0);
        const m = Number(item.max_points || 0);
        if(m > 0 && got < m){
          const q = qById.get(String(item.id)) || {};
          mistakes.push({
            ts,
            course: attempt.course,
            level: attempt.level,
            qType: q.type || qTypeEl.value,
            id: String(item.id),
            question: String(q.question || ""),
            user_answer: String(aById.get(String(item.id)) || ""),
            feedback: String(item.feedback || ""),
            model_answer: String(item.model_answer || ""),
            points: got,
            max_points: m
          });
        }
      });

      while(mistakes.length > 200) mistakes.shift();
      lsSet(LS_MISTAKES, mistakes);

      try{ localStorage.setItem(LS_MATERIAL, pastedText); } catch {}

      setBusy(false, t.ready);
      setStatus(t.gradeDone, "ok");
      document.querySelector("#result").scrollIntoView({behavior:"smooth"});
    }

    // ===== MENU WIRING =====
    function toggleLang(){
      LANG = (LANG === "sv") ? "en" : "sv";
      localStorage.setItem("proviaai_lang", LANG);
      applyLang();
      closeMenu();
    }
    function onMenuAnchorClick(e){
      const a = e.target.closest("a[data-scroll]");
      if(!a) return;
      e.preventDefault();
      const sel = a.getAttribute("data-scroll");
      closeMenu();
      const el = document.querySelector(sel);
      if(el) el.scrollIntoView({behavior:"smooth", block:"start"});
    }

    // ===== EXPOSE FAILSAFE GLOBALS (for inline onclick) =====
    window.__unlock = unlock;
    window.__logout = logout;
    window.__toggleMenu = function(ev){
      if(ev){ ev.preventDefault(); ev.stopPropagation(); }
      toggleMenu();
    };
    window.__toggleLang = toggleLang;
    window.__doOcr = doOcr;
    window.__generate = generate;
    window.__grade = grade;
    window.__clearAll = clearAll;

    // ===== INIT (runs immediately; no dependency on DOMContentLoaded) =====
    (function init(){
      // Menu outside click
      document.addEventListener("click", (e) => {
        const m = $("menu");
        if(!m || m.style.display !== "block") return;
        if(m.contains(e.target) || $("menuBtn").contains(e.target)) return;
        closeMenu();
      });
      document.addEventListener("keydown", (e) => {
        if(e.key === "Escape") closeMenu();
      });
      $("menu").addEventListener("click", onMenuAnchorClick);

      // Lock Enter
      document.addEventListener("keydown", (e) => {
        const s = $("loginScreen");
        const visible = s && s.style.display !== "none";
        if(visible && e.key === "Enter") unlock();
      });

      applyLang();
      setBusy(false, T[LANG].ready);
      setStatus("");

      if(isUnlocked()) hideLock(); else showLock();
    })();
  </script>
</body>
</html>
